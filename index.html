<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mboa Skills</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
      
    /* === GLOBAL STYLES ================================= */
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background-image:url('https://ucarecdn.com/ff597083-3c69-4040-8b93-1cb2c38ac703/-/preview/1000x999/');
    }
    header{
      position:fixed;top:0;left:0;right:0;
      display:flex;justify-content:space-around;align-items:center;
      padding:1rem;background:#fff;border-bottom:1px solid #ddd;z-index:99999
    }
    header i{font-size:1.4rem;color:#888;cursor:pointer}
    header i.selected{color:#FFA500}
    .tabcontent{display:none;padding:6rem 1rem 1rem;max-width:600px;margin:auto}
    .tabcontent.active{display:block}
    input,textarea,button,select{
      display:block;width:100%;padding:10px;margin-bottom:10px;
      border:1px solid #ccc;border-radius:6px;font-size:14px;box-sizing:border-box
    }
    button{background:#FFA500;color:#fff;font-weight:bold;border:none;border-radius:6px;cursor:pointer}
    button:hover{background:#145ec1}

    /* === POST CARD ===================================== */
.post {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
  padding: 1rem;
  margin-bottom: 1rem;
}

.post-header {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.post-header img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
}

.post-header a.username {
  display: flex;
  align-items: center;
  font-weight: bold;
  color: #FFA500;
  text-decoration: none;
}

.verified-badge {
  display: inline-block;
  position: relative;
  width: 16px;
  height: 16px;
  margin-left: 6px;
}

.verified-badge .fa-certificate {
  color: #1877F2;
  font-size: 16px;
}

.verified-badge .checkmark {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 9px;
  color: white;
  pointer-events: none;
}

.post-content {
  margin-top: 10px;
}

.post video,
.post .text-bg {
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
}

.text-bg {
  display: inline-block;
  padding: 0.5rem 1rem;
  font-weight: bold;
  color: #fff;
  text-align: center;
  white-space: pre-wrap;
  max-width: 90%;
}

.post-actions {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.post-actions i {
  cursor: pointer;
  font-size: 1.2rem;
}

.like.liked {
  color: #1877f2;
}
.like {
  cursor: pointer;
  font-size: 1.2rem;
  transition: color 0.3s ease;
}

.fa-heart.liked {
  color: #1877f2 !important; /* ğŸ’™ bleu Facebook */
}
.boost-btn {
  background: #FFA500;
  color: #fff;
  padding: 5px 10px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
    /* === COMMENTS ===================================== */
    .comments-section{margin-top:30px;border-top:1px solid #ccc;padding-top:10px;max-height:250px;overflow-y:auto;direction:ltr}
    .comment{direction:ltr;unicode-bidi:plaintext;text-align:left;word-break:break-word}
    .comment strong{color:#1877f2}
    .comment-input{display:flex;gap:14px;margin-top:14px}
    .comment-input input{flex:1;height:30px;padding:12px;border-radius:5px;border:1px solid #ccc;font-size:14px;width:100px;height:60px;}
    .comment-input button{padding:5px 9px;background:#FFA500;color:#fff;border:none;border-radius:8px;cursor:pointer}

    /* === ACCOUNT FORMS ================================= */
    #emailLoginBox,#emailSignupBox{
      background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,.1);margin-bottom:15px
    }
    #emailLoginBox input,#emailSignupBox input{margin-bottom:10px}
    #emailLoginBox button,#emailSignupBox button{background:#1877f2;color:#fff;border:none;padding:10px;font-weight:bold;border-radius:6px;cursor:pointer;width:100%}
    #emailLoginBox button:hover,#emailSignupBox button:hover{background:#145ec1}
    #accountStatus{margin-top:10px;font-weight:bold;color:#1877f2}
    #authStatus{margin-top:10px;font-weight:bold;color:limegreen}

    /* === USER FEED ==================================== */
    #userFeedContent .post{/* inherits .post styles */}
    .follow-btn{
  padding:2px 3px;border:none;border-radius:4px;font-size:12px;
  cursor:pointer;background:#FFA500;color:#fff
}
      .circle {
          width: 4rem;
          aspect-ratio: 1 / 1;
          border-radius: 50%;
      }
.verified-badge {
  display: inline-block;
  position: relative;
  width: 16px;
  height: 16px;
  margin-left: 6px;
  vertical-align: middle;
}

.verified-badge .fa-certificate {
  color: #1877F2;
  font-size: 16px;
}

.verified-badge .checkmark {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 9px;
  color: white;
  pointer-events: none;
} 
.boutons {
  display: flex;
  justify-content: center;
}

.boutons button {
  margin: 8px;
}
        #bouton-lundi {
            display: none; /* Masquer le bouton par dÃ©faut */
        }
        .row-info {
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  font-family: sans-serif;
  font-size: 16px;
  border-bottom: 1px solid #ddd;
}

.label {
  font-weight: bold;
}

.value {
  color: #333;
}
hr {
   background-color: #888;
   height: 0.5%;
   width: 100%;
   border-radius: 15px;
}
  /* Style du modal */
  .modal {
    display: none; /* cachÃ© par dÃ©faut */
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background: white;
    margin: 15% auto;
    padding: 20px;
    width: 300px;
    border-radius: 8px;
    text-align: center;
  }
  .close {
    float: right;
    cursor: pointer;
    font-size: 20px;
  }

  </style>
</head>
<body>
<header>
<i class="fas fa-home tablinks selected" onclick="openTab(event,'home'); window.scrollTo({ top: 0, behavior: 'smooth' });"></i>
  <i class="fas fa-music tablinks"           onclick="openTab(event,'music')"></i>
  <i class="fas fa-image tablinks"           onclick="openTab(event,'videoFeed')"></i>
  <i class="fas fa-plus tablinks"            onclick="openTab(event,'post')"></i>
  <i class="fas fa-search tablinks"          onclick="openTab(event,'search')"></i>
  <i class="fas fa-user tablinks"            onclick="openTab(event,'account')"></i>
</header>

<!-- ============ HOME ============ -->
<section id="home" class="tabcontent active">
  <div class="post-header">
    <img id="homeProfilePhoto" src="https://via.placeholder.com/40" onclick="openTab(event,'feedme')"/>
  <p id="authStatus"></p>
    <p id="accountStatus"></p>
  </div>
  <hr>
    <div class="post-header">
    <img class="circle" src="https://ucarecdn.com/18dbaec6-1d7c-4b73-8624-4cd1741b13c0/-/preview/1000x1000/">   <button onclick="openTab(event,'amis')">Ajouter +<i class="fa-solid fa-user-group"></i></button>
</div>
  <hr>
  <div id="feed"></div>
</section>

<!-- ============ POST ============ -->
<section id="post" class="tabcontent">
  <h3>CrÃ©er une publication texte</h3>
  <textarea id="postText" placeholder="Exprimez-vous..."></textarea>
    <div class="">   
        <label><i class="fas fa-palette" style="color: orange;"></i>   <input type="color" id="bgColor" value="#FFA500"/>
        </label>
        </div>
  <hr/>
  <h2>image</h2>
<input type="file" id="imageFile" accept="image/*" />
<input type="text" id="imageTitle" placeholder="Titre de l'image" />
  <button onclick="publishPost()">Publier</button>
  <p id="status"></p>
</section>

<!-- ============ VIDEO FEED ============ -->
<section id="videoFeed" class="tabcontent">
  <h3>Publications avec images</h3>
  <div id="videoFeedContent"></div>
</section>

<!-- ============ TOTAL VIEWS ============ -->
<section id="totalViewsSection" class="tabcontent" style="background-color:white">
  <h3>Total des vues</h3>
  <label for="periodSelect">PÃ©riode :</label>
<select id="periodSelect">
  <option value="all">Tout</option>
  <option value="week">7 derniers jours</option>
  <option value="month">Dernier mois</option>
  <option value="year">DerniÃ¨re annÃ©e</option>
</select>
<div class="row-info">
  <span class="label">Vues:</span>
  <span class="value"><p id="totalViewsCount" style="background-color:orange">Chargement...</p>
</span>
</div>
<div class="row-info">
  <span class="label">solde:</span>
  <span class="value">  <p id="currentBalance">FCFA</p>
</span>
</div>
<div class="row-info">
  <span class="label">texte+image:</span>
  <span class="value"><i class="fas fa-check-circle" style="color:#1877f2;"></i></span>
</div>
<div class="row-info">
    <span>musique:</span>
    <span><i class="fas fa-check-circle" style="color:#1877f2;"></i></span>
</div>
<div class="row-info">
    <span>soutient:</span>
    <span><p id="gagne" style="font-size:18px;display:inline-block;margin-left:6px;"></p>
</span>
</div>
  <button onclick="openTab(event,'retrait')">retirer</button>
</section>

<!-- ============ SEARCH ============ -->
<section id="search" class="tabcontent">
  <h3>Rechercher un utilisateur</h3>
  <input type="text" id="searchUserInput" placeholder="Nom ou e-mail de l'utilisateur" />
  <button onclick="searchUser()">Rechercher</button>
  <div id="searchResults"></div>
</section>
<section id="retrait" class="tabcontent">
  <label for="withdrawAmount">Montant Ã  retirer :</label><br>
  <input type="number" id="withdrawAmount" placeholder="min: 5000" min="5000" required style="width: 100%; margin-bottom: 10px;"><br>

  <label for="withdrawPhone">NumÃ©ro de tÃ©lÃ©phone :</label><br>
  <input type="tel" id="withdrawPhone" placeholder="Ex: +2376xxxxxxx" required style="width: 100%; margin-bottom: 15px;"><br>

  <button onclick="withdrawBalance()" style="padding: 10px 20px; background-color: green; color: white; border: none; border-radius: 5px;">
    Retirer
  </button>
  <p id="withdrawStatus"></p>
</section>
<!-- ============ ACCOUNT ============ -->
<section id="account" class="tabcontent">
  <div class="post-header">
      <div class="boutons">
    <button onclick="openTab(event,'conect')">Connexion</button>
    <button onclick="openTab(event,'inscrip')">Inscription</button>
    
  <button onclick="signInWithGoogle()"><i class="fab fa-google"></i> Continuer avec Google</button>
  </div>
  </div>
  <hr/>
  <button onclick="signOutUser()" style="background-color:red">Se dÃ©connecter</button>
  <br/><br/>
  <div class="boutons">
<button style="background-color:transparent">
      <u><a href="https://www.facebook.com/profile.php?id=61577616822265">contact support</a> <i class="fab fa-facebook" style="color:#1877f2"></i></u>
  </button>
<button style="background-color:transparent"><u onclick="openTab(event,'condis')" style="background-color:black">CritÃ¨res a connaÃ®tre</u></button>
  </div>
</section>

<!-- ============ FEEDME (MY FEED) ============ -->
<section id="feedme" class="tabcontent">
  <h3>Mes publications</h3>
  <div class="post-header">
    <img id="feedmeProfilePhoto" src="https://via.placeholder.com/40" />
    <p id="accountStatusFeed"></p>
    <label for="profilePhotoInput" title="Changer la photo"><i class="fas fa-plus" style="cursor:pointer"></i></label>
    <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" />
    </div>
      <div class="post-header">
  <input id="profile-link" type="text" readonly style="width:100%;padding:8px" />
  <button id="copy-link-btn"> <i class="fas fa-share"></i></button>
  </div>
  <div class="boutons">
  <button onclick="openTab(event,'vibo')">Deposer</button>    
  <button id="certify-btn" onclick="certifyUser()">Se certifier</button>
  <button onclick="openTab(event,'totalViewsSection')">Retirer</button>
  </div>
  <div id="myFeed"></div>
</section>

<!-- ============ BOOST VIDEO LIST ============ -->
<section id="video" class="tabcontent">
  <div class="post-header">
      
<button onclick="openTab(event,'videoFeed')">Pour toi <i class="fas fa-video tablinks"></i>
 </button>     
  </div>
  <div id="videoFeedContentBoost"></div>
</section>

<!-- ============ BOOST PANEL ============ -->
<section id="vibo" class="tabcontent">
  <h3>Booster une publication</h3>
  <div class="post-header">
  <input type="number" id="montant" placeholder="Montant Ã  dÃ©poser" min="500" style="padding: 6px; width: 150px;">
  <button id="notchpayBtn" style="padding: 6px 12px; background-color: #1877f2; color: white; border: none; border-radius: 4px; cursor: pointer;">
    Deposer
  </button>
</div> 
  <p>Argent: <span id="argent">0</span> XAF</p>

  <div id="boostPanel" style="display:none;margin-bottom:10px">
    <span id="boostStatus" style="font-weight:bold"></span>
    <input type="number" id="boostViews" placeholder="Nombre de vues Ã  acheter" min="1" />
    <button onclick="boostPost()">Booster</button>
  </div>
</section>

<!-- ============ LOGIN FORM ============ -->
<section id="conect" class="tabcontent">
  <h3>Connectez-vous</h3>
  <div id="emailLoginBox">
    <input type="email"    id="loginEmail"    placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Mot de passe" />
   <p>
  <a href="#" onclick="openTab(event,'oublie')">Mot de passe oubliÃ© ?</a>
</p> 
    <button onclick="loginWithEmail()">Se connecter</button>
  </div>
</section>
<section id="oublie" class="tabcontent">
  <h3>RÃ©initialiser le mot de passe</h3>
  
  <input type="email" id="resetEmail" placeholder="Votre email" />
  
  <button onclick="sendResetLink()">Envoyer le lien</button>
</section>
<!-- ============ SIGNUP FORM ============ -->
<section id="inscrip" class="tabcontent">
  <h3>Inscription</h3>
  <div id="emailSignupBox">
   <input type="text"
       id="signupName"
       placeholder="Nom complet"
       pattern="[a-zA-ZÃ€-Ã¿0-9\s]+"
       required/>  
    <input type="email"    id="signupEmail"    placeholder="Email" />
    <input type="password" id="signupPassword" placeholder="Mot de passe (â‰¥ 6 car.)" />
    <input type="number"   id="signupAge"      placeholder="Ã‚ge (min 18)" min="18" />
    <button onclick="signupWithEmail()">Sâ€™inscrire</button>
  </div>
</section>

<!-- ============ OTHER USER FEED ============ -->
<section id="userFeed" class="tabcontent">
  <h3 id="userFeedTitle">Publications de â€¦</h3>
  <div id="userFeedContent"></div>
</section>
<section id="amis" class="tabcontent">
 <i class="fas fa-arrow-left" onclick="openTab(event,'home')"></i>
   <div class="post-header">
    talent D'Afrik   <img class="circle"  src="https://ucarecdn.com/04a9cc78-e2a1-4e71-baa0-b83b5de179ed/-/preview/417x417/" onclick="window.open('https://skills-camer.cm')"/>
    
   </div>
  <div id="suggestions">
 <h3>vous connaissez peut etre:</h3>
  <div id="suggestionsList">Chargementâ€¦</div>
</div>   
</section>
<section id="music" class="tabcontent">
 <button onclick="openTab(event,'mus')" id="bouton-lundi">importer ma musique <i class="fas fa-download"></i></button>  
  <p id='s'></p>
 <h2>Musiques expire dans 10 jours ğŸ§</h2>
<div id="musicFeed"></div>
</section>
<section id="mus" class="tabcontent">
  <h2>Publier un morceau</h2>
  <input type="text" id="nom" placeholder="Votre nom d'artiste" />
  <input type="text" id="titre" placeholder="Titre de la musique" />
  <input type="file" id="audioFile" accept="audio/*" />
  <button onclick="publishMusic()">Publier</button>

  <div id="statusMsg"></div>
</section>
<section id="condis" class="tabcontent" style="background-color:white">
  <h2>       Conditions d'utilisation gÃ©nÃ©rales :

</h2> 
   <div>
En crÃ©ant votre compte sur mboa skills vous acceptez les conditions d'utilisation de l'application.
<p style="color:orange">MonÃ©tisation:</p> Disponible partout en Afrique.
<p style="color:orange">Publications :</p> Ã€ chaque fois que tu publie une vidÃ©o oÃ¹ du texte tu gagnes <u style="color:blue">150FcfA</u> pour chaque 1k de vues affligÃ© Ã  ta publication ; 
<p style="color:orange">soutient:</p>
pour avoir cet outil vous devez avoir au moins 100 followers;
<p>Musique-pub:</p>Disponible chaque lundi de la semaine,pour partager ta musique cela nÃ©cessite un montant de <u style="color:blue">5100f</u> ;
<p style="color:orange">musique-pay:</p> avec ta musique tu gagnes <u style="color:blue">55FcFa</u> Ã  chaque fois que quelqu'un Ã©coute ta musique, tu peux gagner jusqu'Ã  <u style="color:blue">55 000FCFa</u> pour 1k d'Ã©coute ;
<p style="color:orange">Certification:</p> pour Ãªtre certifiÃ© tu dois rÃ©pondre aux critÃ¨res d'Ã©ligibilitÃ© (tes informations doivent Ãªtre juste ce qui nÃ©cessite un temps prÃ©cis); Dans le cas contraire pour Ãªtre certifiÃ© il te faudra dÃ©penser un montant de <u style="color:blue">18 000FcFa</u>.

L'application mboa skills est disponible partout dans le monde (la monÃ©tisation est Disponible) Le systÃ¨me du dÃ©pÃ´t fonctionne sans problÃ¨me ainsi que celui du retrait ;
<p style="color:orange">Retrait/DÃ©pÃ´t :</p> Disponible <u style="color:blue">24h/24 7j/7 du lundi au dimanche</u>. MTN et orange Money uniquement (pour le cas du Cameroun)
<br><br/>
N'oubliez pas de nous contacter sur <u style="color:blue">Facebook</u> merci.
   </div> 
</section>
<script type="module">

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. IMPORTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
import {
  getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider,
  updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
import {
  getFirestore,
  collection, addDoc, onSnapshot, query, orderBy, where,
  doc, getDocs, getDoc, setDoc, updateDoc,
  increment, serverTimestamp, runTransaction,
  deleteDoc, limit
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js';
import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  2. CONFIG & GLOBALS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const firebaseConfig = {
  apiKey:            "AIzaSyClSjd2LrIQpaJoVWO32vFRx7I9cvmDgBo",
  authDomain:        "mboa-ec602.firebaseapp.com",
  projectId:         "mboa-ec602",
  storageBucket:     "mboa-ec602.appspot.com",
  messagingSenderId: "498505132403",
  appId:             "1:498505132403:web:eb46547745f8d1a77b3d06"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const stg  = getStorage(app);
const provider = new GoogleAuthProvider();

let currentUser=null, likedPosts=new Set(), followingIds=new Set();
let boostId='', currentBalance=0;

const qs=id=>document.getElementById(id);
const fmt=n=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'k':n;

(async () => {
  const params = new URLSearchParams(location.search);
  const amount = parseFloat(params.get("amount"));
  const uid = params.get("uid");
  const ref = params.get("ref");

  if (amount > 0 && uid && ref && currentUser?.uid === uid) {
    // EmpÃªche double ajout
    const refDoc = doc(db, 'walletPayments', ref);
    const existing = await getDoc(refDoc);
    if (!existing.exists()) {
      // CrÃ©dite le solde
      const walletRef = doc(db, 'wallets', uid);
      await runTransaction(db, async t => {
        const snap = await t.get(walletRef);
        const old = snap.exists() ? snap.data().balance : 0;
        t.set(walletRef, { balance: old + amount }, { merge: true });
      });
      // Marque la transaction comme enregistrÃ©e
      await setDoc(refDoc, { uid, amount, createdAt: serverTimestamp() });
      alert(`Paiement rÃ©ussi : ${amount} FCFA ajoutÃ© Ã  votre solde`);
      location.href = location.origin + location.pathname; // Nettoyer l'URL
    }
  }
})();
(async () => {
  const params = new URLSearchParams(location.search);
  const amount = parseFloat(params.get("amount"));
  const uid = params.get("uid");
  const ref = params.get("ref");

  if (amount > 0 && uid && ref && currentUser?.uid === uid) {
    const refDoc = doc(db, 'walletPayments', ref);
    const existing = await getDoc(refDoc);
    if (!existing.exists()) {
      const walletRef = doc(db, 'wallets', uid);
      await runTransaction(db, async t => {
        const snap = await t.get(walletRef);
        const old = snap.exists() ? snap.data().balance : 0;
        t.set(walletRef, { balance: old + amount }, { merge: true });
      });
      await setDoc(refDoc, { uid, amount, createdAt: serverTimestamp() });
      alert(`Paiement rÃ©ussi : ${amount} FCFA ajoutÃ© Ã  votre solde`);
      location.href = location.origin + location.pathname;
    }
  }
})();
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  3. DOM READY â€” DÃ©pÃ´t
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
document.addEventListener('DOMContentLoaded',()=>{
  qs('deposer')?.addEventListener('click',()=>{
    const m=parseFloat(qs('montant').value);
    if(isNaN(m))return alert('Entrez un montant');deposit(m);qs('montant').value='';
  });
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  4. NAVIGATION & SHUFFLE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
 window.openTab = (evt, id) => {
  const tab = document.getElementById(id);
  const isAlreadyActive = tab.classList.contains('active');

  // ğŸ” Cas : on clique sur l'onglet dÃ©jÃ  actif
  if (isAlreadyActive) {
    const isAtTop = window.scrollY <= 10;
    if (isAtTop) {
      // ğŸŸ¢ DÃ©jÃ  en haut â†’ recharger toute la page
      location.reload();
    } else {
      // ğŸ”¼ Scroll vers le haut + shuffle si on est sur "home"
      window.scrollTo({ top: 0, behavior: 'smooth' });
      if (id === 'home') {
        shuffleFeed();
        renderFeed();
      }
            if (id === 'music') {
        shuffleFeed();
        renderMusicFeed();
      }
      if (id === 'videoFeed') {
        shuffleFeed();
        renderVideoFeed();
      }

    }
    return; // â›”ï¸ Ne pas continuer : pas de changement dâ€™onglet
  }

  // ğŸ†• Cas : on change dâ€™onglet â†’ juste activer le nouvel onglet
  document.querySelectorAll('.tabcontent').forEach(t => t.classList.toggle('active', t.id === id));
  document.querySelectorAll('.tablinks').forEach(l => l.classList.toggle('selected', l === evt.currentTarget));
  history.pushState({ tab: id }, '', `#${id}`);


// Ajouter l'Ã©vÃ©nement popstate pour gÃ©rer le bouton retour
window.addEventListener('popstate', (event) => {
  if (event.state && event.state.tab) {
    const tabId = event.state.tab;
    document.querySelectorAll('.tabcontent').forEach(t => t.classList.toggle('active', t.id === tabId));
    document.querySelectorAll('.tablinks').forEach(l => l.classList.toggle('selected', l.getAttribute('onclick').includes(tabId)));
  }
});

window.addEventListener('load', () => {
  const hash = window.location.hash.substring(1);
  if (hash) {
    const tab = document.getElementById(hash);
    if (tab) {
      document.querySelectorAll('.tabcontent').forEach(t => t.classList.toggle('active', t.id === hash));
      document.querySelectorAll('.tablinks').forEach(l => l.classList.toggle('selected', l.getAttribute('onclick').includes(hash)));
    }
  }
});

  // âœ… On NE FAIT RIEN Dâ€™AUTRE ! Ni shuffle, ni render ici.
  // Pas de renderFeed(), pas de shuffleFeed()
  // â†’ Lâ€™Accueil ne doit jamais Ãªtre modifiÃ© juste en y revenant
};
function shuffleFeed() {
  ['feed', 'videoFeed', 'content', 'musicFeed'].forEach(feedId => {
    const c = document.getElementById(feedId);
    if (!c) return; // si le feed n'existe pas
    const n = [...c.children];
    for (let i = n.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [n[i], n[j]] = [n[j], n[i]];
    }
    n.forEach(el => c.appendChild(el));
  });
}

// Lancer le mÃ©lange au chargement
window.addEventListener('load', shuffleFeed);
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  5. AUTH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
window.signInWithGoogle=()=>signInWithPopup(auth,provider).catch(e=>alert(e.message));
window.signOutUser=()=>signOut(auth);

onAuthStateChanged(auth,async user=>{
  currentUser=user;
  const p=user?.photoURL||'https://ucarecdn.com/d98b5778-d5ca-4460-bff0-3b1b423117cd/-/preview/1000x999/';
  qs('homeProfilePhoto').src=p;qs('feedmeProfilePhoto').src=p;
  qs('authStatus').textContent=user?` ${user.displayName||user.email}`:'';
  qs('accountStatus').textContent=user?`â€¢ ${user.displayName||user.email}`:'';
  qs('accountStatusFeed').textContent=qs('accountStatus').textContent;
  const btn = document.getElementById("certify-btn");
  if (!btn) return; // SÃ©curitÃ© : bouton pas encore dans le DOM

  if (!user) {
    btn.style.display = "none";
    return;
  }

  const verifiedRef = doc(db, 'verified', user.uid);

  try {
    const snap = await getDoc(verifiedRef);
    const isVerified = snap.exists() && snap.data().status === true;

    if (isVerified) {
      btn.style.display = "none"; // âœ… Masquer si certifiÃ©
    } else {
      btn.style.display = "block"; // âœ… Montrer si NON certifiÃ©
    }
  } catch (error) {
    console.error("Erreur lors de la vÃ©rification du statut :", error);
    // Par sÃ©curitÃ©, on masque si erreur
    btn.style.display = "none";
  }

  if (user) {
    await loadFollowing();  // fonction qui initialise followingIds
    loadSuggestions();      // charge les suggestions
  }

if (user) {
    showProfileLink(user.uid);
  }
  if(user){
    await loadWallet(); await loadFollowing(); await loadLikedPosts();
    renderFeed();renderMyFeed();renderVideoFeed();renderBoostFeed();
    await loadTotalViewsAndBalance();
  }else{
    likedPosts.clear();followingIds.clear();
    ['feed','myFeed','videoFeedContent','videoFeedContentBoost','userFeedContent'].forEach(id=>qs(id).innerHTML='');
    qs('totalViewsCount').textContent='';qs('currentBalance').textContent='Solde actuel: 0 FCFA';
  }
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/*  6. FOLLOW / FOLLOWERS (collection : faces)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/

/*  6. FOLLOW / FOLLOWERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadFollowing() {
  if (!currentUser) return;
  const s = await getDocs(collection(db, 'follows', currentUser.uid, 'list'));
  followingIds = new Set(s.docs.map(d => d.id));
}
window.renderFollowBtn = function (uid) {
  if (!currentUser || currentUser.uid === uid) return null;

  const btn = document.createElement('button');
  btn.className = 'follow-btn';

  const myListRef = doc(db, 'follows', currentUser.uid, 'list', uid); // relation individuelle
  const counterRef = doc(db, 'follows', uid); // compteur global

  // ğŸ”¹ Synchronisation temps rÃ©el pour savoir si je suis dÃ©jÃ  ce user
  onSnapshot(myListRef, snap => {
    const isFollowing = snap.exists();

    if (isFollowing) {
      btn.textContent = 'Ne plus suivre';
      btn.style.background = '#ccc';
      btn.style.color = '#000';
      btn.onclick = async () => {
        await deleteDoc(myListRef);
        try {
          await updateDoc(counterRef, { filo: increment(-1) });
        } catch (err) {
          console.error('Erreur dÃ©crÃ©mentation :', err);
        }
        followingIds.delete(uid);
      };
    } else {
      btn.textContent = 'Suivre';
      btn.style.background = '#1877f2';
      btn.style.color = '#fff';
      btn.onclick = async () => {
        await setDoc(myListRef, { date: serverTimestamp() });
        try {
          await updateDoc(counterRef, { filo: increment(1) });
        } catch {
          await setDoc(counterRef, { filo: 1 }, { merge: true });
        }
        followingIds.add(uid);
      };
    }
  });

  return btn;
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  7. WALLET dÃ©pÃ´t
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadWallet() {
  if (!currentUser) return;

  const walletRef = doc(db, "wallets", currentUser.uid);
  const walletSnap = await getDoc(walletRef);

  const balance = walletSnap.exists() ? walletSnap.data().balance : 0;
  qs("argent").textContent = balance.toFixed(0);
}

// ğŸŸ¢ Fonction de dÃ©pÃ´t
async function deposit(amount) {
  if (!currentUser) return alert("Connectez-vous d'abord.");
  if (!Number.isFinite(amount) || amount < 2000)
    return alert("Montant minimum de dÃ©pÃ´t : 2 000 FCFA");

  const walletRef = doc(db, "wallets", currentUser.uid);

  try {
    await runTransaction(db, async (transaction) => {
      const snap = await transaction.get(walletRef);
      const current = snap.exists() ? snap.data().balance || 0 : 0;
      const updated = current + amount;

      transaction.set(walletRef, { balance: updated }, { merge: true });
    });

    alert("DÃ©pÃ´t effectuÃ© avec succÃ¨s !");
    await loadWallet();
  } catch (e) {
    console.error("Erreur dÃ©pÃ´t :", e);
    alert("Erreur lors du dÃ©pÃ´t.");
  }
}
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  8. PUBLISH POST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
window.publishPost = async () => {
  if (!currentUser) return alert('Connectez-vous');

  const text = qs('postText').value.trim();
  const bg = qs('bgColor').value;
  const file = qs('imageFile').files[0];  // <-- input pour image
  const tit = qs('imageTitle').value.trim(); // <-- titre de l'image

  if (!text && !file) return alert('Ajoutez un texte ou une image');

  qs('status').textContent = 'Publicationâ€¦';

  const data = {
    userId: currentUser.uid,
    userEmail: currentUser.email,
    userName: currentUser.displayName || currentUser.email,
    userPhoto: currentUser.photoURL || 'https://via.placeholder.com/40',
    text,
    bgColor: bg,
    imageUrl: null,
    imageTitle: tit,
    views: 0,
    likes: 0,
    createdAt: serverTimestamp(),
    boosted: 0
  };

  const reset = () => {
    ['postText', 'imageTitle'].forEach(i => qs(i).value = '');
    qs('imageFile').value = '';
    qs('status').textContent = 'PubliÃ© !';
  };

  if (file) {
    const r = ref(stg, `images/${Date.now()}_${file.name}`);
    uploadBytesResumable(r, file).on(
      'state_changed',
      s => qs('status').textContent = `${Math.floor(s.bytesTransferred / s.totalBytes * 100)}%`,
      e => alert(e.message),
      async s => {
        data.imageUrl = await getDownloadURL(s.ref);
        await addDoc(collection(db, 'posts'), data);
        reset();
      }
    );
  } else {
    await addDoc(collection(db, 'posts'), data);
    reset();
  }
};
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  9. FEED ACCUEIL (boostÃ©s + suivis)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let firstRenderDone = false;
let cachedPosts = [];

async function renderFeed() {
  const c = qs('feed');
  c.textContent = 'Chargementâ€¦';

  const now = Date.now();
  const sevenDays = 7 * 24 * 60 * 60 * 1000;
  const posts = [];

  if (firstRenderDone && cachedPosts.length > 0) {
    const shuffled = [...cachedPosts];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    c.innerHTML = '';
    shuffled.forEach(p => c.appendChild(card(p.id, p.data, false)));
    return;
  }

  // BOOSTED POSTS (affichÃ©es mÃªme si +7 jours, tant que le boost est actif)
  const qBoost = query(
    collection(db, 'posts'),
    where('boosted', '>', 0),
    orderBy('boosted', 'desc'),
    orderBy('createdAt', 'desc'),
    limit(30)
  );

  const snapBoost = await getDocs(qBoost);

  for (const docSnap of snapBoost.docs) {
    const data = docSnap.data();
    const boostAt = data.boostAt?.toMillis?.() || 0;
    const diffBoostDays = (now - boostAt) / (1000 * 60 * 60 * 24);

    if (diffBoostDays <= 5) {
      posts.push({ id: docSnap.id, data });
    } else {
      // Boost expirÃ© â†’ nettoyage
      await updateDoc(doc(db, 'posts', docSnap.id), {
        boosted: 0
      });
    }
  }

  // FOLLOWED USERS : on affiche seulement les posts rÃ©cents (-7 jours)
  if (followingIds.size > 0) {
    const groups = [...followingIds].reduce((a, u, i) => {
      if (i % 10 === 0) a.push([]);
      a[a.length - 1].push(u);
      return a;
    }, []);

    for (const g of groups) {
      const q = query(
        collection(db, 'posts'),
        where('userId', 'in', g),
        orderBy('createdAt', 'desc'),
        limit(30)
      );
      const snap = await getDocs(q);
      snap.forEach(d => {
        const postData = d.data();
        const createdAt = postData.createdAt?.toMillis?.() || 0;
        const isRecent = (now - createdAt) <= sevenDays;

        const alreadyAdded = posts.find(p => p.id === d.id);
        if (isRecent && !alreadyAdded) {
          posts.push({ id: d.id, data: postData });
        }
      });
    }
  }

  // Tri du plus rÃ©cent au plus ancien
  posts.sort((a, b) => {
    const ta = a.data.createdAt?.toMillis?.() || 0;
    const tb = b.data.createdAt?.toMillis?.() || 0;
    return tb - ta;
  });

  cachedPosts = posts;
  firstRenderDone = true;

  c.innerHTML = '';
  posts.forEach(p => c.appendChild(card(p.id, p.data, false)));
}
function loadFollowedPosts(c){
  if(!followingIds.size)return;
  const groups=[...followingIds].reduce((a,u,i)=>{if(i%10===0)a.push([]);a[a.length-1].push(u);return a;},[]);
  groups.forEach(g=>{
    const q=query(collection(db,'posts'),where('userId','in',g),orderBy('createdAt','desc'),limit(30));
    onSnapshot(q,snap=>snap.forEach(d=>{if(!c.querySelector(`[data-post="${d.id}"]`))c.appendChild(card(d.id,d.data(),false));}));
  });
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 10. MES POSTS  (+ compteur followers)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function renderMyFeed() {
  if (!currentUser) return;

  const c = qs('myFeed');
  c.textContent = 'Chargementâ€¦';

  const fol = document.createElement('p');
fol.dataset.followersOf = currentUser.uid;
fol.style.backgroundColor = '#050505';
fol.style.color = '#fff';
// texte blanc pour que Ã§a reste lisible
c.appendChild(fol);
  // ğŸ”¹ Lecture en temps rÃ©el du compteur de followers
  onSnapshot(doc(db, 'follows', currentUser.uid), snap => {
    const nbFollowers = snap.exists() ? snap.data()?.filo || 0 : 0;
    fol.textContent = `${fmt(nbFollowers)} followers`;
  });

  // ğŸ”¹ Publications
  onSnapshot(
    query(
      collection(db, 'posts'),
      where('userId', '==', currentUser.uid),
      orderBy('createdAt', 'desc')
    ),
    snap => {
      c.innerHTML = '';
      c.appendChild(fol);

      if (snap.empty) {
        const p = document.createElement('p');
        p.textContent = 'Aucune publication.';
        c.appendChild(p);
      } else {
        snap.forEach(d => c.appendChild(card(d.id, d.data(), true)));
      }
    }
  );
}
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 11. VIDEO FEED & BOOST FEED
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function renderVideoFeed() {
  const c = qs('videoFeedContent');
  c.textContent = 'Chargementâ€¦';

  onSnapshot(
    query(
      collection(db, 'posts'),
      where('imageUrl', '!=', null),     // âœ… On filtre sur imageUrl
      where('boosted', '>', 0),          // âœ… BoostÃ© uniquement
      orderBy('createdAt', 'desc')       // âœ… Par date de crÃ©ation
    ),
    snap => {
      c.innerHTML = '';

      const docs = Array.from(snap.docs);

      // Optionnel : MÃ©langer les publications
      docs.sort(() => Math.random() - 0.5);

      for (const d of docs) {
        c.appendChild(card(d.id, d.data(), false));
      }
    }
  );
}
function renderBoostFeed() {
  if (!currentUser) return;

  const c = qs('videoFeedContentBoost');
  c.textContent = 'Chargementâ€¦';

  onSnapshot(
    query(
      collection(db, 'posts'),
      where('userId', '==', currentUser.uid),
      where('imageUrl', '!=', null), // âœ… Affiche uniquement les images
      orderBy('createdAt', 'desc')
    ),
    snap => {
      c.innerHTML = '';
      snap.forEach(d => c.appendChild(card(d.id, d.data(), true)));
    }
  );
}
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 12. CARD (like / comments / boost)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/

function card(id, d, isMine) {
  const w = document.createElement('div');
  w.className = 'post';
  w.dataset.post = id;

  /* ---------- HEADER ---------- */
  const head = document.createElement('div');
  head.className = 'post-header';

  const img = document.createElement('img');
  img.src = d.userPhoto || 'https://via.placeholder.com/40';
  img.alt = d.userName || d.userEmail || 'Profil';
  img.onclick = () => openUserFeed(d.userId);
const name = document.createElement('a');
name.className = 'username';
name.href = `https://mboaskill.cm/${d.userId}`;
name.onclick = (e) => {
  e.preventDefault();
  openUserFeed(d.userId);
};

// VÃ©rifie si l'utilisateur est certifiÃ© (collection 'verified')
const verifiedRef = doc(db, 'verified', d.userId);
getDoc(verifiedRef).then((snap) => {
  if (snap.exists() && snap.data().status === true) {
    name.innerHTML = `
      ${d.userName || d.userEmail}
      <span class="verified-badge">
        <i class="fas fa-certificate"></i>
        <i class="fas fa-check checkmark"></i>
      </span>
    `;
  } else {
    name.textContent = d.userName || d.userEmail;
  }
});
// Temps relatif
  const time = document.createElement('small');
  time.style.marginLeft = '8px';
  time.style.color = '#888';
  if (d.createdAt?.toDate) {
    time.textContent = `â€¢ il y a ${timeSince(d.createdAt.toDate())}`;
  }

  head.append(img, name, time);

  // Bouton suivre
  const fbtn = renderFollowBtn(d.userId);
  if (fbtn) head.appendChild(fbtn);

  // Ã‰tiquette sponsorisÃ© si boostÃ©
  if ((d.boosted || 0) > 0) {
    const tag = document.createElement('span');
tag.innerHTML = '<i class="fa-solid fa-trophy" style="color:gold"></i> SponsorisÃ©';
    tag.style.cssText = 'margin-left:auto;color:#ffa500;font-size:12px;font-weight:bold';
    head.appendChild(tag);
  }

  w.appendChild(head);

  /* ---------- CONTENT ---------- */
  const cont = document.createElement('div');
cont.className = 'post-content';

if (d.imageUrl) {
  // ğŸ–¼ï¸ Image uniquement (remplace la vidÃ©o)
  const imgHtml = `
    <img src="${d.imageUrl}" style="max-width:100%;border-radius:8px;" />
    ${d.imageTitle ? `<div style="font-weight:bold;margin-top:4px;">${linkifyText(d.imageTitle)}</div>` : ''}
  `;
  cont.innerHTML = imgHtml;

} else if (d.text) {
  // ğŸ“ Texte seul si pas d'image
  cont.innerHTML = `<div class="text-bg" style="background:${d.bgColor || '#1877f2'}">${linkifyText(d.text)}</div>`;
}

w.appendChild(cont);
  /* ---------- ACTIONS ---------- */
  const act = document.createElement('div');
  act.className = 'post-actions';

  // Like
const like = document.createElement('i');
like.className = 'fa-regular fa-heart'; // cÅ“ur vide au dÃ©part
like.classList.add('like'); // ta classe perso pour styliser

const lCnt = document.createElement('span');
lCnt.textContent = fmt(d.likes || 0);

// VÃ©rifie si l'utilisateur a dÃ©jÃ  likÃ©
if (currentUser) {
  const likeRef = doc(db, 'posts', id, 'likes', currentUser.uid);
  getDoc(likeRef).then(snap => {
    if (snap.exists()) {
      like.classList.remove('fa-regular');
      like.classList.add('fa-solid', 'liked'); // plein + couleur
    }
  });
}

// Toggle au clic
like.onclick = () => toggleLike(id, like, lCnt);
// VÃ©rifie si dÃ©jÃ  likÃ© depuis Firestore
if (currentUser) {
  const likeRef = doc(db, 'posts', id, 'likes', currentUser.uid);
  getDoc(likeRef).then(snap => {
    if (snap.exists()) like.classList.add('liked');
  });
}

like.onclick = () => toggleLike(id, like, lCnt);

act.append(like, lCnt);
  // ğŸŸ¡ EDIT (uniquement mes posts) â€” placÃ© AVANT commentaires
  if (isMine) {
    const edit = document.createElement('i');
    edit.className = 'fa-solid fa-pen-to-square';
    edit.style.cursor = 'pointer';
    edit.title = 'Modifier';
    edit.onclick = () => editPost(id, d);
    act.appendChild(edit);
  }

  // Vues (affichage combinÃ©)
  const vCnt = document.createElement('span');
  const vuesAffichees = (d.views || 0) + (d.boosted || 0) + ((d.likes || 0) * 10);
  vCnt.textContent = `ğŸ‘ï¸ ${fmt(vuesAffichees)}`;
  act.appendChild(vCnt);

  // Commentaire
  const comI = document.createElement('i');
  comI.className = 'fa-regular fa-comment';
  const comCnt = document.createElement('span');
  comCnt.textContent = ' â€¦ ';
  act.append(comI, comCnt);

  // Boost (uniquement mes posts)
  if (isMine) {
    const b = document.createElement('button');
    b.className = 'boost-btn';
    b.textContent = 'Booster';
    b.onclick = () => selectBoostPost(id, d.text || d.videoTitle || 'Sans titre');
    act.appendChild(b);
  }

  w.appendChild(act);

  /* ---------- COMMENTS SECTION (toggle) ---------- */
  const comSec = document.createElement('div');
  comSec.className = 'comments-section';
  comSec.style.display = 'none';

  const comList = document.createElement('div');
  comSec.appendChild(comList);

  if (currentUser) {
    const div = document.createElement('div');
    div.className = 'comment-input';

    const inp = document.createElement('input');
    inp.placeholder = 'Ajouter un commentaire...';

    const btn = document.createElement('button');
    btn.textContent = 'Envoyer';
    btn.onclick = () => {
      const t = inp.value.trim();
      if (!t) return;
      addComment(id, t);
      inp.value = '';
    };

    div.append(inp, btn);
    comSec.appendChild(div);
  }

  w.appendChild(comSec);

  // Toggle affichage commentaires
  comI.onclick = () => {
    const show = comSec.style.display === 'none';
    comSec.style.display = show ? 'block' : 'none';
    if (show) loadComments(id, comList, comCnt);
  };

  return w;
}
async function editPost(postId, data) {
  // RÃ©cup valeur actuelle
  const currentText = data.text || '';
  const newText = prompt('Modifiez le texte de la publication :', currentText);
  if (newText === null) return; // AnnulÃ©

  // Si rien changÃ©, on ne fait rien
  if (newText.trim() === currentText.trim()) return;

  try {
    await updateDoc(doc(db, 'posts', postId), { text: newText.trim() });
    alert('Publication mise Ã  jour.');
  } catch (e) {
    console.error('Erreur mise Ã  jour post', e);
    alert('Erreur lors de la mise Ã  jour.');
  }
}

/* LIKE */
async function loadLikedPosts(){likedPosts.clear();}
async function toggleLike(pid, icon, cnt) {
  if (!currentUser) return alert('Connectez-vous');

  const ref = doc(db, 'posts', pid);
  const likeRef = doc(db, 'posts', pid, 'likes', currentUser.uid);

  const snap = await getDoc(likeRef);

  if (snap.exists()) {
    // DÃ©jÃ  likÃ© â†’ on retire
    await deleteDoc(likeRef);
    icon.classList.remove('liked');
    await updateDoc(ref, { likes: increment(-1) });
  } else {
    // Pas encore likÃ© â†’ on ajoute
    await setDoc(likeRef, {
      userId: currentUser.uid,
      userName: currentUser.displayName || currentUser.email || '',
      likedAt: serverTimestamp()
    });
    icon.classList.add('liked');
    await updateDoc(ref, { likes: increment(1) });
  }

  // Actualiser le compteur
  const postSnap = await getDoc(ref);
  cnt.textContent = fmt(postSnap.data().likes || 0);
}
/* COMMENTS */
async function loadComments(pid, container, cnt) {
  const s = await getDocs(query(collection(db, 'posts', pid, 'comments'), orderBy('createdAt')));
  container.innerHTML = '';
  cnt.textContent = s.size;

  // Pour gÃ©rer les promesses, on utilise for...of sur s.docs
  for (const docSnap of s.docs) {
    const c = docSnap.data();

    const div = document.createElement('div');
    div.className = 'comment';

    // CrÃ©er le lien du username
    const name = document.createElement('a');
    name.className = 'username';
    name.href = `https://mboaskill.cm/${c.userId}`;
    name.style.cursor = 'pointer';
    name.style.color = '#FFA500';

    name.onclick = (e) => {
      e.preventDefault();
      openUserFeed(c.userId);
    };

    // VÃ©rifier si l'utilisateur est certifiÃ©
    const verifiedRef = doc(db, 'verified', c.userId);
    const verifiedSnap = await getDoc(verifiedRef);

    if (verifiedSnap.exists() && verifiedSnap.data().status === true) {
      name.innerHTML = `
        ${c.userName || c.userEmail || 'Utilisateur'}
        <span class="verified-badge" style="margin-left: 6px; color: #1da1f2;">
          <i class="fas fa-certificate"></i>
          <i class="fas fa-check checkmark"></i>
        </span>
      `;
    } else {
      name.textContent = c.userName || c.userEmail || 'Utilisateur';
    }

    const span = document.createElement('span');
    span.innerHTML = ' : ' + linkifyText(c.text || '');

    div.appendChild(name);
    div.appendChild(span);
    container.appendChild(div);

    // Ajout d'un saut de ligne entre les commentaires
    container.appendChild(document.createElement('br'));
  }
}
async function addComment(pid,text){
  if(!currentUser)return;
  await addDoc(collection(db,'posts',pid,'comments'),{userId:currentUser.uid,userName:currentUser.displayName||currentUser.email,text,createdAt:serverTimestamp()});
}

/* BOOST */
function selectBoostPost(pid,title){
  boostId=pid;qs('boostStatus').textContent=`1 sÃ©lection : ${title}`;qs('boostPanel').style.display='block';
  openTab({currentTarget:document.querySelector('.tablinks[onclick*="vibo"]')},'vibo');
}
async function prepareWallet() {
  if (!currentUser) return;

  const walletRef = doc(db, "wallets", currentUser.uid);
  const walletSnap = await getDoc(walletRef);

  if (!walletSnap.exists()) {
    // CrÃ©er un wallet vide avec 0 FCFA
    await setDoc(walletRef, { balance: 0 });
    console.log("Wallet initialisÃ© Ã  0 FCFA");
  }
}
async function debit(cost){
  if(!currentUser)return false;
  const ref=doc(db,'wallets',currentUser.uid);
  const ok=await runTransaction(db,async t=>{const s=await t.get(ref);const bal=s.exists()?s.data().balance:0;if(bal<cost)return false;t.update(ref,{balance:bal-cost});return true;});
  if(!ok)alert('Solde insuffisant(min 2100F)');await loadWallet();return ok;
}
window.boostPost=async()=>{
  if(!boostId)return alert('Choisissez une publication');
  const v=parseInt(qs('boostViews').value);if(isNaN(v)||v<4000)return alert('Min 4 000 vues');
  const cost=Math.ceil(v/1000)*525;if(!(await debit(cost)))return;
  try{
await updateDoc(doc(db, 'posts', boostId), {
  boosted: increment(v),
  boostAt: serverTimestamp() // â† trÃ¨s important pour savoir quand le boost a commencÃ©
});
    qs('boostStatus').textContent=`Boost succÃ¨s âœ”ï¸`;qs('boostViews').value='';boostId='';renderFeed();renderMyFeed();await loadTotalViewsAndBalance();
  }catch(e){alert('Erreur boost : '+e.message);await deposit(cost);}
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 13. USER FEED & SEARCH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
// Feed d'un utilisateur
window.openUserFeed = async uid => {
  openTab(
    { currentTarget: document.querySelector('.tablinks[onclick*="home"]') },
    'userFeed'
  );

  const cont = qs('userFeedContent'),
        title = qs('userFeedTitle');

  cont.textContent = 'Chargementâ€¦';

  let name = 'Utilisateur',
      photo = 'https://via.placeholder.com/40';

  // ğŸ”¹ RÃ©cupÃ¨re la derniÃ¨re publication pour nom & photo
  const last = await getDocs(
    query(
      collection(db, 'posts'),
      where('userId', '==', uid),
      orderBy('createdAt', 'desc'),
      limit(1)
    )
  );
  if (!last.empty) {
    const d = last.docs[0].data();
    name = d.userName || name;
    photo = d.userPhoto || photo;
  }

  // HEADER
  title.innerHTML = '';
  title.style.cssText = 'display:flex;flex-direction:column;align-items:flex-start;gap:4px';

  const headerTop = document.createElement('div');
  headerTop.style.cssText = 'display:flex;align-items:center;gap:8px';

  const img = document.createElement('img');
  img.src = photo;
  img.style.cssText = 'width:40px;height:40px;border-radius:50%';

  const str = document.createElement('strong');
  str.textContent = name;

  const fol = document.createElement('span');
  fol.dataset.followersOf = uid;
fol.style.backgroundColor = '#050505';
fol.style.color = '#fff'; // texte blanc pour que Ã§a reste lisible
  // ğŸ”¹ Bouton suivre/dÃ©suivre
  const btn = renderFollowBtn(uid);
  if (btn) headerTop.appendChild(btn);

  headerTop.prepend(img, str, fol);
  title.appendChild(headerTop);

// ğŸ”¹ Bouton "soutenir" si +100 followers
// ğŸ”¹ VÃ©rifie followers
const followsRef = doc(db, 'follows', uid);
const followsSnap = await getDoc(followsRef);
const followerCount = followsSnap.exists() ? (followsSnap.data().filo || 0) : 0;

// ğŸ”¹ Met Ã  jour l'icÃ´ne dans #gagne
const gagneEl = document.getElementById('gagne');
if (gagneEl) {
  if (followerCount >= 100) {
    gagneEl.innerHTML = '<i class="fas fa-check-circle" style="color:green;"></i>';
  } else {
    gagneEl.innerHTML = '<i class="fa-solid fa-xmark" style="color:red;"></i>';
  }
}

// ğŸ”¹ Bouton "soutenir" si +100 followers
if (followerCount > 100) {
  const supportBtn = document.createElement('button');
  supportBtn.innerHTML = '<i class="fa-solid fa-star"></i> Soutenir (450F)';
  supportBtn.style.cssText = 'margin-top:6px;background:#ffd700;color:black;padding:4px 8px;border:none;border-radius:4px;cursor:pointer';

  supportBtn.onclick = async () => {
    try {
      const walletRef = doc(db, 'wallets', currentUser.uid);
      const walletSnap = await getDoc(walletRef);

      if (!walletSnap.exists() || (walletSnap.data().balance || 0) < 450) {
        alert('ğŸ’¸ Solde insuffisant pour soutenir');
        return;
      }

      await updateDoc(walletRef, { balance: walletSnap.data().balance - 450 });

      await setDoc(
        doc(db, 'users', uid),
        { soutienvues: increment(3000) },
        { merge: true }
      );

      alert('âœ… Soutien envoyÃ© avec succÃ¨s !');
    } catch (err) {
      console.error('Erreur lors du soutien :', err);
      alert('âŒ Une erreur est survenue');
    }
  };

  title.appendChild(supportBtn);
}
// ğŸ”¹ Compteur de followers depuis follows/{uid} -> champ filo
onSnapshot(doc(db, 'follows', uid), snap => {
  const nbFollowers = snap.exists() ? snap.data()?.filo || 0 : 0;
  fol.textContent = `${fmt(nbFollowers)} followers`;
});
  // ğŸ”¹ Flux des publications
  onSnapshot(
    query(
      collection(db, 'posts'),
      where('userId', '==', uid),
      orderBy('createdAt', 'desc')
    ),
    snap => {
      cont.innerHTML = '';
      if (snap.empty) {
        cont.textContent = 'Aucune publication.';
      } else {
        snap.forEach(d => cont.appendChild(card(d.id, d.data(), false)));
      }
    }
  );
};
window.searchUser=async()=>{
const q=qs('searchUserInput').value.trim().toLowerCase();
if(!q)return alert('Entrez un nom ou e-mail');
const s=await getDocs(collection(db,'posts'));const map=new Map();
s.forEach(d=>{const v=d.data();if((v.userName||'').toLowerCase().includes(q)||(v.userEmail||'').toLowerCase().includes(q))map.set(v.userId,{uid:v.userId,name:v.userName,email:v.userEmail,photo:v.userPhoto});});
const res=qs('searchResults');res.innerHTML='';
if(map.size===0)return res.textContent='Aucun utilisateur trouvÃ©';
map.forEach(u=>{
const d=document.createElement('div');d.style.cssText='cursor:pointer;display:flex;align-items:center;gap:8px;margin-bottom:8px';
const img=document.createElement('img');img.src=u.photo||'https://via.placeholder.com/40';img.style.cssText='width:40px;height:40px;border-radius:50%';
const span=document.createElement('span');span.textContent=u.name||u.email;span.style.cssText='color:#1877f2;font-weight:bold';
const btn=renderFollowBtn(u.uid);
d.append(img,span);if(btn)d.append(btn);d.onclick=()=>openUserFeed(u.uid);res.appendChild(d);
});
};

  
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 14. VIEWS & RETRAIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/

async function loadTotalViewsAndBalance(period = 'all') {
  if (!currentUser) return;

  const postsRef = collection(db, 'posts');
  let q = query(postsRef, where('userId', '==', currentUser.uid));
  // TODO : ajouter filtre pÃ©riode si besoin

  const snap = await getDocs(q);
  let totalViews = 0;

  snap.forEach(d => {
    const v = d.data();
    const views = v.views || 0;
    const boosted = v.boosted || 0;
    const likes = v.likes || 0;
    const vuesParLike = likes * 13;
    const totalviewcontent = v.totalviewcontent || 0;

    totalViews += views + boosted + vuesParLike + totalviewcontent;
  });

  // RÃ©cupÃ©rer soutienvues depuis users/{uid}
  const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
  const soutienvues = userDoc.exists() ? (userDoc.data().soutienvues || 0) : 0;

  totalViews += soutienvues;

  // Affichage direct dans un Ã©lÃ©ment HTML
  const el = document.getElementById('totalViewsCounter');
  if (el) {
    el.textContent = `Total vues + soutienvues: ${totalViews}`;
  }

const raw = Math.floor(totalViews / 1000) * 150;
  const withdrawalsSnap = await getDocs(
    query(collection(db, 'withdrawals'), where('userId', '==', currentUser.uid))
  );
  const withdrawn = withdrawalsSnap.docs.reduce((sum, d) => sum + (d.data().amount || 0), 0);

  const potential = raw - withdrawn;
  qs('totalViewsCount').textContent = fmt(totalViews);
  qs('currentBalance').textContent = potential + ' FCFA';

  currentBalance = potential; // mise Ã  jour interne seulement
}
// ğŸ” Fonction de retrait
window.withdrawBalance = async () => {
  const a = qs("withdrawAmount").valueAsNumber;
  const phone = qs("withdrawPhone").value.trim();

  if (!currentUser || !currentUser.uid) {
    return alert("Utilisateur non authentifiÃ©.");
  }

  if (!Number.isFinite(a) || a < 5000) {
    return alert("Montant minimum : 5 000 FCFA");
  }

  if (!phone || phone.length < 8) {
    return alert("Veuillez entrer un numÃ©ro valide.");
  }

  // Recalculer le solde si jamais la page nâ€™est pas fraÃ®che
  await loadTotalViewsAndBalance(); // pour Ã©viter erreurs

  if (a > currentBalance) {
    return alert("Solde insuffisant.");
  }

  try {
    // ğŸ”¥ Enregistrer le retrait
    await addDoc(collection(db, "withdrawals"), {
      userId: currentUser.uid,
      amount: a,
      phone: phone,
      date: new Date(),
      status: "en attente",
    });

    // ğŸ’¬ Message WhatsApp
    const message = encodeURIComponent(
      `Demande de retrait:\nMontant: ${a} FCFA\nTÃ©lÃ©phone: ${phone}`
    );
    const whatsappAdmin = "237674073769";
    const whatsappURL = `https://wa.me/${whatsappAdmin}?text=${message}`;
    window.open(whatsappURL, "_blank");

    // ğŸ–¥ï¸ RÃ©initialiser lâ€™UI
    qs("withdrawAmount").value = "";
    qs("withdrawPhone").value = "";

    // ğŸ” Recharger le solde Ã  lâ€™Ã©cran
    await loadTotalViewsAndBalance();

    alert("Demande de retrait enregistrÃ©e et transmise !");
  } catch (err) {
    console.error("Erreur de retrait :", err);
    alert("Une erreur est survenue.");
  }
};

  // SIGNUP  LOGIN EMAIL
window.signupWithEmail = async () => {
  const n = qs('signupName').value.trim();
  const e = qs('signupEmail').value.trim();
  const p = qs('signupPassword').value;
  const age = parseInt(qs('signupAge').value, 10);

  if (!n || !e || !p || isNaN(age)) return alert('Champs manquants');
  if (age < 18) return alert('Ã‚ge min 18');
  if (p.length < 6) return alert('Mot de passe â‰¥6');

  try {
    // 1) CrÃ©e le compte auth
    const c = await createUserWithEmailAndPassword(auth, e, p);
    const user = c.user;
    await updateProfile(user, { displayName: n });

    // 2) Enregistre l'utilisateur dans Firestore
    await setDoc(doc(db, "users", user.uid), {
      uid: user.uid,
      name: n,
      email: e,
      age: age,
      createdAt: serverTimestamp()
    });

    // 3) Suivi automatique de l'admin
    // **REMPLACE** cette valeur par l'UID rÃ©el du compte admin prÃ©sent dans ta collection "follows"
    const ADMIN_UID = "810T1WLrysRxELoiYO7hSHywwRA3";

    const listRef = doc(db, "follows", ADMIN_UID, "list", user.uid);
    const counterRef = doc(db, "follows", ADMIN_UID);

    // Essaye d'abord une transaction (atomique) : increment + crÃ©ation de la doc list
    try {
      await runTransaction(db, async (tx) => {
        const counterSnap = await tx.get(counterRef);

        if (!counterSnap.exists()) {
          // crÃ©e le doc compteur avec filo:1 (merge-like)
          tx.set(counterRef, { filo: 1 }, { merge: true });
        } else {
          // incrÃ©mente atomiquement
          tx.update(counterRef, { filo: increment(1) });
        }

        // crÃ©e la doc dans la sous-collection list (trace du follow)
        tx.set(listRef, { uid: user.uid, name: n, date: serverTimestamp() });
      });
    } catch (tranErr) {
      // si la transaction Ã©choue, fallback : Ã©crire la liste puis updateDoc/incrÃ©menter
      console.warn('Transaction follow admin failed, using fallback:', tranErr);
      await setDoc(listRef, { uid: user.uid, name: n, date: serverTimestamp() });
      try {
        await updateDoc(counterRef, { filo: increment(1) });
      } catch (upErr) {
        // si le doc n'existe pas encore, crÃ©e-le Ã  1 (merge pour ne pas Ã©craser)
        await setDoc(counterRef, { filo: 1 }, { merge: true });
      }
    }

    // 4) Met Ã  jour le cache local des follows si tu utilises loadFollowing()
    try { await loadFollowing(); } catch (e) { /* ignore */ }

    alert("Compte crÃ©Ã© avec succÃ¨s !");
    location.reload();

  } catch (err) {
    console.error('Signup error:', err);
    alert(err.message || 'Erreur lors de la crÃ©ation du compte');
  }
};
 // Filtrage du nom
const nameInput = document.getElementById("signupName");
nameInput.addEventListener("input", function () {
  // Autorise lettres (avec accents), chiffres, et espaces
  this.value = this.value.replace(/[^a-zA-ZÃ€-Ã¿0-9\s]/g, '');
});
window.loginWithEmail=async()=>{
  const e=qs('loginEmail').value.trim(),p=qs('loginPassword').value;
  if(!e||!p)return alert('Entrez e-mail et mdp');
  try{await signInWithEmailAndPassword(auth,e,p);location.reload();}
  catch(err){alert(err.message);}
};
document.getElementById("notchpayBtn")?.addEventListener("click", async () => {
  const m = parseFloat(qs("montant").value);
  if (isNaN(m) || m < 500) return alert("Min 500 FCFA");
  if (!currentUser) return alert("Connectez-vous");

  await prepareWallet(); // â† ici on initialise le wallet si nÃ©cessaire

  const email = currentUser.email;
  const uid = currentUser.uid;
  const ref = `tx_${Date.now()}`;
  const redirectUrl = encodeURIComponent(
    `${location.origin}${location.pathname}?amount=${m}&uid=${uid}&ref=${ref}`
  );

  const link = `https://notchpay.me/mxlU78cqX`;
  window.location.href = link;
});
function openHomeTab(evt) {
  openTab(evt, 'home'); // Ouvre la section 'home'
  window.scrollTo({ top: 0, behavior: 'smooth' }); // Remonte en haut avec animation douce
}
function timeSince(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const intervals = {
    annÃ©e: 31536000,
    mois: 2592000,
    semaine: 604800,
    jour: 86400,
    heure: 3600,
    minute: 60,
    seconde: 1,
  };

  for (const [unit, value] of Object.entries(intervals)) {
    const amount = Math.floor(seconds / value);
    if (amount >= 1) {
      return `${amount} ${unit}${amount > 1 ? 's' : ''}`;
    }
  }
  return 'quelques secondes';
}
  document.getElementById('periodSelect').addEventListener('change', (e) => {
  const selectedPeriod = e.target.value;
  loadTotalViewsAndBalance(selectedPeriod);
});

// Chargement initial avec la pÃ©riode "all"
loadTotalViewsAndBalance('all');
  function handleVideoVisibility() {
  const videos = document.querySelectorAll('video[data-video]');

  videos.forEach(video => {
    const rect = video.getBoundingClientRect();
    const inView = rect.top >= 0 && rect.bottom <= window.innerHeight;

    if (inView) {
      video.play().catch(() => {});
    } else {
      video.pause();
    }
  });
}

window.addEventListener('scroll', handleVideoVisibility);
window.addEventListener('resize', handleVideoVisibility);
window.addEventListener('load', handleVideoVisibility);
function linkifyText(text) {
  const urlPattern = /(\b(https?:\/\/)?([\w.-]+\.[a-z]{2,})(\/\S*)?)/gi;
  return text.replace(urlPattern, (match) => {
    let url = match;
    if (!url.startsWith("http")) url = "https://" + url;
    return `<a href="${url}" target="_blank" style="color:#1877f2;text-decoration:underline;">${match}</a>`;
  });
}
// Fonction pour afficher le lien de profil
function showProfileLink(uid) {
  const link = `https://mboaskill.cm/u/${uid}`;
  const input = document.getElementById('profile-link');
  if (input) input.value = link;

  const box = document.getElementById('profile-link-box');
  if (box) box.style.display = 'block';
}

// Fonction pour copier le lien
function profil_link() {
  const input = document.getElementById('profile-link');
  if (!input) return;
  input.select();
  navigator.clipboard.writeText(input.value).then(() => {
    alert('Lien copiÃ© !');
  });
}

// Attendre que l'utilisateur soit connectÃ©
onAuthStateChanged(auth, (user) => {
  if (user) {
    showProfileLink(user.uid);
  } else {
    console.warn("Utilisateur non connectÃ©");
  }
});

// Attacher l'Ã©vÃ©nement au bouton
document.getElementById('copy-link-btn')?.addEventListener('click', profil_link);
// VÃ©rifie si lâ€™URL est de la forme https://mboaskill.cm/u/<uid>
window.addEventListener('DOMContentLoaded', () => {
  const path = window.location.pathname;

  // CrÃ©ation d'une fonction globale pour ouvrir une section
  window.openSection = function(tabName) {
    const tryOpen = () => {
      const el = document.querySelector(`.tablinks[onclick*="${tabName}"]`);
      if (el && typeof window.openTab === 'function') {
        openTab({ currentTarget: el }, tabName);
        return true;
      }
      return false;
    };

    if (!tryOpen()) {
      const check = setInterval(() => {
        if (tryOpen()) clearInterval(check);
      }, 200);
    }
  };

  // Gestion de la route /u/:uid
  const matchUser = path.match(/^\/u\/([^\/]+)/);
  if (matchUser && matchUser[1]) {
    const uid = matchUser[1];
    if (typeof window.openUserFeed === 'function') {
      window.openUserFeed(uid);
    } else {
      const check = setInterval(() => {
        if (typeof window.openUserFeed === 'function') {
          clearInterval(check);
          window.openUserFeed(uid);
        }
      }, 200);
    }
  } 
  // Autres routes
  else {
    switch (path) {
      case '/#music':
        window.openTab('music');
        break;
      case '/#image':
        window.openTab('videoFeed');
        break;
      case '/#feedme':
        window.openTab('feedme');
        break;
    }
  }

  // Nettoyer lâ€™URL visuellement
  history.replaceState({}, '', '/');
});
let suggestionInterval; // Ã  placer en global

async function loadSuggestions() {
  const currentUser = auth.currentUser;
  if (!currentUser) return;

  const suggestionsList = document.getElementById('suggestionsList');
  suggestionsList.textContent = 'Chargementâ€¦';

  const allUsersSnap = await getDocs(collection(db, 'users'));
  let suggestions = [];

  allUsersSnap.forEach(docSnap => {
    const user = docSnap.data();
    const uid = docSnap.id;
    if (uid !== currentUser.uid && !followingIds.has(uid)) {
      suggestions.push({ uid, ...user });
    }
  });

  if (suggestions.length === 0) {
    suggestionsList.textContent = 'Aucune suggestion pour le moment.';
    return;
  }

  // Fonction pour mÃ©langer et afficher
  function updateSuggestions() {
    // MÃ©lange
    for (let i = suggestions.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [suggestions[i], suggestions[j]] = [suggestions[j], suggestions[i]];
    }

    // Affichage
    suggestionsList.innerHTML = '<hr>';
    suggestions.forEach(user => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.style = 'display:flex;align-items:center;gap:10px;margin:5px 0';

      const img = document.createElement('img');
      img.src = user.photo || 'https://via.placeholder.com/40';
      img.style = 'width:40px;height:40px;border-radius:50%';

      const name = document.createElement('span');
      name.textContent = user.name || user.email || 'Utilisateur';

      const btn = renderFollowBtn(user.uid);

      div.append(img, name);
      if (btn) div.appendChild(btn);
      suggestionsList.appendChild(div);
    });
  }

  updateSuggestions(); // affiche une fois immÃ©diatement
  clearInterval(suggestionInterval);
  suggestionInterval = setInterval(updateSuggestions, 60000); // toutes les 1 min
}

window.certifyUser = async function () {
  const userId = currentUser?.uid;
  if (!userId) return alert("Utilisateur non connectÃ©");

  const walletRef = doc(db, 'wallets', userId);  // <-- collection wallets
  const verifiedRef = doc(db, 'verified', userId);

  try {
    const snap = await getDoc(walletRef);
    const balance = snap.exists() ? snap.data().balance || 0 : 0;

    if (balance >= 18000) {
      // DÃ©duction de 18 000 Fcfa
      await updateDoc(walletRef, {
        balance: balance - 18000
      });

      // Mise Ã  jour du statut certifiÃ©
      await setDoc(verifiedRef, {
        status: true
      });

      // Cacher le bouton aprÃ¨s certification
      const btn = document.getElementById("certify-btn");
      if (btn) btn.style.display = "none";

      alert("âœ… Vous Ãªtes maintenant certifiÃ© !");
    } else {
      // Ne pas dÃ©duire, mettre status Ã  false
      await setDoc(verifiedRef, {
        status: false
      });

      alert("ğŸ’¸ Solde insuffisant. Le montant requis est de 18 000 Fcfa.");
    }
  } catch (error) {
    console.error("Erreur de certification :", error);
    alert("âŒ Une erreur est survenue. Veuillez rÃ©essayer.");
  }
};
window.publishMusic = publishMusic;
async function publishMusic() {
  const nom = document.getElementById('nom').value.trim();
  const titre = document.getElementById('titre').value.trim();
  const audioFile = document.getElementById('audioFile').files[0];
  const statusMsg = document.getElementById('statusMsg');
  statusMsg.textContent = '';

  if (!currentUser) {
    return alert("Vous devez Ãªtre connectÃ©.");
  }

  if (!nom || !titre || !audioFile) {
    return alert("Tous les champs sont requis.");
  }

  try {
    const walletRef = doc(db, 'wallets', currentUser.uid);
    const walletSnap = await getDoc(walletRef);

    if (!walletSnap.exists()) {
      return alert("Aucun portefeuille trouvÃ©.");
    }

    const walletData = walletSnap.data();
    const currentBalance = typeof walletData.balance === 'number' ? walletData.balance : 0;

    if (currentBalance < 1500) {
      return alert("Solde insuffisant (minimum requis : 5100).");
    }

    // âœ… DÃ©duire 1500
    await updateDoc(walletRef, {
      balance: currentBalance - 1500
    });

    statusMsg.textContent = "TÃ©lÃ©chargement du fichier audio...";

    const fileName = `${Date.now()}_${audioFile.name}`;
    const storageRef = ref(storage, 'musics/' + fileName);
    await uploadBytes(storageRef, audioFile);
    const audioUrl = await getDownloadURL(storageRef);

    statusMsg.textContent = "Publication en cours...";

    await addDoc(collection(db, 'musfeed'), {
      userId: currentUser.uid,
      nom,
      titre,
      audioUrl,
      createdAt: new Date()
    });

    statusMsg.textContent = "âœ… Musique publiÃ©e avec succÃ¨s.";
    document.getElementById('nom').value = '';
    document.getElementById('titre').value = '';
    document.getElementById('audioFile').value = '';
  } catch (err) {
    console.error("Erreur lors de la publication :", err);
    statusMsg.textContent = "âŒ Erreur lors de la publication.";
  }
}
async function renderMusicFeed() {
  const container = document.getElementById('musicFeed');
  container.textContent = 'Chargementâ€¦';

  try {
    const q = query(collection(db, 'musfeed'), orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    container.innerHTML = '';
    const user = currentUser;

    for (const docSnap of snapshot.docs) {
      const d = docSnap.data();
      const musicId = docSnap.id;

      // ğŸ¯ 1. Ne pas afficher les musiques expirÃ©es (10 jours)
      const createdAt = d.createdAt?.toDate?.() || new Date();
      const now = new Date();
      const ageInMs = now - createdAt;
      const ageInDays = ageInMs / (1000 * 60 * 60 * 24);
      if (ageInDays > 10) continue;

      // ğŸ¯ 2. VÃ©rifie si lâ€™utilisateur a dÃ©jÃ  Ã©coutÃ©
      let alreadyViewed = false;
      if (user) {
        const viewDocRef = doc(db, 'views', `${musicId}_${user.uid}`);
        const viewDocSnap = await getDoc(viewDocRef);
        alreadyViewed = viewDocSnap.exists();
      }

      // ğŸ¯ 3. Si premiÃ¨re Ã©coute : dÃ©duction + ajout des vues
      if (user && !alreadyViewed && user.uid !== d.userId) {
        const walletRef = doc(db, 'wallets', user.uid);
        const walletSnap = await getDoc(walletRef);
        const balance = walletSnap.exists() ? walletSnap.data().balance || 0 : 0;

        if (balance >= 55) {
          // â– DÃ©duire 55
          await updateDoc(walletRef, {
            balance: increment(-55)
          });

          // âœ… Marquer comme Ã©coutÃ©
          const viewDocRef = doc(db, 'views', `${musicId}_${user.uid}`);
          await setDoc(viewDocRef, {
            userId: user.uid,
            musicId,
            playedAt: now
          });

          // â• Ajouter 340 vues dans totalviewcontent
          const statsRef = doc(db, 'totalviewcontent', d.userId);
          await setDoc(statsRef, { views: increment(340) }, { merge: true });

          // Suppression de la mise Ã  jour de totalviews, car on calcule tout depuis totalviewcontent
          // Donc plus de code ici pour totalviews
        } else {
          alert("Solde insuffisant pour Ã©couter cette musique.");
        }
      }

      // ğŸ¯ 4. Affiche le bloc de musique
  const div = document.createElement('div');
div.style.border = '1px solid #ccc';
div.style.borderRadius = '10px';
div.style.padding = '1rem';
div.style.marginBottom = '1rem';

div.innerHTML = `
  <strong>${d.nom} - ${d.titre}</strong><br/>
  <audio controls src="${d.audioUrl}" style="width: 100%; margin-top: 8px;"></audio>
  <div style="margin-top: 10px; font-size: 14px; color: #555; display: flex; align-items: center;">
    <i class="fa-solid fa-headphone" style="margin-right: 6px;"></i>
    <span>${d.views || 0}</span>
  </div>
`;

container.appendChild(div);
    }
  } catch (err) {
    console.error(err);
    container.textContent = 'Erreur de chargement des musiques.';
  }
}
// Appel automatique au chargement
onAuthStateChanged(auth, (user) => {
  currentUser = user;
  renderMusicFeed();
});
const boutonLundi = document.getElementById('bouton-lundi');
    const maintenant = new Date();
    const jour = maintenant.getDay(); // 0 = dimanche, 1 = lundi, ..., 6 = samedi

    if (jour === 1) { // Si c'est lundi
        boutonLundi.style.display = 'block'; // Afficher le bouton
    }
else {
  const sms = document.getElementById('s');
  sms.innerText = 'Revenez lundi pour partager votre musique';
  }
window.sendResetLink = async () => {
  const email = document.getElementById('resetEmail').value.trim();
  if (!email) return alert("Veuillez entrer votre email");

  try {
    await sendPasswordResetEmail(auth, email);
    alert("ğŸ“© Un lien de rÃ©initialisation a Ã©tÃ© envoyÃ© Ã  votre email");
  } catch (err) {
    console.error("Erreur:", err);
    alert("âŒ " + err.message);
  }
};
</script>
</body>
</html>
