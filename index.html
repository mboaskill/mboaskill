<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mboa Skills</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* === GLOBAL STYLES ================================= */
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background-image:url('https://ucarecdn.com/ff597083-3c69-4040-8b93-1cb2c38ac703/-/preview/1000x999/');
    }
    header{
      position:fixed;top:0;left:0;right:0;
      display:flex;justify-content:space-around;align-items:center;
      padding:1rem;background:#fff;border-bottom:1px solid #ddd;z-index:9999
    }
    header i{font-size:1.4rem;color:#888;cursor:pointer}
    header i.selected{color:#1877f2}
    .tabcontent{display:none;padding:6rem 1rem 1rem;max-width:600px;margin:auto}
    .tabcontent.active{display:block}
    input,textarea,button,select{
      display:block;width:100%;padding:10px;margin-bottom:10px;
      border:1px solid #ccc;border-radius:6px;font-size:14px;box-sizing:border-box
    }
    button{background:#1877f2;color:#fff;font-weight:bold;border:none;border-radius:6px;cursor:pointer}
    button:hover{background:#145ec1}

    /* === POST CARD ===================================== */
    .post{
      background:#fff;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,.1);
      padding:1rem;margin-bottom:1rem
    }
    .post-header{display:flex;align-items:center}
    .post-header img{width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;cursor:pointer}
    .post-header span.username{font-weight:bold;cursor:pointer;color:#1877f2;}
    .post-content{margin-top:10px}
    .post video,.post .text-bg{width:100%;border-radius:10px;margin-top:10px}
    .text-bg{
      display:inline-block;padding:.5rem 1rem;font-weight:bold;color:#fff;
      text-align:center;white-space:pre-wrap;max-width:90%
    }
    .post-actions{margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .post-actions i{cursor:pointer;font-size:1.2rem}
    .like.liked{color:#1877f2}
    .boost-btn{background:#ffa500;color:#fff;padding:5px 10px;font-weight:bold;border-radius:6px;border:none;cursor:pointer}

    /* === COMMENTS ===================================== */
    .comments-section{margin-top:30px;border-top:1px solid #ccc;padding-top:10px;max-height:150px;overflow-y:auto;direction:ltr}
    .comment{direction:ltr;unicode-bidi:plaintext;text-align:left;word-break:break-word}
    .comment strong{color:#1877f2}
    .comment-input{display:flex;gap:14px;margin-top:14px}
    .comment-input input{flex:1;height:30px;padding:12px;border-radius:5px;border:1px solid #ccc;font-size:14px;width:100px;height:60px;}
    .comment-input button{padding:5px 9px;background:#1877f2;color:#fff;border:none;border-radius:8px;cursor:pointer}

    /* === ACCOUNT FORMS ================================= */
    #emailLoginBox,#emailSignupBox{
      background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,.1);margin-bottom:15px
    }
    #emailLoginBox input,#emailSignupBox input{margin-bottom:10px}
    #emailLoginBox button,#emailSignupBox button{background:#1877f2;color:#fff;border:none;padding:10px;font-weight:bold;border-radius:6px;cursor:pointer;width:100%}
    #emailLoginBox button:hover,#emailSignupBox button:hover{background:#145ec1}
    #accountStatus{margin-top:10px;font-weight:bold;color:#1877f2}
    #authStatus{margin-top:10px;font-weight:bold;color:limegreen}

    /* === USER FEED ==================================== */
    #userFeedContent .post{/* inherits .post styles */}
  </style>
</head>

<body>

<header>
  <i class="fas fa-home tablinks selected"  onclick="openTab(event,'home')"></i>
  <i class="fas fa-coins tablinks"           onclick="openTab(event,'totalViewsSection')"></i>
  <i class="fas fa-video tablinks"           onclick="openTab(event,'videoFeed')"></i>
  <i class="fas fa-plus tablinks"            onclick="openTab(event,'post')"></i>
  <i class="fas fa-search tablinks"          onclick="openTab(event,'search')"></i>
  <i class="fas fa-user tablinks"            onclick="openTab(event,'account')"></i>
</header>

<!-- ============ HOME ============ -->
<section id="home" class="tabcontent active">
  <div class="post-header">
    <img id="homeProfilePhoto" src="https://via.placeholder.com/40" onclick="openTab(event,'feedme')"/>
    <p id="authStatus"></p>
    <p id="accountStatus"></p>
  </div>
  <div id="feed"></div>
</section>

<!-- ============ POST ============ -->
<section id="post" class="tabcontent">
  <h3>Cr√©er une publication</h3>
  <textarea id="postText" placeholder="Exprimez-vous..."></textarea>
  <input type="color" id="bgColor" value="#1877f2" />
  <hr/>
  <input type="text" id="videoTitle" placeholder="Titre de la vid√©o" />
  <input type="file" id="videoFile" accept="video/*" />
  <button onclick="publishPost()">Publier</button>
  <p id="status"></p>
</section>

<!-- ============ VIDEO FEED ============ -->
<section id="videoFeed" class="tabcontent">
  <h3>Publications avec vid√©os</h3>
  <div id="videoFeedContent"></div>
</section>

<!-- ============ TOTAL VIEWS ============ -->
<section id="totalViewsSection" class="tabcontent">
  <h3>Total des vues (7 derniers jours)</h3>
  <p id="totalViewsCount">Chargement...</p>
  <p id="currentBalance">Solde actuel: 0 FCFA</p>
  <input type="number" id="withdrawAmount" placeholder="Montant √† retirer (min 50 FCFA)" min="50" />
  <button onclick="withdrawBalance()">Retirer</button>
  <p id="withdrawStatus"></p>
</section>

<!-- ============ SEARCH ============ -->
<section id="search" class="tabcontent">
  <h3>Rechercher un utilisateur</h3>
  <input type="text" id="searchUserInput" placeholder="Nom ou e-mail de l'utilisateur" />
  <button onclick="searchUser()">Rechercher</button>
  <div id="searchResults"></div>
</section>

<!-- ============ ACCOUNT ============ -->
<section id="account" class="tabcontent">
  <div class="post-header">
    <button onclick="openTab(event,'conect')">Connexion</button>
    <button onclick="openTab(event,'inscrip')">Inscription</button>
  </div>
  <hr>
  <button onclick="signInWithGoogle()"><i class="fab fa-google"></i> Connexion par Google</button>
  <hr/>
  <button onclick="signOutUser()" style="background-color:red">Se d√©connecter</button>
  <br/><br/>
  <u><a href="https://www.facebook.com/profile.php?id=61577616822265">contact support</a> <i class="fab fa-facebook" style="color:#1877f2"></i></u>
</section>

<!-- ============ FEEDME (MY FEED) ============ -->
<section id="feedme" class="tabcontent">
  <h3>Mes publications</h3>
  <div class="post-header">
    <img id="feedmeProfilePhoto" src="https://via.placeholder.com/40" />
    <p id="accountStatusFeed"></p>
    <label for="profilePhotoInput" title="Changer la photo"><i class="fas fa-plus" style="cursor:pointer"></i></label>
    <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" />
  </div>
  <div id="myFeed"></div>
</section>

<!-- ============ BOOST VIDEO LIST ============ -->
<section id="video" class="tabcontent">
  <div id="videoFeedContentBoost"></div>
</section>

<!-- ============ BOOST PANEL ============ -->
<section id="vibo" class="tabcontent">
  <h3>Booster une publication</h3>
  <div class="post-header">
    <input type="number" id="montant" placeholder="Entrez le montant" />
    <button id="deposer">D√©poser</button>
  </div>
  <p>Argent: <span id="argent">0</span> XAF</p>

  <div id="boostPanel" style="display:none;margin-bottom:10px">
    <span id="boostStatus" style="font-weight:bold"></span>
    <input type="number" id="boostViews" placeholder="Nombre de vues √† acheter" min="1" />
    <button onclick="boostPost()">Booster</button>
  </div>
</section>

<!-- ============ LOGIN FORM ============ -->
<section id="conect" class="tabcontent">
  <h3>Connectez-vous</h3>
  <div id="emailLoginBox">
    <input type="email"    id="loginEmail"    placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Mot de passe" />
    <button onclick="loginWithEmail()">Se connecter</button>
  </div>
</section>

<!-- ============ SIGNUP FORM ============ -->
<section id="inscrip" class="tabcontent">
  <h3>Inscription</h3>
  <div id="emailSignupBox">
    <input type="text"     id="signupName"     placeholder="Nom complet" />
    <input type="email"    id="signupEmail"    placeholder="Email" />
    <input type="password" id="signupPassword" placeholder="Mot de passe (‚â• 6 car.)" />
    <input type="number"   id="signupAge"      placeholder="√Çge (min 18)" min="18" />
    <button onclick="signupWithEmail()">S‚Äôinscrire</button>
  </div>
</section>

<!-- ============ OTHER USER FEED ============ -->
<section id="userFeed" class="tabcontent">
  <h3 id="userFeedTitle">Publications de ‚Ä¶</h3>
  <div id="userFeedContent"></div>
</section>
<script type="module">
/* ------------------------------------------------------------------
   1. IMPORTS FIREBASE
------------------------------------------------------------------ */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
import {
  getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider,
  updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
import {
  getFirestore,
  collection, addDoc, onSnapshot, query, orderBy, where,
  doc, getDocs, getDoc, setDoc, updateDoc,
  increment, serverTimestamp,
  deleteDoc, limit,
  runTransaction
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js';

/* ------------------------------------------------------------------
   2. CONFIGURATION FIREBASE + VARIABLES GLOBALES
------------------------------------------------------------------ */
const firebaseConfig = {
  apiKey:            "AIzaSyClSjd2LrIQpaJoVWO32vFRx7I9cvmDgBo",
  authDomain:        "mboa-ec602.firebaseapp.com",
  projectId:         "mboa-ec602",
  storageBucket:     "mboa-ec602.appspot.com",
  messagingSenderId: "498505132403",
  appId:             "1:498505132403:web:eb46547745f8d1a77b3d06"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const stg  = getStorage(app);
const provider = new GoogleAuthProvider();

let currentUser    = null;
let likedPosts     = new Set();
let boostId        = '';
let currentBalance = 0;

const qs  = id => document.getElementById(id);
const fmt = n => n>=1e6 ? (n/1e6).toFixed(1)+'M' : n>=1e3 ? (n/1e3).toFixed(1)+'k' : n;

/* ------------------------------------------------------------------
   3. EVENT LISTENERS D√âPENDANT DU DOM
------------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', () => {
  /* Listener sur le bouton D√©poser */
  qs('deposer')?.addEventListener('click', () => {
    const montant = parseFloat(qs('montant').value);
    if (isNaN(montant)) return alert('Entrez un montant');
    deposit(montant);
    qs('montant').value = '';
  });
});

/* ------------------------------------------------------------------
   4. NAVIGATION PAR ONGLET
------------------------------------------------------------------ */
window.openTab = (evt, id) => {
  [...document.querySelectorAll('.tabcontent')]
    .forEach(t => t.classList.toggle('active', t.id === id));
  [...document.querySelectorAll('.tablinks')]
    .forEach(l => l.classList.toggle('selected', l === evt.currentTarget));
  history.pushState({tab:id},'',`#${id}`);
};
window.onpopstate = e=>{
  const tab=e.state?.tab||'home';
  const icon=document.querySelector(`.tablinks[onclick*="'${tab}'"]`)
             || document.querySelector('.tablinks');
  if(icon)openTab({currentTarget:icon},tab);
};

/* ------------------------------------------------------------------
   5. AUTHENTIFICATION
------------------------------------------------------------------ */
window.signInWithGoogle = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
window.signOutUser      = () => signOut(auth);

onAuthStateChanged(auth, async user => {
  currentUser = user;

  const photo  = user?.photoURL || 'https://ucarecdn.com/d98b5778-d5ca-4460-bff0-3b1b423117cd/-/preview/100x100/';
  qs('homeProfilePhoto').src   = photo;
  qs('feedmeProfilePhoto').src = photo;

  qs('authStatus').textContent        = user ? ` ${user.displayName || user.email}` : '';
  qs('accountStatus').textContent     = user ? `‚Ä¢ ${user.displayName || user.email}` : '';
  qs('accountStatusFeed').textContent = qs('accountStatus').textContent;

  if (user) {
    await loadWallet();
    await loadLikedPosts();
    renderFeed();
    renderMyFeed();
    renderVideoFeed();
    renderBoostFeed();
    await loadTotalViewsAndBalance();
  } else {
    likedPosts.clear();
    ['feed','myFeed','videoFeedContent','videoFeedContentBoost','userFeedContent']
      .forEach(id => qs(id).innerHTML = '');
    qs('totalViewsCount').textContent = '';
    qs('currentBalance').textContent  = 'Solde actuel: 0 FCFA';
  }
});

/* ------------------------------------------------------------------
   6. PHOTO DE PROFIL
------------------------------------------------------------------ */
qs('profilePhotoInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file || !currentUser) return alert('Connectez-vous');

  const r = ref(stg, `profile_photos/${currentUser.uid}_${Date.now()}`);
  uploadBytesResumable(r, file).on(
    'state_changed',
    null,
    err => alert(err.message),
    async snap => {
      const url = await getDownloadURL(snap.ref);
      await updateProfile(currentUser, {photoURL: url});
      location.reload();
    }
  );
});

/* ------------------------------------------------------------------
   7. WALLET : D√âP√îT + CHARGEMENT
------------------------------------------------------------------ */
async function loadWallet() {
  if (!currentUser) return;
  const snap = await getDoc(doc(db, 'wallets', currentUser.uid));
  const bal  = snap.exists() ? snap.data().balance : 0;
  qs('argent').textContent = bal.toFixed(0);
  return bal;
}

async function deposit(amount) {
  if (!currentUser) return alert('Connectez-vous');
  if (amount < 1900)   return alert('Montant minimum 1 900 FCFA');

  const ref = doc(db, 'wallets', currentUser.uid);
  await runTransaction(db, async t => {
    const snap = await t.get(ref);
    const bal  = snap.exists() ? snap.data().balance : 0;
    t.set(ref, { balance: bal + amount }, { merge: true });
  });

  await loadWallet();                               // refresh UI
}

/* ------------------------------------------------------------------
   8. PUBLISH POST (texte ou vid√©o)
------------------------------------------------------------------ */
window.publishPost = async () => {
  if (!currentUser) return alert('Connectez-vous');
  const text     = qs('postText').value.trim();
  const bgColor  = qs('bgColor').value;
  const vidFile  = qs('videoFile').files[0];
  const vidTitle = qs('videoTitle').value.trim();

  if (!text && !vidFile) return alert('Ajoutez un texte ou une vid√©o');
  qs('status').textContent = 'Publication‚Ä¶';

  const data = {
    userId   : currentUser.uid,
    userEmail: currentUser.email,
    userName : currentUser.displayName || currentUser.email,
    userPhoto: currentUser.photoURL   || 'https://via.placeholder.com/40',
    text,
    bgColor,
    videoUrl : null,
    videoTitle: vidTitle,
    views   : 0,
    likes   : 0,
    createdAt: serverTimestamp(),
    boosted : 0
  };
  const reset = () => {
    ['postText','videoTitle'].forEach(id => qs(id).value = '');
    qs('videoFile').value = '';
    qs('status').textContent = 'Publi√© !';
  };

  if (vidFile) {
    const r = ref(stg, `videos/${Date.now()}_${vidFile.name}`);
    uploadBytesResumable(r, vidFile).on(
      'state_changed',
      s => qs('status').textContent = `${Math.floor(s.bytesTransferred/s.totalBytes*100)}%`,
      err => alert(err.message),
      async s => {
        data.videoUrl = await getDownloadURL(s.ref);
        await addDoc(collection(db, 'posts'), data);
        reset();
      }
    );
  } else {
    await addDoc(collection(db, 'posts'), data);
    reset();
  }
};

/* ------------------------------------------------------------------
   9. FEEDS (HOME / MY / VIDEO / BOOST)
------------------------------------------------------------------ */
function renderFeed() {
  const c = qs('feed');
  c.textContent = 'Chargement‚Ä¶';
  onSnapshot(
    query(collection(db,'posts'), orderBy('boosted','desc'), orderBy('createdAt','desc')),
    snap => { c.innerHTML=''; snap.forEach(d => c.appendChild(card(d.id,d.data(),false))); },
    err  => { c.textContent = 'Erreur : '+err.message; console.error(err); }
  );
}
function renderMyFeed() {
  if (!currentUser) return;
  const c = qs('myFeed'); c.textContent='Chargement‚Ä¶';
  onSnapshot(
    query(collection(db,'posts'), where('userId','==',currentUser.uid), orderBy('createdAt','desc')),
    snap => { c.innerHTML=''; snap.forEach(d => c.appendChild(card(d.id,d.data(),true))); }
  );
}
function renderVideoFeed() {
  const c = qs('videoFeedContent'); c.textContent='Chargement‚Ä¶';
  onSnapshot(
    query(collection(db,'posts'), where('videoUrl','!=',null), orderBy('createdAt','desc')),
    snap => { c.innerHTML=''; snap.forEach(d => c.appendChild(card(d.id,d.data(),false))); }
  );
}
function renderBoostFeed() {
  if (!currentUser) return;
  const c = qs('videoFeedContentBoost'); c.textContent='Chargement‚Ä¶';
  onSnapshot(
    query(
      collection(db,'posts'),
      where('userId','==',currentUser.uid),
      where('videoUrl','!=',null),
      orderBy('createdAt','desc')
    ),
    snap => { c.innerHTML=''; snap.forEach(d => c.appendChild(card(d.id,d.data(),true))); }
  );
}

/* ------------------------------------------------------------------
 10. CARD BUILDER + LIKE + COMMENTS
------------------------------------------------------------------ */
function card(id,d,isMine){
  const w=document.createElement('div');w.className='post';
  /* header */
  w.innerHTML=`<div class="post-header">
      <img src="${d.userPhoto}" alt="pp">
      <span class="username" data-uid="${d.userId}">${d.userName||d.userEmail}</span>
      ${d.boosted>0?'<span style="margin-left:auto;color:#ffa500;font-size:12px;font-weight:bold">Sponsoris√©</span>':''}
    </div>`;
  /* content */
  const cont=document.createElement('div');cont.className='post-content';
  if(d.videoUrl){
    cont.innerHTML=`<video src="${d.videoUrl}" controls></video>${d.videoTitle?`<div style="font-weight:bold">${d.videoTitle}</div>`:''}`;
  }else if(d.text){
    cont.innerHTML=`<div class="text-bg" style="background:${d.bgColor}">${d.text}</div>`;
  }
  w.appendChild(cont);
  /* actions */
  const act=document.createElement('div');act.className='post-actions';
  const like=document.createElement('i');like.className='fa-regular fa-thumbs-up like';
  if(likedPosts.has(id))like.classList.add('liked');
  const lCnt=document.createElement('span');lCnt.textContent=fmt(d.likes||0);
  like.onclick=()=>toggleLike(id,like,lCnt);
  act.append(like,lCnt);
  const vCnt=document.createElement('span');vCnt.textContent=`üëÅÔ∏è ${fmt((d.views||0)+(d.boosted||0))}`;
  act.appendChild(vCnt);
  const comI=document.createElement('i');comI.className='fa-regular fa-comment';
  const comCnt=document.createElement('span');comCnt.textContent=' ‚Ä¶ ';
  act.append(comI,comCnt);
  if(isMine){
    const b=document.createElement('button');b.className='boost-btn';b.textContent='Booster';
    b.onclick=()=>selectBoostPost(id,d.text||d.videoTitle||'Sans titre');
    act.appendChild(b);
  }
  w.appendChild(act);
  /* comments */
  const comSec=document.createElement('div');comSec.className='comments-section';comSec.style.display='none';
  const comList=document.createElement('div');comSec.appendChild(comList);
  if(currentUser){
    const div=document.createElement('div');div.className='comment-input';
    const inp=document.createElement('input');inp.placeholder='Ajouter un commentaire...';
    const btn=document.createElement('button');btn.textContent='Envoyer';
    btn.onclick=()=>{const t=inp.value.trim();if(!t)return;addComment(id,t);inp.value='';};
    div.append(inp,btn);comSec.appendChild(div);
  }
  w.appendChild(comSec);
  comI.onclick=()=>{comSec.style.display=comSec.style.display==='none'?'block':'none'; if(comSec.style.display==='block')loadComments(id,comList,comCnt);};
  w.querySelector('.username').onclick=e=>openUserFeed(e.target.dataset.uid);
  return w;
}
/* LIKE */
async function loadLikedPosts(){likedPosts.clear();}
async function toggleLike(pid,icon,cnt){
  if(!currentUser)return alert('Connectez-vous');
  const ref=doc(db,'posts',pid);
  if(likedPosts.has(pid)){
    likedPosts.delete(pid);icon.classList.remove('liked');await updateDoc(ref,{likes:increment(-1)});
  }else{
    likedPosts.add(pid);icon.classList.add('liked');await updateDoc(ref,{likes:increment(1)});
  }
  const s=await getDoc(ref);cnt.textContent=fmt(s.data().likes||0);
}
/* COMMENTS */
async function loadComments(pid,container,cnt){
  const s=await getDocs(query(collection(db,'posts',pid,'comments'),orderBy('createdAt')));
  container.innerHTML='';cnt.textContent=s.size;
  s.forEach(d=>{const c=d.data();const div=document.createElement('div');div.className='comment';
                div.innerHTML=`<strong>${c.userName}</strong> : ${c.text}`;container.appendChild(div);});
}
async function addComment(pid,text){
  if(!currentUser)return;
  await addDoc(collection(db,'posts',pid,'comments'),{
    userId:currentUser.uid,userName:currentUser.displayName||currentUser.email,
    text,createdAt:serverTimestamp()
  });
}

/* ------------------------------------------------------------------
 11. BOOST (s√©lection + paiement)
------------------------------------------------------------------ */
function selectBoostPost(pid,title){
  boostId=pid;
  qs('boostStatus').textContent=`1 publication s√©lectionn√©e : ${title}`;
  qs('boostPanel').style.display='block';
  openTab({currentTarget:document.querySelector('.tablinks[onclick*="vibo"]')},'vibo');
}

async function debit(cost){
  if(!currentUser)return false;
  const ref=doc(db,'wallets',currentUser.uid);
  const ok=await runTransaction(db,async t=>{
    const snap=await t.get(ref);
    const bal=snap.exists()?snap.data().balance:0;
    if(bal<cost)return false;
    t.update(ref,{balance:bal-cost});
    return true;
  });
  if(!ok)alert('Solde insuffisant');
  await loadWallet();
  return ok;
}

window.boostPost=async()=>{
  if(!boostId)return alert('Choisissez une publication');
  const vues=parseInt(qs('boostViews').value);
  if(isNaN(vues)||vues<1000)return alert('Min 1 000 vues');
  const cost=Math.ceil(vues/1000)*250;
  if(!(await debit(cost)))return;
  try{
    await updateDoc(doc(db,'posts',boostId),{boosted:increment(vues),views:increment(vues)});
    qs('boostStatus').textContent=`Boost OK (‚àí${cost} XAF)`;
    qs('boostViews').value='';boostId='';
    renderFeed();renderMyFeed();await loadTotalViewsAndBalance();
  }catch(e){alert('Erreur boost : '+e.message);await deposit(cost);}
};

/* ------------------------------------------------------------------
 12. USER FEED & SEARCH
------------------------------------------------------------------ */
window.openUserFeed=async uid=>{
  openTab({currentTarget:document.querySelector('.tablinks[onclick*="home"]')},'userFeed');
  const cont=qs('userFeedContent'),title=qs('userFeedTitle');cont.textContent='Chargement‚Ä¶';
  let name='Utilisateur',photo='https://via.placeholder.com/40';
  const last=await getDocs(query(collection(db,'posts'),where('userId','==',uid),orderBy('createdAt','desc'),limit(1)));
  if(!last.empty){const d=last.docs[0].data();name=d.userName||name;photo=d.userPhoto||photo;}
  title.innerHTML=`<img src="${photo}" style="width:40px;height:40px;border-radius:50%;vertical-align:middle;margin-right:8px">Publications de <strong>${name}</strong>`;
  onSnapshot(query(collection(db,'posts'),where('userId','==',uid),orderBy('createdAt','desc')),snap=>{
    cont.innerHTML='';snap.empty?cont.textContent='Aucune publication.':snap.forEach(d=>cont.appendChild(card(d.id,d.data(),false)));
  });
};

window.searchUser=async()=>{
  const qstr=qs('searchUserInput').value.trim().toLowerCase();
  if(!qstr)return alert('Entrez un nom ou e-mail');
  const s=await getDocs(collection(db,'posts'));const map=new Map();
  s.forEach(d=>{const v=d.data();if((v.userName||'').toLowerCase().includes(qstr)||(v.userEmail||'').toLowerCase().includes(qstr))
     map.set(v.userId,{uid:v.userId,name:v.userName,email:v.userEmail,photo:v.userPhoto});});
  const res=qs('searchResults');res.innerHTML='';
  if(map.size===0)return res.textContent='Aucun utilisateur trouv√©';
  map.forEach(u=>{
    const d=document.createElement('div');d.style.cursor='pointer';d.style.display='flex';d.style.alignItems='center';d.style.marginBottom='8px';
    const img=document.createElement('img');img.src=u.photo||'https://via.placeholder.com/40';img.style.width='40px';img.style.height='40px';img.style.borderRadius='50%';img.style.marginRight='10px';
    const sp=document.createElement('span');sp.textContent=u.name||u.email;sp.style.color='#1877f2';sp.style.fontWeight='bold';
    d.append(img,sp);d.onclick=()=>openUserFeed(u.uid);res.appendChild(d);
  });
};

/* ------------------------------------------------------------------
 13. VUES 7 JOURS & RETRAIT
------------------------------------------------------------------ */
async function loadTotalViewsAndBalance(){
  if(!currentUser)return;
  const snap=await getDocs(
    query(collection(db,'posts'),where('userId','==',currentUser.uid),where('createdAt','>=',new Date(Date.now()-6048e5)))
  );
  let total=0;
  snap.forEach(d=>{const v=d.data();total+=(v.views||0)+(v.boosted||0);});
  qs('totalViewsCount').textContent=fmt(total);
  currentBalance=Math.floor(total/1000)*50;
  qs('currentBalance').textContent=`Solde actuel: ${currentBalance} FCFA`;
}

window.withdrawBalance=async()=>{
  const amt=qs('withdrawAmount').valueAsNumber;
  if(!Number.isFinite(amt)||amt<5000)return alert('Montant minimum 5 000 FCFA');
  if(amt>currentBalance)return alert('Solde insuffisant');
  currentBalance-=amt;
  qs('currentBalance').textContent=`Solde actuel: ${currentBalance} FCFA`;
  qs('withdrawAmount').value='';
  alert(`Retrait de ${amt} FCFA effectu√© !`);
};

/* ------------------------------------------------------------------
 14. INSCRIPTION / CONNEXION E-MAIL
------------------------------------------------------------------ */
window.signupWithEmail=async()=>{
  const name=qs('signupName').value.trim(),email=qs('signupEmail').value.trim(),pass=qs('signupPassword').value,
        age=parseInt(qs('signupAge').value,10);
  if(!name||!email||!pass||isNaN(age))return alert('Veuillez remplir tous les champs');
  if(age<18)return alert('Vous devez avoir au minimum 18 ans');
  if(pass.length<6)return alert('Mot de passe ‚â• 6 caract√®res');
  try{
    const c=await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(c.user,{displayName:name});
    location.reload();
  }catch(e){alert(e.message);}
};
window.loginWithEmail=async()=>{
  const email=qs('loginEmail').value.trim(),pass=qs('loginPassword').value;
  if(!email||!pass)return alert('Entrez e-mail et mot de passe');
  try{await signInWithEmailAndPassword(auth,email,pass);location.reload();}
  catch(e){alert(e.message);}
};
</script>
</body>
</html>