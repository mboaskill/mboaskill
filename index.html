<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mboa Skills</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
    }
    header {
      background-color: #fff;
      position: fixed;
      top: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      z-index: 9999;
    }
    header i {
      font-size: 1.4rem;
      color: #888;
      cursor: pointer;
    }
    header i.selected {
      color: #1877f2;
    }
    .tabcontent {
      display: none;
      padding: 6rem 1rem 1rem;
      max-width: 600px;
      margin: auto;
    }
    .tabcontent.active {
      display: block;
    }
    input, textarea, button, select {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      background-color: #1877f2;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      border-radius: 6px;
    }
    button:hover {
      background-color: #145ec1;
    }
    .post {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
      width: 100%;
      word-break: break-word;
    }
    .post-header {
      display: flex;
      align-items: center;
      width: 100%;
    }
    .post-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }
    .post-content {
      margin-top: 10px;
    }
    .post video, .post .text-bg {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }
    .text-bg {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #333;
      color: white;
      font-weight: bold;
      text-align: center;
      white-space: pre-wrap;
      border-radius: 10px;
      max-width: 90%;
    }
    .post-actions {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .post-actions i {
      cursor: pointer;
      font-size: 1.2rem;
    }
    .like.liked {
      color: #1877f2;
    }
    .post-actions button.boost-btn {
      background-color: #ffa500;
      color: white;
      padding: 5px 10px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    textarea {
      border-radius: 15px;
      font-size: 15px;
    }
    .comments-section {
      margin-top: 10px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    .comment {
      background: #eee;
      padding: 5px 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .comment strong {
      color: #1877f2;
    }
    .comment-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .comment-input input {
      flex-grow: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .comment-input button {
      padding: 8px 16px;
      background-color: #1877f2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #boostStatus {
      font-weight: bold;
      color: #1877f2;
      margin-bottom: 10px;
    }
    #totalViewsSection p {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <i class="fas fa-home tablinks selected" onclick="openTab(event, 'home')"></i>
        <i class="fas fa-coins tablinks" onclick="openTab(event, 'totalViewsSection')"></i>
    <i class="fas fa-video tablinks" onclick="openTab(event, 'videoFeed')"></i>
    <i class="fas fa-plus tablinks" onclick="openTab(event, 'post')"></i>
    <i class="fas fa-search tablinks" onclick="openTab(event, 'search')"></i>
    <i class="fas fa-user tablinks" onclick="openTab(event, 'account')"></i>
  </header>

  <section id="home" class="tabcontent active">
    <div class="post-header">
      <img id="homeProfilePhoto" src="https://via.placeholder.com/40" onclick="openTab(event, 'feedme')" />
      <p id="authStatus"></p>
      <i class="fas fa-plus tablinks" onclick="openTab(event, 'post')"></i>
    </div>
    <div id="feed"></div>
  </section>

  <section id="video" class="tabcontent">
    <h3>Booster une publication</h3>
    <p id="boostStatus">Aucune publication sélectionnée</p>
    <select id="boostViews">
      <option value="1000">1000 vues</option>
      <option value="2000">2000 vues</option>
      <option value="5000">5000 vues</option>
    </select>
    <button onclick="boostPost()">Booster</button>
  </section>

  <section id="post" class="tabcontent">
    <h3>Créer une publication</h3>
    <textarea id="postText" placeholder="Exprimez-vous..."></textarea>
    <input type="color" id="bgColor" value="#1877f2" />
    <hr />
    <input type="text" id="videoTitle" placeholder="Titre de la vidéo" />
    <input type="file" id="videoFile" accept="video/*" />
    <button onclick="publishPost()">Publier</button>
    <p id="status"></p>
  </section>

  <section id="account" class="tabcontent">
    <h3>Connexion</h3>
    <button onclick="signInWithGoogle()"><i class="fab fa-google"></i> Connexion/inscription Google</button>
    <hr />
    <button onclick="signOutUser()">Se déconnecter</button>
    <b id="authStatus"></b>
  </section>

  <section id="feedme" class="tabcontent">
    <h3>Mes publications:</h3>
    <div class="post-header">
      <img id="feedmeProfilePhoto" src="https://via.placeholder.com/40" />
      <label for="profilePhotoInput" title="Changer la photo de profil">
        <i class="fas fa-plus" style="cursor:pointer;"></i>
      </label>
      <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" />
    </div>
    <div id="myFeed"></div>
  </section>

  <section id="search" class="tabcontent">
    <h3>Rechercher un utilisateur</h3>
    <input type="text" id="searchUserInput" placeholder="Nom ou email de l'utilisateur" />
    <button onclick="searchUser()">Rechercher</button>
    <div id="searchResults"></div>
  </section>

  <section id="userFeedSection" class="tabcontent">
    <h3 id="userFeedTitle">Publications de l'utilisateur</h3>
    <div id="userFeed"></div>
  </section>

  <section id="videoFeed" class="tabcontent">
    <h3>Publications avec vidéos</h3>
    <div id="videoFeedContent"></div>
  </section>

<section id="totalViewsSection" class="tabcontent">
  <h3>Total des vues 7 derniers jours:</h3>
  
  <!-- Affichage du nombre de vues -->
  <p id="totalViewsCount">Chargement...</p>
  
  <!-- Affichage du solde actuel -->
  <p id="currentBalance">Solde actuel: 0 FCFA</p>

  <!-- Champ pour saisir un montant à retirer -->
  <input
    type="number"
    id="withdrawAmount"
    placeholder="Montant à retirer (FCFA)"
    min="1"
  />

  <!-- Bouton pour retirer -->
  <button onclick="withdrawBalance()">Retirer</button>

  <!-- Message de confirmation ou erreur -->
  <p id="withdrawStatus"></p>
</section>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithPopup, signOut,
  GoogleAuthProvider, updateProfile
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot, query, orderBy,
  updateDoc, doc, increment, getDocs, where, serverTimestamp, setDoc, getDoc
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyClSjd2LrIQpaJoVWO32vFRx7I9cvmDgBo",
  authDomain: "mboa-ec602.firebaseapp.com",
  projectId: "mboa-ec602",
  storageBucket: "mboa-ec602.appspot.com",
  messagingSenderId: "498505132403",
  appId: "1:498505132403:web:eb46547745f8d1a77b3d06"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
let likedPosts = new Set();

onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if (user) {
    document.getElementById("authStatus").innerText = ` ${user.displayName || user.email}`;
    if(user.photoURL) {
      document.getElementById("homeProfilePhoto").src = user.photoURL;
      document.getElementById("feedmeProfilePhoto").src = user.photoURL;
    } else {
      document.getElementById("homeProfilePhoto").src = "https://via.placeholder.com/40";
      document.getElementById("feedmeProfilePhoto").src = "https://via.placeholder.com/40";
    }
    await loadLikedPosts();
    renderFeed();
    renderMyFeed();
    await loadTotalViewsAndBalance();
  } else {
    likedPosts.clear();
    document.getElementById("authStatus").innerText = "";
    document.getElementById("homeProfilePhoto").src = "https://via.placeholder.com/40";
    document.getElementById("feedmeProfilePhoto").src = "https://via.placeholder.com/40";
    document.getElementById("feed").innerHTML = "";
    document.getElementById("myFeed").innerHTML = "<p>Veuillez vous connecter pour voir vos publications.</p>";
    document.getElementById("totalViewsCount").innerText = "Connectez-vous pour voir vos statistiques.";
    document.getElementById("currentBalance").innerText = "Solde actuel: 0 FCFA";
    document.getElementById("withdrawStatus").innerText = "";
    document.getElementById("boostStatus").innerText = "Aucune publication sélectionnée";
    document.getElementById("selectedBoostPostId").value = "";
  }
});

// PROFIL PHOTO UPLOAD
const profilePhotoInput = document.getElementById("profilePhotoInput");
profilePhotoInput.addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  if (!currentUser) {
    alert("Connectez-vous d'abord.");
    return;
  }

  const fileRef = ref(storage, `profile_photos/${currentUser.uid}_${Date.now()}`);
  const uploadTask = uploadBytesResumable(fileRef, file);

  uploadTask.on("state_changed", null, (error) => {
    console.error("Erreur d'envoi de l'image :", error);
    alert("Échec de l'envoi de la photo.");
  }, async () => {
    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

    try {
      await updateProfile(currentUser, { photoURL: downloadURL });
      alert("Photo de profil mise à jour !");
      location.reload();
    } catch (error) {
      console.error("Erreur de mise à jour du profil :", error);
      alert("Erreur lors de la mise à jour de la photo.");
    }
  });
});

// SIGN IN / OUT
window.signInWithGoogle = async function () {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    document.getElementById("authStatus").innerText = ` ${user.displayName || user.email}`;
  } catch (error) {
    console.error("Erreur Google Auth:", error);
    document.getElementById("authStatus").innerText = error.message;
  }
};

window.signOutUser = async function () {
  await signOut(auth);
  likedPosts.clear();
  document.getElementById("authStatus").innerText = "Déconnecté.";
  document.getElementById("feed").innerHTML = "";
  document.getElementById("myFeed").innerHTML = "<p>Veuillez vous connecter pour voir vos publications.</p>";
  document.getElementById("boostStatus").innerText = "Aucune publication sélectionnée";
  document.getElementById("selectedBoostPostId").value = "";
  document.getElementById("totalViewsCount").innerText = "";
  document.getElementById("currentBalance").innerText = "Solde actuel: 0 FCFA";
  document.getElementById("withdrawStatus").innerText = "";
};

// PUBLICATION
window.publishPost = async function () {
  if (!currentUser) return alert("Connectez-vous pour publier.");
  const text = document.getElementById("postText").value.trim();
  const bgColor = document.getElementById("bgColor").value;
  const video = document.getElementById("videoFile").files[0];
  const videoTitle = document.getElementById("videoTitle").value.trim();
  if (!text && !video) return alert("Ajoutez un texte ou une vidéo.");

  document.getElementById("status").innerText = "Publication en cours...";

  const postData = {
    userEmail: currentUser.email,
    userId: currentUser.uid,
    userName: currentUser.displayName || currentUser.email,
    userPhoto: currentUser.photoURL || "https://via.placeholder.com/40",
    text,
    bgColor,
    videoUrl: null,
    videoTitle,
    views: 0,
    likes: 0,
    createdAt: serverTimestamp(),
    boosted: 0
  };

  if (video) {
    const refV = ref(storage, `videos/${Date.now()}_${video.name}`);
    const uploadTask = uploadBytesResumable(refV, video);

    uploadTask.on(
      "state_changed",
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        document.getElementById("status").innerText = `Téléchargement : ${Math.floor(progress)}%`;
      },
      (error) => {
        console.error("Erreur upload :", error);
        alert("Erreur pendant l'envoi de la vidéo.");
        document.getElementById("status").innerText = "";
      },
      async () => {
        postData.videoUrl = await getDownloadURL(uploadTask.snapshot.ref);
        await addDoc(collection(db, "posts"), postData);
        document.getElementById("status").innerText = "Publication réussie.";
        document.getElementById("postText").value = "";
        document.getElementById("videoFile").value = "";
        document.getElementById("videoTitle").value = "";
      }
    );
  } else {
    await addDoc(collection(db, "posts"), postData);
    document.getElementById("status").innerText = "Publication réussie.";
    document.getElementById("postText").value = "";
  }
};

// UTILITAIRES
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

window.openTab = function (evt, tabName) {
  const tabcontents = document.getElementsByClassName("tabcontent");
  for (const tabcontent of tabcontents) {
    tabcontent.classList.remove("active");
  }
  const tablinks = document.getElementsByClassName("tablinks");
  for (const tablink of tablinks) {
    tablink.classList.remove("selected");
  }
  document.getElementById(tabName).classList.add("active");
  evt.currentTarget.classList.add("selected");
};

// Chargement des posts (fil général)
async function renderFeed() {
  const feed = document.getElementById("feed");
  feed.innerHTML = "Chargement...";
  const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    feed.innerHTML = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      feed.appendChild(createPostElement(docSnap.id, data, false));
    });
  });
}

// Chargement des posts de l'utilisateur connecté (feedme)
async function renderMyFeed() {
  if (!currentUser) return;
  const myFeed = document.getElementById("myFeed");
  myFeed.innerHTML = "Chargement...";
  const q = query(collection(db, "posts"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    myFeed.innerHTML = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      myFeed.appendChild(createPostElement(docSnap.id, data, true));
    });
  });
}

// Crée un élément post complet (avec like, boost, commentaire)
function createPostElement(postId, data, isUserPost) {
  const postDiv = document.createElement("div");
  postDiv.className = "post";

  // Header
  const header = document.createElement("div");
  header.className = "post-header";
  const img = document.createElement("img");
  img.src = data.userPhoto || "https://via.placeholder.com/40";
  img.alt = data.userName || "Utilisateur";
  header.appendChild(img);
  const nameSpan = document.createElement("span");
  nameSpan.textContent = data.userName || data.userEmail || "Anonyme";
  nameSpan.style.fontWeight = "bold";
  header.appendChild(nameSpan);

  postDiv.appendChild(header);

  // Contenu texte ou vidéo
  const content = document.createElement("div");
  content.className = "post-content";
  if (data.videoUrl) {
    const video = document.createElement("video");
    video.src = data.videoUrl;
    video.controls = true;
    content.appendChild(video);

    if (data.videoTitle) {
      const title = document.createElement("div");
      title.textContent = data.videoTitle;
      title.style.fontWeight = "bold";
      content.appendChild(title);
    }
  } else if (data.text) {
    const textBg = document.createElement("div");
    textBg.className = "text-bg";
    textBg.style.backgroundColor = data.bgColor || "#1877f2";
    textBg.textContent = data.text;
    content.appendChild(textBg);
  }
  postDiv.appendChild(content);

  // Actions : likes, vues, boost, commentaires
  const actions = document.createElement("div");
  actions.className = "post-actions";

  // Likes
  const likeIcon = document.createElement("i");
  likeIcon.className = "fa-regular fa-thumbs-up like";
  if (likedPosts.has(postId)) likeIcon.classList.add("liked");
  likeIcon.title = "Aimer";
  likeIcon.onclick = () => toggleLike(postId, likeIcon);
  actions.appendChild(likeIcon);

  // Nombre de likes
  const likesCount = document.createElement("span");
  likesCount.textContent = data.likes || 0;
  likesCount.style.marginRight = "10px";
  actions.appendChild(likesCount);

  // Nombre de vues
  const viewsSpan = document.createElement("span");
  viewsSpan.textContent = `👁️ ${data.views || 0}`;
  viewsSpan.style.marginRight = "10px";
  actions.appendChild(viewsSpan);

  // Bouton Booster uniquement si c’est dans feedme (les posts de l’utilisateur)
  if (isUserPost) {
    const boostBtn = document.createElement("button");
    boostBtn.textContent = "Booster";
    boostBtn.className = "boost-btn";
    boostBtn.onclick = () => selectPostToBoost(postId);
    actions.appendChild(boostBtn);
  }

  // Commentaire - icône
  const commentIcon = document.createElement("i");
  commentIcon.className = "fa-regular fa-comment";
  commentIcon.title = "Commentaires";
  actions.appendChild(commentIcon);

  postDiv.appendChild(actions);

  // Section commentaires (cachée par défaut)
  const commentsSection = document.createElement("div");
  commentsSection.className = "comments-section";
  commentsSection.style.display = "none";
  postDiv.appendChild(commentsSection);

  // Input commentaire
  const commentInputDiv = document.createElement("div");
  commentInputDiv.className = "comment-input";
  commentInputDiv.style.display = "none";

  const commentInput = document.createElement("input");
  commentInput.type = "text";
  commentInput.placeholder = "Écrire un commentaire...";
  commentInputDiv.appendChild(commentInput);

  const commentSendBtn = document.createElement("button");
  commentSendBtn.textContent = "Envoyer";
  commentSendBtn.onclick = () => sendComment(postId, commentInput.value, commentInput, commentsSection);
  commentInputDiv.appendChild(commentSendBtn);

  postDiv.appendChild(commentInputDiv);

  // Toggle commentaires au clic icône
  commentIcon.onclick = () => {
    if (commentsSection.style.display === "none") {
      commentsSection.style.display = "block";
      commentInputDiv.style.display = "flex";
      loadComments(postId, commentsSection);
    } else {
      commentsSection.style.display = "none";
      commentInputDiv.style.display = "none";
    }
  };

  return postDiv;
}

// Gestion likes
async function toggleLike(postId, iconEl) {
  if (!currentUser) return alert("Connectez-vous pour aimer.");
  const postRef = doc(db, "posts", postId);
  if (likedPosts.has(postId)) {
    // Annuler like
    await updateDoc(postRef, { likes: increment(-1) });
    likedPosts.delete(postId);
    iconEl.classList.remove("liked");
  } else {
    await updateDoc(postRef, { likes: increment(1) });
    likedPosts.add(postId);
    iconEl.classList.add("liked");
  }
}

// Charger les posts likés par l'utilisateur (pour l'UI)
async function loadLikedPosts() {
  if (!currentUser) return;
  likedPosts.clear();
  const q = query(collection(db, "likes"), where("userId", "==", currentUser.uid));
  // Simplification : on ne gère pas table likes séparée ici, juste likedPosts vide.
  // Tu peux étendre avec une collection likes si besoin.
}

// Gestion commentaires
async function loadComments(postId, container) {
  container.innerHTML = "Chargement des commentaires...";
  const commentsCol = collection(db, "posts", postId, "comments");
  const q = query(commentsCol, orderBy("createdAt", "asc"));
  onSnapshot(q, (snapshot) => {
    container.innerHTML = "";
    if (snapshot.empty) {
      container.innerHTML = "<p>Aucun commentaire.</p>";
      return;
    }
    snapshot.forEach(docSnap => {
      const c = docSnap.data();
      const cDiv = document.createElement("div");
      cDiv.className = "comment";
      cDiv.innerHTML = `<strong>${escapeHtml(c.userName)}</strong>: ${escapeHtml(c.text)}`;
      container.appendChild(cDiv);
    });
  });
}

async function sendComment(postId, text, inputEl, container) {
  if (!currentUser) return alert("Connectez-vous pour commenter.");
  if (!text.trim()) return alert("Commentaire vide.");
  const commentsCol = collection(db, "posts", postId, "comments");
  await addDoc(commentsCol, {
    userId: currentUser.uid,
    userName: currentUser.displayName || currentUser.email,
    text: text.trim(),
    createdAt: serverTimestamp()
  });
  inputEl.value = "";
  loadComments(postId, container);
}

// Gestion boost
let selectedBoostPostId = null;

window.selectPostToBoost = function(postId) {
  selectedBoostPostId = postId;
  document.getElementById("boostStatus").innerText = "1 sélectionné";
  openTab({currentTarget: document.querySelector("header .fa-film")}, "video");
};

window.boostPost = async function() {
  if (!currentUser) return alert("Connectez-vous pour booster.");
  if (!selectedBoostPostId) return alert("Aucune publication sélectionnée.");
  const boostViews = parseInt(document.getElementById("boostViews").value);
  const postRef = doc(db, "posts", selectedBoostPostId);

  // Ajouter les vues choisies à la publication
  await updateDoc(postRef, {
    views: increment(boostViews),
    boosted: increment(boostViews)
  });

  alert(`Publication boostée avec ${boostViews} vues.`);
  selectedBoostPostId = null;
  document.getElementById("boostStatus").innerText = "Aucune publication sélectionnée";
  openTab({currentTarget: document.querySelector("header .fa-home")}, "home");

  // Après boost, recharger stats vues
  await loadTotalViewsAndBalance();
};

// Calcul total vues et solde
async function loadTotalViewsAndBalance() {
  if (!currentUser) return;

  const userDocRef = doc(db, "users", currentUser.uid);
  const userDocSnap = await getDoc(userDocRef);

  let lastReset = null;
  let totalCredit = 0;

  if (userDocSnap.exists()) {
    const userData = userDocSnap.data();
    lastReset = userData.lastReset?.toDate?.() || null;
    totalCredit = userData.totalCredit || 0;
  }

  const now = new Date();
  let shouldReset = false;

  if (!lastReset || (now - lastReset) > 7 * 24 * 60 * 60 * 1000) {
    shouldReset = true;
  }

  // Récupérer les posts de l’utilisateur
  const q = query(collection(db, "posts"), where("userId", "==", currentUser.uid));
  const snapshot = await getDocs(q);

  let newViews = 0;

  const batch = [];

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const views = data.views || 0;
    newViews += views;

    if (shouldReset) {
      const postRef = doc(db, "posts", docSnap.id);
      batch.push(updateDoc(postRef, { views: 0 }));
    }
  });

  // Si on réinitialise, on met à jour le solde
  if (shouldReset) {
    const gainedCredit = Math.floor(newViews / 1000) * 50;
    totalCredit += gainedCredit;

    // Sauvegarder dans Firestore
    await setDoc(userDocRef, {
      totalCredit,
      lastReset: now
    });

    // Appliquer les resets de vues
    for (let update of batch) await update;

    document.getElementById("withdrawStatus").innerText = `+${gainedCredit} FCFA ajoutés au solde.`;
  }

  // Affichage
  document.getElementById("totalViewsCount").innerText = shouldReset
    ? "Les vues ont été réinitialisées."
    : `Nombre total de vues: ${newViews}`;

document.getElementById("currentBalance").innerText = `Solde actuel: ${newBalance} FCFA`;
window.currentCreditBalance = totalCredit;
}
// Retrait solde
window.withdrawBalance = async function () {
  if (!currentUser) return alert("Connectez-vous.");
  const amountStr = document.getElementById("withdrawAmount").value;
  const amount = parseInt(amountStr);

  if (isNaN(amount) || amount < 50) {
    return alert("Montant minimum de retrait : 50 FCFA.");
  }

  if (amount > window.currentCreditBalance) {
    return alert("Montant supérieur au solde.");
  }

  const userDocRef = doc(db, "users", currentUser.uid);
  const newBalance = window.currentCreditBalance - amount;

  await updateDoc(userDocRef, { totalCredit: newBalance });
  window.currentCreditBalance = newBalance;

  document.getElementById("currentBalance").innerText = `Solde actuel: ${newBalance} FCFA`;
  document.getElementById("withdrawStatus").innerText = `Vous avez retiré ${amount} FCFA.`;
  document.getElementById("withdrawAmount").value = "";
};
window.searchUser = async function () {
  const input = document.getElementById("searchUserInput").value.trim().toLowerCase();
  const resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML = "Recherche...";

  const usersQuery = query(collection(db, "posts"), orderBy("userName"));
  const snapshot = await getDocs(usersQuery);

  const uniqueUsers = new Map();
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const name = (data.userName || "").toLowerCase();
    const email = (data.userEmail || "").toLowerCase();

    if ((name.includes(input) || email.includes(input)) && !uniqueUsers.has(data.userId)) {
      uniqueUsers.set(data.userId, data);
    }
  });

  if (uniqueUsers.size === 0) {
    resultsDiv.innerHTML = "<p>Aucun utilisateur trouvé.</p>";
    return;
  }

  resultsDiv.innerHTML = "";
  uniqueUsers.forEach((data, userId) => {
    const div = document.createElement("div");
    div.style.border = "1px solid #ccc";
    div.style.padding = "10px";
    div.style.marginBottom = "10px";
    div.style.borderRadius = "10px";
    div.style.cursor = "pointer";
    div.innerHTML = `
      <img src="${data.userPhoto}" alt="Photo" style="width:30px; height:30px; border-radius:50%; vertical-align:middle; margin-right:10px;" />
      <strong>${data.userName}</strong> <br/>
      <small>${data.userEmail}</small>
    `;
    div.onclick = () => showUserFeed(userId, data.userName);
    resultsDiv.appendChild(div);
  });
};

window.showUserFeed = async function (userId, userName) {
  openTab({ currentTarget: document.querySelector('.fa-search') }, 'userFeedSection');
  document.getElementById("userFeedTitle").innerText = `Publications de ${userName}`;
  const userFeed = document.getElementById("userFeed");
  userFeed.innerHTML = "Chargement...";

  const q = query(collection(db, "posts"), where("userId", "==", userId), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);
  userFeed.innerHTML = "";
  snapshot.forEach(docSnap => {
    userFeed.appendChild(createPostElement(docSnap.id, docSnap.data(), false));
  });
};
// Initial call
renderFeed();
renderMyFeed();
loadTotalViewsAndBalance();

</script>
</body>
</html>