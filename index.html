<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mboa Skills</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* === GLOBAL STYLES ================================= */
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background-image:url('https://ucarecdn.com/ff597083-3c69-4040-8b93-1cb2c38ac703/-/preview/1000x999/');
    }
    header{
      position:fixed;top:0;left:0;right:0;
      display:flex;justify-content:space-around;align-items:center;
      padding:1rem;background:#fff;border-bottom:1px solid #ddd;z-index:99999
    }
    header i{font-size:1.4rem;color:#888;cursor:pointer}
    header i.selected{color:#1877f2}
    .tabcontent{display:none;padding:6rem 1rem 1rem;max-width:600px;margin:auto}
    .tabcontent.active{display:block}
    input,textarea,button,select{
      display:block;width:100%;padding:10px;margin-bottom:10px;
      border:1px solid #ccc;border-radius:6px;font-size:14px;box-sizing:border-box
    }
    button{background:#1877f2;color:#fff;font-weight:bold;border:none;border-radius:6px;cursor:pointer}
    button:hover{background:#145ec1}

    /* === POST CARD ===================================== */
    .post{
      background:#fff;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,.1);
      padding:1rem;margin-bottom:1rem
    }
    .post-header{display:flex;align-items:center}
    .post-header img{width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;cursor:pointer}
    .post-header span.username{font-weight:bold;cursor:pointer;color:#1877f2;}
    .post-content{margin-top:10px}
    .post video,.post .text-bg{width:100%;border-radius:10px;margin-top:10px}
    .text-bg{
      display:inline-block;padding:.5rem 1rem;font-weight:bold;color:#fff;
      text-align:center;white-space:pre-wrap;max-width:90%
    }
    .post-actions{margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .post-actions i{cursor:pointer;font-size:1.2rem}
    .like.liked{color:#1877f2}
    .boost-btn{background:#ffa500;color:#fff;padding:5px 10px;font-weight:bold;border-radius:6px;border:none;cursor:pointer}

    /* === COMMENTS ===================================== */
    .comments-section{margin-top:30px;border-top:1px solid #ccc;padding-top:10px;max-height:150px;overflow-y:auto;direction:ltr}
    .comment{direction:ltr;unicode-bidi:plaintext;text-align:left;word-break:break-word}
    .comment strong{color:#1877f2}
    .comment-input{display:flex;gap:14px;margin-top:14px}
    .comment-input input{flex:1;height:30px;padding:12px;border-radius:5px;border:1px solid #ccc;font-size:14px;width:100px;height:60px;}
    .comment-input button{padding:5px 9px;background:#1877f2;color:#fff;border:none;border-radius:8px;cursor:pointer}

    /* === ACCOUNT FORMS ================================= */
    #emailLoginBox,#emailSignupBox{
      background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,.1);margin-bottom:15px
    }
    #emailLoginBox input,#emailSignupBox input{margin-bottom:10px}
    #emailLoginBox button,#emailSignupBox button{background:#1877f2;color:#fff;border:none;padding:10px;font-weight:bold;border-radius:6px;cursor:pointer;width:100%}
    #emailLoginBox button:hover,#emailSignupBox button:hover{background:#145ec1}
    #accountStatus{margin-top:10px;font-weight:bold;color:#1877f2}
    #authStatus{margin-top:10px;font-weight:bold;color:limegreen}

    /* === USER FEED ==================================== */
    #userFeedContent .post{/* inherits .post styles */}
    .follow-btn{
  padding:2px 3px;border:none;border-radius:4px;font-size:12px;
  cursor:pointer;background:#1877f2;color:#fff
}
  </style>
</head>

<body>

<header>
<i class="fas fa-home tablinks selected" onclick="openTab(event,'home'); window.scrollTo({ top: 0, behavior: 'smooth' });"></i>
  <i class="fas fa-coins tablinks"           onclick="openTab(event,'totalViewsSection')"></i>
  <i class="fas fa-video tablinks"           onclick="openTab(event,'videoFeed')"></i>
  <i class="fas fa-plus tablinks"            onclick="openTab(event,'post')"></i>
  <i class="fas fa-search tablinks"          onclick="openTab(event,'search')"></i>
  <i class="fas fa-user tablinks"            onclick="openTab(event,'account')"></i>
</header>

<!-- ============ HOME ============ -->
<section id="home" class="tabcontent active">
  <div class="post-header">
    <img id="homeProfilePhoto" src="https://via.placeholder.com/40" onclick="openTab(event,'feedme')"/>
    <p id="authStatus"></p>
    <p id="accountStatus"></p>
  </div>
  <hr>
  <div id="feed"></div>
</section>

<!-- ============ POST ============ -->
<section id="post" class="tabcontent">
  <h3>Créer une publication</h3>
  <textarea id="postText" placeholder="Exprimez-vous..."></textarea>
  <input type="color" id="bgColor" value="#1877f2" />
  <hr/>
  <input type="text" id="videoTitle" placeholder="Titre de la vidéo" />
  <input type="file" id="videoFile" accept="video/*" />
  <button onclick="publishPost()">Publier</button>
  <p id="status"></p>
</section>

<!-- ============ VIDEO FEED ============ -->
<section id="videoFeed" class="tabcontent">
  <h3>Publications avec vidéos</h3>
  <div id="videoFeedContent"></div>
</section>

<!-- ============ TOTAL VIEWS ============ -->
<section id="totalViewsSection" class="tabcontent">
  <h3>Total des vues</h3>
  <label for="periodSelect">Période :</label>
<select id="periodSelect">
  <option value="all">Tout</option>
  <option value="week">7 derniers jours</option>
  <option value="month">Dernier mois</option>
  <option value="year">Dernière année</option>
</select>
  Vues: <p id="totalViewsCount" style="color:lime">Chargement...</p>
  <p id="currentBalance">Solde actuel: 0 FCFA</p>
  <input type="number" id="withdrawAmount" placeholder="Montant à retirer (min 50 FCFA)" min="50" />
  <button onclick="withdrawBalance()">Retirer</button>
  <p id="withdrawStatus"></p>
</section>

<!-- ============ SEARCH ============ -->
<section id="search" class="tabcontent">
  <h3>Rechercher un utilisateur</h3>
  <input type="text" id="searchUserInput" placeholder="Nom ou e-mail de l'utilisateur" />
  <button onclick="searchUser()">Rechercher</button>
  <div id="searchResults"></div>
</section>

<!-- ============ ACCOUNT ============ -->
<section id="account" class="tabcontent">
  <div class="post-header">
    <button onclick="openTab(event,'conect')">Connexion</button>
    <button onclick="openTab(event,'inscrip')">Inscription</button>
  </div>
  <hr>
  <button onclick="signInWithGoogle()"><i class="fab fa-google"></i> Connexion par Google</button>
  <hr/>
  <button onclick="signOutUser()" style="background-color:red">Se déconnecter</button>
  <br/><br/>
  <u><a href="https://www.facebook.com/profile.php?id=61577616822265">contact support</a> <i class="fab fa-facebook" style="color:#1877f2"></i></u>
</section>

<!-- ============ FEEDME (MY FEED) ============ -->
<section id="feedme" class="tabcontent">
  <h3>Mes publications</h3>
  <div class="post-header">
    <img id="feedmeProfilePhoto" src="https://via.placeholder.com/40" />
    <p id="accountStatusFeed"></p>
    <label for="profilePhotoInput" title="Changer la photo"><i class="fas fa-plus" style="cursor:pointer"></i></label>
    <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" />
  </div>
  <div id="myFeed"></div>
</section>

<!-- ============ BOOST VIDEO LIST ============ -->
<section id="video" class="tabcontent">
  <div id="videoFeedContentBoost"></div>
</section>

<!-- ============ BOOST PANEL ============ -->
<section id="vibo" class="tabcontent">
  <h3>Booster une publication</h3>
  <div class="post-header">
  <input type="number" id="montant" placeholder="Montant à déposer" min="1900" style="padding: 6px; width: 150px;">
  <button id="notchpayBtn" style="padding: 6px 12px; background-color: #1877f2; color: white; border: none; border-radius: 4px; cursor: pointer;">
    Deposer
  </button>
</div> 
  <p>Argent: <span id="argent">0</span> XAF</p>

  <div id="boostPanel" style="display:none;margin-bottom:10px">
    <span id="boostStatus" style="font-weight:bold"></span>
    <input type="number" id="boostViews" placeholder="Nombre de vues à acheter" min="1" />
    <button onclick="boostPost()">Booster</button>
  </div>
</section>

<!-- ============ LOGIN FORM ============ -->
<section id="conect" class="tabcontent">
  <h3>Connectez-vous</h3>
  <div id="emailLoginBox">
    <input type="email"    id="loginEmail"    placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Mot de passe" />
    <button onclick="loginWithEmail()">Se connecter</button>
  </div>
</section>

<!-- ============ SIGNUP FORM ============ -->
<section id="inscrip" class="tabcontent">
  <h3>Inscription</h3>
  <div id="emailSignupBox">
    <input type="text"     id="signupName"     placeholder="Nom complet" />
    <input type="email"    id="signupEmail"    placeholder="Email" />
    <input type="password" id="signupPassword" placeholder="Mot de passe (≥ 6 car.)" />
    <input type="number"   id="signupAge"      placeholder="Âge (min 18)" min="18" />
    <button onclick="signupWithEmail()">S’inscrire</button>
  </div>
</section>

<!-- ============ OTHER USER FEED ============ -->
<section id="userFeed" class="tabcontent">
  <h3 id="userFeedTitle">Publications de …</h3>
  <div id="userFeedContent"></div>
</section>
<script type="module">
/*──────────────────────────────────────────────────────────
  1. IMPORTS
──────────────────────────────────────────────────────────*/
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
import {
  getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider,
  updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
import {
  getFirestore,
  collection, addDoc, onSnapshot, query, orderBy, where,
  doc, getDocs, getDoc, setDoc, updateDoc,
  increment, serverTimestamp, runTransaction,
  deleteDoc, limit
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js';

/*──────────────────────────────────────────────────────────
  2. CONFIG & GLOBALS
──────────────────────────────────────────────────────────*/
const firebaseConfig = {
  apiKey:            "AIzaSyClSjd2LrIQpaJoVWO32vFRx7I9cvmDgBo",
  authDomain:        "mboa-ec602.firebaseapp.com",
  projectId:         "mboa-ec602",
  storageBucket:     "mboa-ec602.appspot.com",
  messagingSenderId: "498505132403",
  appId:             "1:498505132403:web:eb46547745f8d1a77b3d06"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const stg  = getStorage(app);
const provider = new GoogleAuthProvider();

let currentUser=null, likedPosts=new Set(), followingIds=new Set();
let boostId='', currentBalance=0;

const qs=id=>document.getElementById(id);
const fmt=n=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'k':n;

(async () => {
  const params = new URLSearchParams(location.search);
  const amount = parseFloat(params.get("amount"));
  const uid = params.get("uid");
  const ref = params.get("ref");

  if (amount > 0 && uid && ref && currentUser?.uid === uid) {
    // Empêche double ajout
    const refDoc = doc(db, 'walletPayments', ref);
    const existing = await getDoc(refDoc);
    if (!existing.exists()) {
      // Crédite le solde
      const walletRef = doc(db, 'wallets', uid);
      await runTransaction(db, async t => {
        const snap = await t.get(walletRef);
        const old = snap.exists() ? snap.data().balance : 0;
        t.set(walletRef, { balance: old + amount }, { merge: true });
      });
      // Marque la transaction comme enregistrée
      await setDoc(refDoc, { uid, amount, createdAt: serverTimestamp() });
      alert(`Paiement réussi : ${amount} FCFA ajouté à votre solde`);
      location.href = location.origin + location.pathname; // Nettoyer l'URL
    }
  }
})();
(async () => {
  const params = new URLSearchParams(location.search);
  const amount = parseFloat(params.get("amount"));
  const uid = params.get("uid");
  const ref = params.get("ref");

  if (amount > 0 && uid && ref && currentUser?.uid === uid) {
    const refDoc = doc(db, 'walletPayments', ref);
    const existing = await getDoc(refDoc);
    if (!existing.exists()) {
      const walletRef = doc(db, 'wallets', uid);
      await runTransaction(db, async t => {
        const snap = await t.get(walletRef);
        const old = snap.exists() ? snap.data().balance : 0;
        t.set(walletRef, { balance: old + amount }, { merge: true });
      });
      await setDoc(refDoc, { uid, amount, createdAt: serverTimestamp() });
      alert(`Paiement réussi : ${amount} FCFA ajouté à votre solde`);
      location.href = location.origin + location.pathname;
    }
  }
})();
/*──────────────────────────────────────────────────────────
  3. DOM READY — Dépôt
──────────────────────────────────────────────────────────*/
document.addEventListener('DOMContentLoaded',()=>{
  qs('deposer')?.addEventListener('click',()=>{
    const m=parseFloat(qs('montant').value);
    if(isNaN(m))return alert('Entrez un montant');deposit(m);qs('montant').value='';
  });
});

/*──────────────────────────────────────────────────────────
  4. NAVIGATION & SHUFFLE
──────────────────────────────────────────────────────────*/
window.openTab = (evt, id) => {
  const isAlreadyActive = document.getElementById(id).classList.contains('active');

  // Affiche l’onglet sélectionné
  document.querySelectorAll('.tabcontent').forEach(t => t.classList.toggle('active', t.id === id));
  document.querySelectorAll('.tablinks').forEach(l => l.classList.toggle('selected', l === evt.currentTarget));
  history.pushState({ tab: id }, '', `#${id}`);

  // Recharge le contenu si re-clic
  if (isAlreadyActive) {
    if (id === 'home') renderFeed();
    if (id === 'videoFeed') renderVideoFeed(); // <- ici !
  }

  // 🟢 S’assurer qu'on appelle renderVideoFeed au premier clic aussi
  if (id === 'videoFeed') renderVideoFeed();
};
function shuffleFeed(){
  const c=qs('feed');const n=[...c.children];
  for(let i=n.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[n[i],n[j]]=[n[j],n[i]];}
  n.forEach(el=>c.appendChild(el));
}

/*──────────────────────────────────────────────────────────
  5. AUTH
──────────────────────────────────────────────────────────*/
window.signInWithGoogle=()=>signInWithPopup(auth,provider).catch(e=>alert(e.message));
window.signOutUser=()=>signOut(auth);

onAuthStateChanged(auth,async user=>{
  currentUser=user;
  const p=user?.photoURL||'https://ucarecdn.com/ff597083-3c69-4040-8b93-1cb2c38ac703/-/preview/1000x999/';
  qs('homeProfilePhoto').src=p;qs('feedmeProfilePhoto').src=p;
  qs('authStatus').textContent=user?` ${user.displayName||user.email}`:'';
  qs('accountStatus').textContent=user?`• ${user.displayName||user.email}`:'';
  qs('accountStatusFeed').textContent=qs('accountStatus').textContent;

  if(user){
    await loadWallet(); await loadFollowing(); await loadLikedPosts();
    renderFeed();renderMyFeed();renderVideoFeed();renderBoostFeed();
    await loadTotalViewsAndBalance();
  }else{
    likedPosts.clear();followingIds.clear();
    ['feed','myFeed','videoFeedContent','videoFeedContentBoost','userFeedContent'].forEach(id=>qs(id).innerHTML='');
    qs('totalViewsCount').textContent='';qs('currentBalance').textContent='Solde actuel: 0 FCFA';
  }
});

/*──────────────────────────────────────────────────────────
  6. FOLLOW / FOLLOWERS
──────────────────────────────────────────────────────────*/
async function loadFollowing(){
  if(!currentUser)return;
  const s=await getDocs(collection(db,'follows',currentUser.uid,'list'));
  followingIds=new Set(s.docs.map(d=>d.id));
}
function updateFollowBtn(uid,b){
  const on=followingIds.has(uid);
  b.textContent=on?'Suivi(e)':'Suivre';
  b.style.background=on?'#ccc':'#1877f2';
  b.style.color=on?'#000':'#fff';
}
function renderFollowBtn(uid){
  if(!currentUser||uid===currentUser.uid)return null;
  const b=document.createElement('button');b.className='follow-btn';
  updateFollowBtn(uid,b);
  b.onclick=()=>toggleFollow(uid,b);
  return b;
}
async function toggleFollow(uid,b){
  if(!currentUser)return alert('Connectez-vous');
  const myRef=doc(db,'follows',currentUser.uid,'list',uid);
  const hisRef=doc(db,'follows',uid,'list',currentUser.uid);
  const on=followingIds.has(uid);
  if(on){
    await Promise.all([deleteDoc(myRef),deleteDoc(hisRef)]);
    followingIds.delete(uid);
  }else{
    await Promise.all([setDoc(myRef,{}),setDoc(hisRef,{})]);
    followingIds.add(uid);
  }
  updateFollowBtn(uid,b); refreshFollowerCounters(uid);
}
async function refreshFollowerCounters(uid){
  const snap=await getDocs(collection(db,'follows',uid,'list'));
  const n=snap.size;
  document.querySelectorAll(`[data-followers-of="${uid}"]`).forEach(el => el.textContent = `Followers : ${fmt(n)}`);
}

/*──────────────────────────────────────────────────────────
  7. WALLET dépôt
──────────────────────────────────────────────────────────*/
async function loadWallet(){
  if(!currentUser)return;
  const s=await getDoc(doc(db,'wallets',currentUser.uid));
  qs('argent').textContent=(s.exists()?s.data().balance:10).toFixed(0);
}
async function deposit(a){
  if(!currentUser)return alert('Connectez-vous');
  if(a<1900)return alert('Min 1 900 FCFA');
  const ref=doc(db,'wallets',currentUser.uid);
  await runTransaction(db,async t=>{
    const s=await t.get(ref);const bal=s.exists()?s.data().balance:10;
    t.set(ref,{balance:bal+a},{merge:true});
  });
  await loadWallet();
}

/*──────────────────────────────────────────────────────────
  8. PUBLISH POST
──────────────────────────────────────────────────────────*/
window.publishPost=async()=>{
  if(!currentUser)return alert('Connectez-vous');
  const text=qs('postText').value.trim(); const bg=qs('bgColor').value;
  const file=qs('videoFile').files[0]; const tit=qs('videoTitle').value.trim();
  if(!text&&!file)return alert('Ajoutez un texte ou une vidéo');
  qs('status').textContent='Publication…';
  const data={userId:currentUser.uid,userEmail:currentUser.email,userName:currentUser.displayName||currentUser.email,userPhoto:currentUser.photoURL||'https://via.placeholder.com/40',text,bgColor:bg,videoUrl:null,videoTitle:tit,views:0,likes:0,createdAt:serverTimestamp(),boosted:0};
  const reset=()=>{['postText','videoTitle'].forEach(i=>qs(i).value='');qs('videoFile').value='';qs('status').textContent='Publié !';};
  if(file){
    const r=ref(stg,`videos/${Date.now()}_${file.name}`);
    uploadBytesResumable(r,file).on('state_changed',s=>qs('status').textContent=`${Math.floor(s.bytesTransferred/s.totalBytes*100)}%`,e=>alert(e.message),async s=>{data.videoUrl=await getDownloadURL(s.ref);await addDoc(collection(db,'posts'),data);reset();});
  }else{await addDoc(collection(db,'posts'),data);reset();}
};

/*──────────────────────────────────────────────────────────
  9. FEED ACCUEIL (boostés + suivis)
──────────────────────────────────────────────────────────*/
let firstRenderDone = false;
let cachedPosts = [];
async function renderFeed() {
  const c = qs('feed');
  c.textContent = 'Chargement…';

  // Si déjà chargé une fois → on permute uniquement
  if (firstRenderDone && cachedPosts.length > 0) {
    const shuffled = [...cachedPosts];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    c.innerHTML = '';
    shuffled.forEach(p => c.appendChild(card(p.id, p.data, false)));
    return;
  }

  // Sinon : premier affichage → on récupère depuis Firestore
  const posts = [];

  // Boosted posts
  const qBoost = query(
    collection(db, 'posts'),
    where('boosted', '>', 0),
    orderBy('boosted', 'desc'),
    orderBy('createdAt', 'desc'),
    limit(30)
  );
  const snapBoost = await getDocs(qBoost);
  snapBoost.forEach(d => posts.push({ id: d.id, data: d.data() }));

  // Followed users
  if (followingIds.size > 0) {
    const groups = [...followingIds].reduce((a, u, i) => {
      if (i % 10 === 0) a.push([]);
      a[a.length - 1].push(u);
      return a;
    }, []);

    for (const g of groups) {
      const q = query(
        collection(db, 'posts'),
        where('userId', 'in', g),
        orderBy('createdAt', 'desc'),
        limit(30)
      );
      const snap = await getDocs(q);
      snap.forEach(d => {
        if (!posts.find(p => p.id === d.id)) {
          posts.push({ id: d.id, data: d.data() });
        }
      });
    }
  }

  // Trier du plus récent au plus ancien
  posts.sort((a, b) => {
    const ta = a.data.createdAt?.toMillis?.() || 0;
    const tb = b.data.createdAt?.toMillis?.() || 0;
    return tb - ta;
  });

  cachedPosts = posts;
  firstRenderDone = true;

  c.innerHTML = '';
  posts.forEach(p => c.appendChild(card(p.id, p.data, false)));
}
function loadFollowedPosts(c){
  if(!followingIds.size)return;
  const groups=[...followingIds].reduce((a,u,i)=>{if(i%10===0)a.push([]);a[a.length-1].push(u);return a;},[]);
  groups.forEach(g=>{
    const q=query(collection(db,'posts'),where('userId','in',g),orderBy('createdAt','desc'),limit(30));
    onSnapshot(q,snap=>snap.forEach(d=>{if(!c.querySelector(`[data-post="${d.id}"]`))c.appendChild(card(d.id,d.data(),false));}));
  });
}

/*──────────────────────────────────────────────────────────
 10. MES POSTS  (+ compteur followers)
──────────────────────────────────────────────────────────*/
function renderMyFeed(){
  if(!currentUser)return;
  const c=qs('myFeed');c.textContent='Chargement…';
  onSnapshot(query(collection(db,'posts'),where('userId','==',currentUser.uid),orderBy('createdAt','desc')),
    async snap=>{
      c.innerHTML='';
      const fol=await getDocs(collection(db,'follows',currentUser.uid,'list'));
      const p=document.createElement('p');p.dataset.followersOf=currentUser.uid;
      p.textContent = `Followers : ${fmt(fol.size)}`;
      c.appendChild(p);
      snap.forEach(d=>c.appendChild(card(d.id,d.data(),true)));
    });
}

/*──────────────────────────────────────────────────────────
 11. VIDEO FEED & BOOST FEED
──────────────────────────────────────────────────────────*/
function renderVideoFeed() {
  const c = qs('videoFeedContent');
  c.textContent = 'Chargement…';

  onSnapshot(
    query(collection(db, 'posts'), where('videoUrl', '!=', null), orderBy('createdAt', 'desc')),
    snap => {
      c.innerHTML = '';

      // Convertir en tableau
      const docs = Array.from(snap.docs);

      // 🔀 Mélanger les vidéos aléatoirement
      docs.sort(() => Math.random() - 0.5);

      // Afficher
      for (const d of docs) {
        c.appendChild(card(d.id, d.data(), false));
      }
    }
  );
}
function renderBoostFeed(){
  if(!currentUser)return;
  const c=qs('videoFeedContentBoost');c.textContent='Chargement…';
  onSnapshot(query(collection(db,'posts'),where('userId','==',currentUser.uid),where('videoUrl','!=',null),orderBy('createdAt','desc')),
    snap=>{c.innerHTML='';snap.forEach(d=>c.appendChild(card(d.id,d.data(),true)));});
}

/*──────────────────────────────────────────────────────────
 12. CARD (like / comments / boost)
──────────────────────────────────────────────────────────*/

function card(id, d, isMine) {
  const w = document.createElement('div');
  w.className = 'post';
  w.dataset.post = id;

  /* header */
  const head = document.createElement('div');
  head.className = 'post-header';

  const img = document.createElement('img');
  img.src = d.userPhoto;
  img.onclick = () => openUserFeed(d.userId);

  const name = document.createElement('span');
  name.className = 'username';
  name.textContent = d.userName || d.userEmail;
  name.onclick = () => openUserFeed(d.userId);

  // Affichage du temps écoulé
  const time = document.createElement('small');
  time.style.marginLeft = '8px';
  time.style.color = '#888';
  if (d.createdAt?.toDate) {
    time.textContent = `• il y a ${timeSince(d.createdAt.toDate())}`;
  }

  head.append(img, name, time);

  const fbtn = renderFollowBtn(d.userId);
  if (fbtn) head.appendChild(fbtn);

  if (d.boosted > 0) {
    const tag = document.createElement('span');
    tag.textContent = 'Sponsorisé';
    tag.style.cssText = 'margin-left:auto;color:#ffa500;font-size:12px;font-weight:bold';
    head.appendChild(tag);
  }

  w.appendChild(head);

  /* content */
  const cont = document.createElement('div');
  cont.className = 'post-content';

  if (d.videoUrl) {
    cont.innerHTML = `<video src="${d.videoUrl}" controls></video>${d.videoTitle ? `<div style="font-weight:bold">${d.videoTitle}</div>` : ''}`;
  } else if (d.text) {
    cont.innerHTML = `<div class="text-bg" style="background:${d.bgColor}">${d.text}</div>`;
  }

  w.appendChild(cont);

  /* actions */
  const act = document.createElement('div');
  act.className = 'post-actions';

  // like
  const like = document.createElement('i');
  like.className = 'fa-regular fa-thumbs-up like';
  if (likedPosts.has(id)) like.classList.add('liked');

  const lCnt = document.createElement('span');
  lCnt.textContent = fmt(d.likes || 0);

  like.onclick = () => toggleLike(id, like, lCnt);
  act.append(like, lCnt);

// vues
const vCnt = document.createElement('span');
const vuesAffichees = (d.views || 0) + (d.boosted || 0) + ((d.likes || 0) * 10);
vCnt.textContent = `👁️ ${fmt(vuesAffichees)}`;
act.appendChild(vCnt);
  // commentaire
  const comI = document.createElement('i');
  comI.className = 'fa-regular fa-comment';

  const comCnt = document.createElement('span');
  comCnt.textContent = ' … ';
  act.append(comI, comCnt);

  // boost
  if (isMine) {
    const b = document.createElement('button');
    b.className = 'boost-btn';
    b.textContent = 'Booster';
    b.onclick = () => selectBoostPost(id, d.text || d.videoTitle || 'Sans titre');
    act.appendChild(b);
  }

  w.appendChild(act);

  /* comments section */
  const comSec = document.createElement('div');
  comSec.className = 'comments-section';
  comSec.style.display = 'none';

  const comList = document.createElement('div');
  comSec.appendChild(comList);

  if (currentUser) {
    const div = document.createElement('div');
    div.className = 'comment-input';

    const inp = document.createElement('input');
    inp.placeholder = 'Ajouter un commentaire...';

    const btn = document.createElement('button');
    btn.textContent = 'Envoyer';
    btn.onclick = () => {
      const t = inp.value.trim();
      if (!t) return;
      addComment(id, t);
      inp.value = '';
    };

    div.append(inp, btn);
    comSec.appendChild(div);
  }

  w.appendChild(comSec);

  comI.onclick = () => {
    comSec.style.display = comSec.style.display === 'none' ? 'block' : 'none';
    if (comSec.style.display === 'block') loadComments(id, comList, comCnt);
  };

  return w;
}
/* LIKE */
async function loadLikedPosts(){likedPosts.clear();}
async function toggleLike(pid,icon,cnt){
  if(!currentUser)return alert('Connectez-vous');
  const ref=doc(db,'posts',pid);
  if(likedPosts.has(pid)){likedPosts.delete(pid);icon.classList.remove('liked');await updateDoc(ref,{likes:increment(-1)});}
  else{likedPosts.add(pid);icon.classList.add('liked');await updateDoc(ref,{likes:increment(1)});}
  const s=await getDoc(ref);cnt.textContent=fmt(s.data().likes||0);
}

/* COMMENTS */
async function loadComments(pid,container,cnt){
  const s=await getDocs(query(collection(db,'posts',pid,'comments'),orderBy('createdAt')));
  container.innerHTML='';cnt.textContent=s.size;
  s.forEach(d=>{const c=d.data();const div=document.createElement('div');div.className='comment';div.innerHTML=`<strong>${c.userName}</strong> : ${c.text}`;container.appendChild(div);});
}
async function addComment(pid,text){
  if(!currentUser)return;
  await addDoc(collection(db,'posts',pid,'comments'),{userId:currentUser.uid,userName:currentUser.displayName||currentUser.email,text,createdAt:serverTimestamp()});
}

/* BOOST */
function selectBoostPost(pid,title){
  boostId=pid;qs('boostStatus').textContent=`1 sélection : ${title}`;qs('boostPanel').style.display='block';
  openTab({currentTarget:document.querySelector('.tablinks[onclick*="vibo"]')},'vibo');
}
async function debit(cost){
  if(!currentUser)return false;
  const ref=doc(db,'wallets',currentUser.uid);
  const ok=await runTransaction(db,async t=>{const s=await t.get(ref);const bal=s.exists()?s.data().balance:0;if(bal<cost)return false;t.update(ref,{balance:bal-cost});return true;});
  if(!ok)alert('Solde insuffisant');await loadWallet();return ok;
}
window.boostPost=async()=>{
  if(!boostId)return alert('Choisissez une publication');
  const v=parseInt(qs('boostViews').value);if(isNaN(v)||v<1000)return alert('Min 1 000 vues');
  const cost=Math.ceil(v/1000)*250;if(!(await debit(cost)))return;
  try{
    await updateDoc(doc(db,'posts',boostId),{boosted:increment(v),views:increment(v)});
    qs('boostStatus').textContent=`Boost OK (−${cost} XAF)`;qs('boostViews').value='';boostId='';renderFeed();renderMyFeed();await loadTotalViewsAndBalance();
  }catch(e){alert('Erreur boost : '+e.message);await deposit(cost);}
};

/*──────────────────────────────────────────────────────────
 13. USER FEED & SEARCH
──────────────────────────────────────────────────────────*/
window.openUserFeed=async uid=>{
  openTab({currentTarget:document.querySelector('.tablinks[onclick*="home"]')},'userFeed');
  const cont=qs('userFeedContent'),title=qs('userFeedTitle');cont.textContent='Chargement…';
  let name='Utilisateur',photo='https://via.placeholder.com/40';
  const last=await getDocs(query(collection(db,'posts'),where('userId','==',uid),orderBy('createdAt','desc'),limit(1)));
  if(!last.empty){const d=last.docs[0].data();name=d.userName||name;photo=d.userPhoto||photo;}
  title.innerHTML='';title.style.cssText='display:flex;align-items:center;gap:8px';
  const img=document.createElement('img');img.src=photo;img.style.cssText='width:40px;height:40px;border-radius:50%';
  const str=document.createElement('strong');str.textContent=name;
  const fol=document.createElement('span');fol.dataset.followersOf=uid;
  const btn=renderFollowBtn(uid);
  title.append(img,str,fol);if(btn)title.appendChild(btn);refreshFollowerCounters(uid);
  onSnapshot(query(collection(db,'posts'),where('userId','==',uid),orderBy('createdAt','desc')),
    snap=>{cont.innerHTML='';snap.empty?cont.textContent='Aucune publication.':snap.forEach(d=>cont.appendChild(card(d.id,d.data(),false)));});
};
window.searchUser=async()=>{
  const q=qs('searchUserInput').value.trim().toLowerCase();
  if(!q)return alert('Entrez un nom ou e-mail');
  const s=await getDocs(collection(db,'posts'));const map=new Map();
  s.forEach(d=>{const v=d.data();if((v.userName||'').toLowerCase().includes(q)||(v.userEmail||'').toLowerCase().includes(q))map.set(v.userId,{uid:v.userId,name:v.userName,email:v.userEmail,photo:v.userPhoto});});
  const res=qs('searchResults');res.innerHTML='';
  if(map.size===0)return res.textContent='Aucun utilisateur trouvé';
  map.forEach(u=>{
    const d=document.createElement('div');d.style.cssText='cursor:pointer;display:flex;align-items:center;gap:8px;margin-bottom:8px';
    const img=document.createElement('img');img.src=u.photo||'https://via.placeholder.com/40';img.style.cssText='width:40px;height:40px;border-radius:50%';
    const span=document.createElement('span');span.textContent=u.name||u.email;span.style.cssText='color:#1877f2;font-weight:bold';
    const btn=renderFollowBtn(u.uid);
    d.append(img,span);if(btn)d.append(btn);d.onclick=()=>openUserFeed(u.uid);res.appendChild(d);
  });
};

/*──────────────────────────────────────────────────────────
 14. VIEWS & RETRAIT
──────────────────────────────────────────────────────────*/
async function loadTotalViewsAndBalance(period = 'all') {
  if (!currentUser) return;

  const postsRef = collection(db, 'posts');
  let q = query(postsRef, where('userId', '==', currentUser.uid));

  // Appliquer un filtre selon la période choisie
  if (period !== 'all') {
    let startDate;

    const now = new Date();
    switch (period) {
      case 'week':
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); // 7 jours
        break;
      case 'month':
        startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        break;
      case 'year':
        startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
        break;
    }

    if (startDate) {
      q = query(q, where('createdAt', '>=', startDate));
    }
  }

  const s = await getDocs(q);

  let tot = 0;
  s.forEach(d => {
    const v = d.data();
    tot += (v.views || 0) + (v.boosted || 0);
  });

  qs('totalViewsCount').textContent = fmt(tot);
  currentBalance = Math.floor(tot / 1000) * 50;
  qs('currentBalance').textContent = `Solde actuel: ${currentBalance} FCFA`;
  }
  window.withdrawBalance=()=>{
  const a=qs('withdrawAmount').valueAsNumber;
  if(!Number.isFinite(a)||a<5000)return alert('Min 5 000 FCFA');
  if(a>currentBalance)return alert('Solde insuffisant');
  currentBalance-=a;qs('currentBalance').textContent=`Solde actuel: ${currentBalance} FCFA`;
  qs('withdrawAmount').value='';alert(`Retrait de ${a} FCFA effectué !`);
};

/*──────────────────────────────────────────────────────────
 15. SIGNUP / LOGIN EMAIL
──────────────────────────────────────────────────────────*/
    window.signupWithEmail=async()=>{
  const n=qs('signupName').value.trim(),e=qs('signupEmail').value.trim(),p=qs('signupPassword').value,age=parseInt(qs('signupAge').value,10);
  if(!n||!e||!p||isNaN(age))return alert('Champs manquants');
  if(age<18)return alert('Âge min 18'); if(p.length<6)return alert('Mot de passe ≥6');
  try{const c=await createUserWithEmailAndPassword(auth,e,p);await updateProfile(c.user,{displayName:n});location.reload();}
  catch(err){alert(err.message);}
};
window.loginWithEmail=async()=>{
  const e=qs('loginEmail').value.trim(),p=qs('loginPassword').value;
  if(!e||!p)return alert('Entrez e-mail et mdp');
  try{await signInWithEmailAndPassword(auth,e,p);location.reload();}
  catch(err){alert(err.message);}
};
document.getElementById('notchpayBtn')?.addEventListener('click', () => {
  const m = parseFloat(qs('montant').value);
  if (isNaN(m) || m < 1900) return alert('Min 1 900 FCFA');

  if (!currentUser) return alert('Connectez-vous');

  const email = currentUser.email;
  const uid = currentUser.uid;
  const ref = `tx_${Date.now()}`;
  const redirectUrl = encodeURIComponent(`${location.origin}${location.pathname}?amount=${m}&uid=${uid}&ref=${ref}`);

  const link = `https://notchpay.me/uVKDgUezZ`;
  window.location.href = link;
});
function openHomeTab(evt) {
  openTab(evt, 'home'); // Ouvre la section 'home'
  window.scrollTo({ top: 0, behavior: 'smooth' }); // Remonte en haut avec animation douce
}
function timeSince(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const intervals = {
    année: 31536000,
    mois: 2592000,
    semaine: 604800,
    jour: 86400,
    heure: 3600,
    minute: 60,
    seconde: 1,
  };

  for (const [unit, value] of Object.entries(intervals)) {
    const amount = Math.floor(seconds / value);
    if (amount >= 1) {
      return `${amount} ${unit}${amount > 1 ? 's' : ''}`;
    }
  }
  return 'quelques secondes';
}
  document.getElementById('periodSelect').addEventListener('change', (e) => {
  const selectedPeriod = e.target.value;
  loadTotalViewsAndBalance(selectedPeriod);
});

// Chargement initial avec la période "all"
loadTotalViewsAndBalance('all');
</script>
</body>
</html>
