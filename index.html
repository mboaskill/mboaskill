<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mboa Skills</title>
<script src="https://js.notchpay.co/v1/checkout.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">


  <style>
    /* === GLOBAL STYLES ================================= */
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
     background-color: #888; 
          }
   header {
  background-color: #fff;
  display: flex;
  flex-direction: column; /* Logo en haut, icÃ´nes en bas */
  border-bottom: 1px solid #ccc;
  position: fixed;
  width: 100%;
  margin: 0;
  padding: 15px;
  top: 0;
  left: 0;
  z-index: 999999;
}

header .logo {
  color: gold;
  font-size: 1.8rem;
  font-weight: bold;
  align-self: flex-start; /* Logo collÃ© Ã  gauche */
}

header .icons {
  margin-top: 10px; /* espace entre logo et icÃ´nes */
  display: flex;
  justify-content: center; /* IcÃ´nes centrÃ©es */
  width: 100%; /* pour que le centrage marche bien */
}

header .icons i {
  margin: 0 1rem;
  font-size: 1.8rem;
  color: #555;
  cursor: pointer;
  transition: color 0.3s ease;
  width: 100%;
}
  header .icons i.active {
  color: gold;
}
        .tabcontent{display:none;padding:6rem 1rem 1rem;max-width:600px;margin:auto}
    .tabcontent.active{display:block}
    input,textarea,button,select{
      display:block;width:100%;padding:10px;margin-bottom:10px;
      border:1px solid #ccc;border-radius:6px;font-size:14px;box-sizing:border-box
    }
    button{background:gold;color:#fff;font-weight:bold;border:none;border-radius:15px;cursor:pointer}
    button:hover{background:#145ec1}

    /* === POST CARD ===================================== */
section#home,#videoFeed,#userFeed,#feedme,#music {
        background-color: #fff;
    }
    
    .post {
  background: #fff;
  border-radius: 2px;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
  padding: 1rem;
  margin-bottom: 1rem;
}

.post-header {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  border-bottom-color: #888;
}

.post-header img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
}

.post-header a.username {
  display: flex;
  align-items: center;
  font-weight: bold;
  color: gold;
  text-decoration: none;
}

.verified-badge {
  display: inline-block;
  position: relative;
  width: 16px;
  height: 16px;
  margin-left: 6px;
}

.verified-badge .fa-certificate {
  color: #1877f2;
  font-size: 16px;
}

.verified-badge .checkmark {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 9px;
  color: white;
  pointer-events: none;
}

.post-content {
  margin-top: 10px;
}
.post-content a {
  word-wrap: break-word;       /* Permet de couper les mots trop longs */
  overflow-wrap: anywhere;     /* Plus moderne, coupe le texte quand nÃ©cessaire */
  white-space: pre-wrap;       /* Garde les retours Ã  la ligne si prÃ©sents */
  max-width: 100%;             /* EmpÃªche le dÃ©passement horizontal */
  display: inline-block;       /* S'assure que le lien respecte le conteneur */
    }
                       
.post video,
.post .text-bg {
  width: 100%;
  border-radius: 1px;
  margin-top: 10px;
}

.text-bg {
  display: inline-block;
  padding: 0.5rem 1rem;
  font-weight: bold;
  color: #fff;
  text-align: center;
  white-space: pre-wrap;
  max-width: 90%;
}

.post-actions {
  display: flex;
  justify-content: space-between; /* espace entre left-center-right */
  align-items: center;
  width: 100%;
  padding: 5px 10px;
  box-sizing: border-box;
  border-top: 1px solid #ddd; /* optionnel, juste pour sÃ©paration visuelle */
}

.post-actions .left,
.post-actions .center,
.post-actions .right {
  display: flex;
  align-items: center;
}

.post-actions .center {
  flex: 1;
  justify-content: center;
  text-align: center;
}

.post-actions i {
  margin-right: 5px;
  cursor: pointer;
  font-size: 120%;
}

.post-actions span {
  margin-right: 10px;
}

.post-actions button.boost-btn {
  margin-left: 10px;
  padding: 2px 6px;
  cursor: pointer;
}
.like.liked {
  color: #1877f2;
}
.like {
  cursor: pointer;
  font-size: 1.2rem;
  transition: color 0.3s ease;
}

.fa-heart.liked {
  color: #1877f2 !important; /* ğŸ’™ bleu Facebook */
}
    .fa-heart {
     
    }
.boost-btn {
  background: #FFA500;
  color: #fff;
  padding: 5px 10px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
    /* === COMMENTS ===================================== */
    .comments-section{margin-top:30px;border-top:1px solid #ccc;padding-top:10px;max-height:500px;overflow-y:auto;direction:ltr}
    .comment{direction:ltr;unicode-bidi:plaintext;text-align:left;word-break:break-word}
    .comment strong{color:#1877f2}
    .comment-input{display:flex;gap:14px;margin-top:14px}
    .comment-input input{flex:1;height:30px;padding:12px;border-radius:5px;border:1px solid #ccc;font-size:14px;width:100px;height:60px;}
    .comment-input button{padding:5px 9px;background:#FFA500;color:#fff;border:none;border-radius:8px;cursor:pointer}

    /* === ACCOUNT FORMS ================================= */
    #emailLoginBox,#emailSignupBox{
      background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,.1);margin-bottom:15px
    }
    #emailLoginBox input,#emailSignupBox input{margin-bottom:10px}
    #emailLoginBox button,#emailSignupBox button{color:#fff;border:none;padding:10px;font-weight:bold;border-radius:6px;cursor:pointer;width:100%}
    #emailLoginBox button:hover,#emailSignupBox button:hover{background:#145ec1}
    #accountStatus{margin-top:10px;font-weight:bold;color:gold}
    #authStatus{margin-top:10px;font-weight:bold;color:#555}

    /* === USER FEED ==================================== */
    #userFeedContent .post{/* inherits .post styles */}
    .follow-btn{
  padding:2px 3px;border:none;border-radius:4px;font-size:12px;
  cursor:pointer;background:#FFA500;color:#fff
}
      .circle {
          width: 4rem;
          aspect-ratio: 1 / 1;
          border-radius: 50%;
      }
.verified-badge {
  display: inline-block;
  position: relative;
  width: 16px;
  height: 16px;
  margin-left: 6px;
  vertical-align: middle;
}

.verified-badge .fa-certificate {
  color: #1877f2;
  font-size: 16px;
}

.verified-badge .checkmark {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 9px;
  color: white;
  pointer-events: none;
} 
.boutons {
  display: flex;
  justify-content: center;
}

.boutons button {
  margin: 8px;
}
        #bouton-lundi {
            display: none; /* Masquer le bouton par dÃ©faut */
        }
        .row-info {
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  font-family: sans-serif;
  font-size: 16px;
  border-bottom: 1px solid #ddd;
}

.label {
  font-weight: bold;
}

.value {
  color: #333;
}
hr {
   background-color: #fff;
   height: 0.5%;
   width: 100%;
   border-radius: 15px;
}
  /* Style du modal */
  .modal {
    display: none; /* cachÃ© par dÃ©faut */
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background: white;
    margin: 15% auto;
    padding: 20px;
    width: 300px;
    border-radius: 8px;
    text-align: center;
  }
  .close {
    float: right;
    cursor: pointer;
    font-size: 20px;
  }

    .mention {
  color: gold;
  font-weight: bold; /* optionnel pour faire ressortir */
  text-decoration: none; /* supprime le soulignement si tu veux */
  cursor: pointer; /* indique que câ€™est cliquable */
}
#mentionSuggestions {
    display:none; position:absolute; background:#fff; border:1px solid #ccc; border-radius:6px; padding:4px; max-height:400px; overflow-y:auto; z-index:1000;
}
    audio::-webkit-media-controls-play-button {
    background-color: gold;
    border-radius: 50%;
    transform: scale(1.4);
  }

  audio::-moz-media-controls-play-button {
    background-color: gold;
    border-radius: 50%;
    transform: scale(1.4);
  }

  audio {
    filter: drop-shadow(0 0 0.75rem rgba(0, 0, 0, 0.1));
    }
    
 </style>
</head>
<body>
<header>
  <div class="logo" onclick="location.reload()">Mboa Skills</div>
  <div class="icons">
    <i class="material-icons-outlined tablinks selected" onclick="openTab(event,'home'); window.scrollTo({ top: 0, behavior: 'smooth' });">home</i>
    <i class="material-icons-outlined tablinks" onclick="openTab(event,'music')">music_note</i>
    <i class="material-icons-outlined tablinks" onclick="openTab(event,'videoFeed')">image</i>
    <i class="material-icons-outlined tablinks" onclick="openTab(event,'post')">add</i>
    <i class="material-icons-outlined tablinks" onclick="openTab(event,'search')">search</i>
    <i class="material-icons-outlined tablinks" onclick="openTab(event,'account')">person</i>
  </div>
</header>
<!-- ============ HOME ============ -->
<section id="home" class="tabcontent active">
  <br><br/>
  <div class="post-header">
    <img id="homeProfilePhoto" src="https://via.placeholder.com/40" onclick="openTab(event,'feedme')"/>
  <p id="authStatus"></p>
    <p id="accountStatus"></p>
  </div>
  <hr>
    <div class="post-header">
    <img class="circle" src="https://ucarecdn.com/6feb4363-11a1-476d-ab2a-b577ec622144/-/preview/1000x1000/" onclick="window.open('https://www.appcreator24.com/app3638117-t0p691')"> <i class="fas fa-download" style="color:gold"></i>
<i class="fas fa-flag" onclick="openTab(event,'profilimg')" style="font-size:200%;color:gold"></i>
      <hr>
  </div>
  <div id="feed"></div>
</section>

<!-- ============ POST ============ -->
<section id="post" class="tabcontent">
     <br><br/>
   <div id="emailLoginBox">
  <h2>Publier du texte</h2>
  <textarea id="postText" placeholder="Exprimez-vous..." style="height:15%"></textarea>
  
  <!-- Zone de suggestions de mentions -->
  <div id="mentionSuggestions"></div>

  <!-- SÃ©lecteur de couleur de fond -->
  <label>
    <i class="fas fa-palette" style="color: orange;"></i>
    <input type="color" id="bgColor" value="#FFA500"/>
  </label>
      <!-- Bouton de publication -->
  <button onclick="publishPost()">Publier</button>

  </div>
  <hr/>
<div id="emailLoginBox">
  <h2>Publier une image</h2>
  <input type="file" id="imageFile" accept="image/*" />
  <textarea id="imageTitle" placeholder="Titre de l'image" style="height:8%"></textarea>
    <!-- Bouton de publication -->
  <button onclick="publishPost()">Publier</button>

  </div>

  <p id="status" style="color:limegreen"></p>
</section>
<!-- ============ VIDEO FEED ============ -->
<section id="videoFeed" class="tabcontent">
  <h3>Des images pour vous</h3>
  <div id="videoFeedContent"></div>
</section>

<!-- ============ TOTAL VIEWS ============ -->
<section id="totalViewsSection" class="tabcontent">
  <h3>Total des vues</h3>
  <label for="periodSelect">PÃ©riode :</label>
<select id="periodSelect">
  <option value="all">Tout</option>
  <option value="week">7 derniers jours</option>
  <option value="month">Dernier mois</option>
  <option value="year">DerniÃ¨re annÃ©e</option>
</select>
    <div id="emailLoginBox">
<div class="row-info">
  <span class="label">Vues:</span>
  <span class="value">
    <p id="totalViewsCount" style="background-color:orange">Chargement...</p>
  </span>
</div>
<div class="row-info">
  <span class="label">Disponible Ã  retirer:</span>
  <span class="value">
    <p id="currentBalance">XAF</p>
  </span>
</div>

  <button onclick="openTab(event,'choises')">retirer</button>

</div>
<div id="emailLoginBox">
    <h3>Outils de monetisation <i class="fas fa-coins"></i></h3>
<div class="row-info">
  <span class="label">texte+image:</span>
  <span class="value"><i class="fas fa-check-circle" style="color:#1877f2;"></i></span>
</div>
<div class="row-info">
    <span class="label">musique:</span>
    <span><i class="fas fa-check-circle" style="color:#1877f2;"></i></span>
</div>
<div class="row-info">
    <span class="label">soutient:</span>
    <span><p id="gagne" style="font-size:18px;display:inline-block;margin-left:6px;"></p>
</span>
</div>
<div class="row-info">
    <span class="label">Bonus:</span>
    <span><i class="fas fa-check-circle" style="color:#1877f2;"></i></span>
</div>
  </div>
</section>

<!-- ============ SEARCH ============ -->
<section id="search" class="tabcontent">
  <h3>Rechercher un utilisateur</h3>
  <input type="text" id="searchUserInput" placeholder="Nom ou e-mail de l'utilisateur" />
  <button onclick="searchUser()">Rechercher</button>
    <div id="emailLoginBox">
  <div id="searchResults"></div>
  </div>
</section>
<section id="retrait" class="tabcontent">
  <br><br/>
  <div id="emailLoginBox">
  <label for="withdrawAmount">Montant Ã  retirer :</label><br>
  <input type="number" id="withdrawAmount" placeholder="min: 5000 XAF" min="5000" required style="width: 100%; margin-bottom: 10px;"><br>

  <label for="withdrawPhone">NumÃ©ro de tÃ©lÃ©phone :</label><br>
  <input type="tel" id="withdrawPhone" placeholder="Ex: +225xxxxxxx" required style="width: 100%; margin-bottom: 15px;"><br>

  <button onclick="withdrawBalance()" style="padding: 10px 20px; background-color: #1877f2; color: white; border: none; border-radius: 5px;">
    Retirer
  </button>
  <p id="withdrawStatus"></p>
  <p><i class="fas fa-info-circle" style="color:#gold"></i>NB: n'oubliez pas 
  l'indicatif du pays (Ex: +237)</p>
</div>
</section>
<section id="choises" class="tabcontent">
 <br><br/>
 <img src="https://ucarecdn.com/9e557b3e-8112-4472-9858-129187eb3749/-/preview/300x168/" style="width:100%;height:100px" onclick="openTab(event,'retrait')">MTN Momo
 <br><br/>
 <img src="https://ucarecdn.com/8213fd5f-4a33-4603-8bc3-98bb69e55ac0/-/preview/258x195/" style="width:100%;height:100px" onclick="openTab(event,'retrait')">Orange Money
 <br><br/>
 <img src="https://ucarecdn.com/b69beeaa-28fc-4b35-940e-fdb83daf5a1d/-/preview/417x417/" style="width:100%;height:100px">Carte Visa/Mastercard
</section>
<!-- ============ ACCOUNT ============ -->
<section id="account" class="tabcontent">
   <br><br/>
   <div id="emailLoginBox">
  <div class="post-header">
<button onclick="openTab(event,'profilimg')">mon pays <i class="fas fa-flag"></i></button></div>
      <div class="boutons">
    <button onclick="openTab(event,'conect')">Connexion</button>
    <button onclick="openTab(event,'inscrip')">Inscription</button>
    
  <button onclick="signInWithGoogle()"><i class="fab fa-google"></i> Continuer avec Google</button>
  </div>
  </div>
  </div>
  <hr/>
  <button onclick="signOutUser()" style="background-color:red">Se dÃ©connecter</button>
  <br/><br/>
  <div class="boutons">
<button style="background-color:transparent">
      <u><a href="https://www.facebook.com/profile.php?id=61579222796795">contact support</a> <i class="fab fa-facebook" style="color:#1877f2"></i></u>
  </button>
<button style="background-color:transparent"><u onclick="openTab(event,'condis')" style="background-color:black">CritÃ¨res a connaÃ®tre</u></button>
  </div>
</section>

<!-- ============ FEEDME (MY FEED) ============ -->
<section id="feedme" class="tabcontent">
  <h3>Mon profile</h3>
  <div class="post-header">
    <img id="feedmeProfilePhoto" src="https://via.placeholder.com/40" />
    <p style="color:gold" id="accountStatusFeed"></p><p id="icon">
        <span class="verified-badge">
        <i class="fas fa-certificate"></i>
        <i class="fas fa-check checkmark"></i>
</span>
</p>
    <label for="profilePhotoInput" title="Changer la photo"><i class="fas fa-camera" style="cursor:pointer;font-size:150%;color:#888"></i></label>
    <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" /> <br><br/>
    <i class="fas fa-pen" onclick="openTab(event,'modifie-pro')"></i>
    </div>
    <div class="boutons">
  <input id="profile-link" type="text" readonly style="width:100%;padding:8px" />
  <button id="copy-link-btn"> <i class="fas fa-share"></i></button>
  </div>
  <div class="boutons">
  <button onclick="openTab(event,'vibo')">Deposer<i class="fas fa-sack-dollar"></i></button>    
  <button id="certify-btn" onclick="certifyUser()">Se certifier</button>
  <button onclick="openTab(event,'totalViewsSection')">Retire<i class="fas fa-right-from-bracket"></i></button>
  </div>
  <div id="myFeed"></div>
</section>
<section id="profilimg" class="tabcontent">
      <br><br/>
    <div id="emailLoginBox">
  <label for="userCountry">Votre pays :</label>
  <select id="userCountry">
    <option value="1">Cameroun ğŸ‡¨ğŸ‡²</option>
    <option value="2">CÃ´te dâ€™Ivoire ğŸ‡¨ğŸ‡®</option>
    <option value="3">Gabon ğŸ‡¬ğŸ‡¦</option>
    <option value="4">SÃ©nÃ©gal ğŸ‡¸ğŸ‡³</option>
    <option value="5">BÃ©nin ğŸ‡§ğŸ‡¯</option>
    <option value="6">RDC Congo ğŸ‡¨ğŸ‡©</option>
  </select>
  </div>
  <p>
    <i class="fas fa-info-circle" style="color:white"></i>
    Vous verrez plus de publications dans ce pays. NB : il s'enregistre selon votre choix.
  </p>
</section>

<!-- ============ BOOST VIDEO LIST ============ -->
<section id="video" class="tabcontent">
  <div class="post-header">
      
<button onclick="openTab(event,'videoFeed')">Pour toi <i class="fas fa-video tablinks"></i>
 </button>     
  </div>
  <div id="videoFeedContentBoost"></div>
</section>

<!-- ============ BOOST PANEL ============ -->
<section id="vibo" class="tabcontent">
 <h3>Recharger mon compte</h3>
  <div id="emailLoginBox">
  <div class="post-header">
  <input type="number" id="montant" placeholder=" min: 150 XAF" min="150" style="padding: 6px; width: 150px;">
  <button id="notchpayBtn" style="padding: 6px 12px; background-color: #1877f2; color: white; border: none; border-radius: 4px; cursor: pointer;">
    Deposer
  </button>
</div> 
   
<b>Argent: <span id="argent">0</span> XAF</b>
    </div>
      <hr>
       <h3>Booster une publication</h3>
 <div id="boostPanel" style="display:none;margin-bottom:10px">
  <span id="boostStatus" style="font-weight:bold"></span>
  <input type="number" id="boostViews" placeholder="Nombres de personnes/jour" min="4000"/>
  <select id="boostCountry">
    <option value="1">Cameroun</option>
    <option value="2">CÃ´te dâ€™Ivoire</option>
    <option value="3">Gabon</option>
    <option value="4">SÃ©nÃ©gal</option>
    <option value="5">Benin</option>
    <option value="6">RDC Congo</option>
  </select>
  <button onclick="boostPost()">Booster</button>
</div>  <br>
  <p><i class="fas fa-info-circle" style="color:#fff"></i> minimum 2 jours (min: 2j pour 3500 XAF)</p>
</section>

<!-- ============ LOGIN FORM ============ -->
<section id="conect" class="tabcontent">
  <h3>Connectez-vous</h3>
  <div id="emailLoginBox">
    <input type="email"    id="loginEmail"    placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Mot de passe" />
   <p>
  <a href="#" onclick="openTab(event,'oublie')">Mot de passe oubliÃ© ?</a>
</p> 
    <button onclick="loginWithEmail()">Se connecter</button>
  </div>
</section>
<section id="oublie" class="tabcontent">
<br><br/> 
  <div id="emailLoginBox">
  <h3>RÃ©initialiser le mot de passe</h3>
  
  <input type="email" id="resetEmail" placeholder="Votre email" />
  
  <button onclick="sendResetLink()">Envoyer le lien</button>
  </div>
</section>
<!-- ============ SIGNUP FORM ============ -->
<section id="inscrip" class="tabcontent">
  <h3>Inscription</h3>
  <div id="emailSignupBox">
   <input type="text"
       id="signupName"
       placeholder="Nom complet"
       pattern="[a-zA-ZÃ€-Ã¿0-9\s]+"
       required/>  
    <input type="email"    id="signupEmail"    placeholder="Email" />
    <input type="password" id="signupPassword" placeholder="Mot de passe (â‰¥ 6 car.)" />
    <input type="number"   id="signupAge"      placeholder="Ã‚ge (min 18)" min="18" />
    <button onclick="signupWithEmail()">Sâ€™inscrire</button>
  </div>
</section>

<!-- ============ OTHER USER FEED ============ -->
<section id="userFeed" class="tabcontent">
  <h3 id="userFeedTitle">Publications de â€¦</h3>
  <div id="userFeedContent"></div>
</section>
<section id="amis" class="tabcontent">
 <i class="fas fa-arrow-left" onclick="openTab(event,'home')"></i>
   <div class="post-header">
    promotion social â¡ï¸ <img class="circle"  src="https://ucarecdn.com/04a9cc78-e2a1-4e71-baa0-b83b5de179ed/-/preview/417x417/" onclick="window.open('https://followersmanager.netlify.app')"/>
    
   </div>
<div id="suggestions">
  <h3>Vous connaissez peut-Ãªtre :</h3>
  <div id="suggestionsList">Chargementâ€¦</div>
</div>
</section>
<!-- ============ MUSIC FEED ============ -->
<section id="music" class="tabcontent">
  <br><br/>

  <!-- Bouton importer musique -->
  <div class="boutons">
    <button onclick="openTab(event,'mus')">
      Importer ma musique <i class="fas fa-upload"></i>
    </button>
  </div>

  <!-- Titre -->
  <h2 style="text-align:center; margin: 1rem 0; color: #000000;">
    ğŸ§ Musiques valides (30 jours max)
  </h2>

  <!-- Conteneur du feed musique -->
  <div id="musicFeed">
    <p style="text-align:center; color:#888;">Chargement des musiquesâ€¦</p>
  </div>
</section>
<section id="mus" class="tabcontent"> 
<br><br/>
  <div id="emailLoginBox">
  <h2>Publier un morceau</h2>  
  <input type="text" id="nom" placeholder="Votre nom d'artiste" />  
  <input type="text" id="titre" placeholder="Titre de la musique" />  
  <input type="file" id="audioFile" accept="audio/*" />  
  <button onclick="publishMusic()">Publier</button>  
  </div>
  <div id="statusMsg"></div> 
  <button onclick="openTab(event,'my-music')">Ma musique </button>
</section>  
  <!-- ============ MES MUSIQUES ============ -->
<section id="my-music" class="tabcontent">
  <h3 style="color: gold; text-align:center;">ğŸ¶ Mes musiques</h3>

  <div id="myMusicList">Chargementâ€¦</div>
</section>
<!-- ============ MUSIC PLAYER ============ -->
<section id="musicPlayer" class="tabcontent">
    <br><br/>
  <div id="openMusicById"></div>
</section>
<section id="condis" class="tabcontent">
  <h2> CritÃ¨res generales de monetisation :

</h2> 
   <div>
En crÃ©ant votre compte sur mboa skills vous acceptez les conditions d'utilisation de l'application.
<p style="color:gold">Outils de MonÃ©tisation:</p> Disponible partout en Afrique. <u style="color:blue">texte+image</u> , <u style="color:blue">soutient</u> , <u style="color:blue">musique</u> , <u style="color:blue">Bonus</u>
<hr>
<p style="color:gold">Publications :</p> Ã€ chaque fois que tu publie une image oÃ¹ du texte tu gagnes <u style="color:blue">RPM: 350XAF</u> pour chaque 1k de vues affligÃ© Ã  ta publication ; 
<p style="color:gold">soutient:</p>
pour avoir cet outil vous devez avoir au moins 100 followers;
<p style="color:gold">Musique-pub:</p>Disponible chaque lundi de la semaine,pour partager ta musique cela nÃ©cessite un montant de <u style="color:blue">1500XAF</u> ;
<p style="color:gold">musique-pay:</p> avec ta musique tu gagnes <u style="color:blue">55XAF</u> Ã  chaque fois que quelqu'un Ã©coute ta musique, tu peux gagner jusqu'Ã  <u style="color:blue">55 000XAF</u> pour 1k d'Ã©coute ;
<p style="color:gold">Certification:</p> pour Ãªtre certifiÃ© tu dois rÃ©pondre aux critÃ¨res d'Ã©ligibilitÃ© (tes informations doivent Ãªtre juste ce qui nÃ©cessite un temps prÃ©cis); Dans le cas contraire pour Ãªtre certifiÃ© il te faudra dÃ©penser un montant de <u style="color:blue">18 000XAF</u>.

L'application mboa skills est disponible partout dans le monde (la monÃ©tisation est Disponible) Le systÃ¨me du dÃ©pÃ´t fonctionne sans problÃ¨me ainsi que celui du retrait ;
<p style="color:gold">Retrait/DÃ©pÃ´t :</p> Disponible <u style="color:blue">24h/24 </u> & <u style="color:blue">7j/7</u>. MTN et orange Money uniquement (pour le cas du Cameroun)
<br><br/>
  <p><i class="fas fa-info-circle" style="color:#fff"></i> N'oubliez pas de nous suivre sur <u style="color:blue">Facebook</u> merci.
   </div> 
   <hr>
</section>
<section id="mabio" class="tabcontent" style="display:none;padding:15px">
 <br><br/>
  <h2>Modifier ma bio</h2>
  <textarea id="bioInput" placeholder="Ã‰cris quelque chose sur toi..." 
    style="width:100%;height:120px;padding:8px;border-radius:8px;border:1px solid #ccc;font-size:15px;"></textarea>
  <br>
  <button id="saveBioBtn" 
    style="margin-top:8px;background:#1877f2;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;">
    ğŸ’¾ Enregistrer
  </button>
  <p id="bioStatus" style="color:green;margin-top:6px;font-size:14px;"></p>
</section>
<section id="modifie-pro" class="tabcontent">
  <h2>Modifier mon nom</h2>

  <label for="newName">Nouveau nom :</label>
  <input
    type="text"
    id="newName"
    placeholder="Entrez votre nouveau nom"
    style="width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:6px;"
  />

  <button
    id="saveNameBtn"
    style="margin-top:10px;padding:10px 15px;background:#1877f2;color:white;border:none;border-radius:6px;cursor:pointer;"
  >
    Sauvegarder
  </button>

  <p id="nameStatus" style="margin-top:10px;color:#444;"></p>
</section>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // âš¡ Mets ici tes infos Supabase
  const SUPABASE_URL = "https://hhwbfmkpciktpukvzztf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhod2JmbWtwY2lrdHB1a3Z6enRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNjM5NjYsImV4cCI6MjA2OTczOTk2Nn0.J6DCrtHas9hXPSaP8JQnAnj331nCJ2sv809IJeHc-Lw"; 

  // Initialiser le client Supabase
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  console.log("âœ… Supabase prÃªt :", supabaseClient);
</script>
<script type="module">

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. IMPORTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/


import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
import {
  getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider,
  updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
import {
  getFirestore,
  collection, addDoc, onSnapshot, query, orderBy, where,
  doc, getDocs, getDoc, setDoc, updateDoc,
  increment, serverTimestamp, runTransaction,
  deleteDoc, limit
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js';
import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  2. CONFIG & GLOBALS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const firebaseConfig = {
  apiKey:            "AIzaSyClSjd2LrIQpaJoVWO32vFRx7I9cvmDgBo",
  authDomain:        "mboa-ec602.firebaseapp.com",
  projectId:         "mboa-ec602",
  storageBucket:     "mboa-ec602.appspot.com",
  messagingSenderId: "498505132403",
  appId:             "1:498505132403:web:eb46547745f8d1a77b3d06"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const stg  = getStorage(app);
const provider = new GoogleAuthProvider();

let currentUser=null, likedPosts=new Set(), followingIds=new Set();
let boostId='', currentBalance=0;

const qs=id=>document.getElementById(id);
const fmt=n=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'k':n;

(async () => {
  const params = new URLSearchParams(location.search);
  const amount = parseFloat(params.get("amount"));
  const uid = params.get("uid");
  const ref = params.get("ref");

  if (amount > 0 && uid && ref && currentUser?.uid === uid) {
    // EmpÃªche double ajout
    const refDoc = doc(db, 'walletPayments', ref);
    const existing = await getDoc(refDoc);
    if (!existing.exists()) {
      // CrÃ©dite le solde
      const walletRef = doc(db, 'wallets', uid);
      await runTransaction(db, async t => {
        const snap = await t.get(walletRef);
        const old = snap.exists() ? snap.data().balance : 0;
        t.set(walletRef, { balance: old + amount }, { merge: true });
      });
      // Marque la transaction comme enregistrÃ©e
      await setDoc(refDoc, { uid, amount, createdAt: serverTimestamp() });
      alert(`Paiement rÃ©ussi : ${amount} FCFA ajoutÃ© Ã  votre solde`);
      location.href = location.origin + location.pathname; // Nettoyer l'URL
    }
  }
})();
(async () => {
  const params = new URLSearchParams(location.search);
  const amount = parseFloat(params.get("amount"));
  const uid = params.get("uid");
  const ref = params.get("ref");

  if (amount > 0 && uid && ref && currentUser?.uid === uid) {
    const refDoc = doc(db, 'walletPayments', ref);
    const existing = await getDoc(refDoc);
    if (!existing.exists()) {
      const walletRef = doc(db, 'wallets', uid);
      await runTransaction(db, async t => {
        const snap = await t.get(walletRef);
        const old = snap.exists() ? snap.data().balance : 0;
        t.set(walletRef, { balance: old + amount }, { merge: true });
      });
      await setDoc(refDoc, { uid, amount, createdAt: serverTimestamp() });
      alert(`Paiement rÃ©ussi : ${amount} FCFA ajoutÃ© Ã  votre solde`);
      location.href = location.origin + location.pathname;
    }
  }
})();
// ===================================
// ===========================================================
// ğŸ”¹ IncrÃ©menter une vue unique + ajouter gain (0.2 FCFA au propriÃ©taire du post)
// ===========================================================
async function incrementView(postId) {
  if (!currentUser) return;

  try {
    const postRef = doc(db, "posts", postId);
    const userViewRef = doc(db, "posts", postId, "viewsByUser", currentUser.uid);

    // VÃ©rifier si la vue existe dÃ©jÃ 
    const userViewSnap = await getDoc(userViewRef);
    if (userViewSnap.exists()) {
      console.log("ğŸ‘€ Vue dÃ©jÃ  enregistrÃ©e pour ce post:", postId);
      return;
    }

    // RÃ©cupÃ©rer le post pour trouver son propriÃ©taire
    const postSnap = await getDoc(postRef);
    if (!postSnap.exists()) {
      console.warn("âš ï¸ Post introuvable:", postId);
      return;
    }
    const postData = postSnap.data();
    const ownerId = postData.userId;
    if (!ownerId) {
      console.warn("âš ï¸ Pas de userId dans le post:", postId);
      return;
    }

    // ğŸ”¹ RÃ©fÃ©rence du solde du propriÃ©taire du post
    const soldeRef = doc(db, "soldes", ownerId);

    // Marquer la vue
    await setDoc(userViewRef, { seenAt: new Date() });
    console.log("âœ… Nouvelle vue enregistrÃ©e:", postId);

    // IncrÃ©menter le compteur du post
    await updateDoc(postRef, { views: increment(1) });
    console.log("ğŸ“ˆ Post incrÃ©mentÃ© de +1 vue");

    // GÃ©rer le gain du propriÃ©taire
    await runTransaction(db, async (t) => {
      const sSnap = await t.get(soldeRef);

      if (sSnap.exists()) {
        const data = sSnap.data();
        const currentGain = typeof data.gainVues === "number" ? data.gainVues : 0;
        const currentTotal = typeof data.totalViews === "number" ? data.totalViews : 0;

        console.log("ğŸ’° Solde avant:", currentGain, "Total vues:", currentTotal);

        t.update(soldeRef, {
          gainVues: currentGain + 0.25,
          totalViews: currentTotal + 1,
          updatedAt: new Date()
        });

      } else {
        console.log("ğŸ†• CrÃ©ation du document solde pour le propriÃ©taire:", ownerId);
        t.set(soldeRef, {
          montant: 0,
          gainVues: 0.25,
          totalViews: 1,
          lastViewsCount: 1,
          createdAt: new Date(),
          updatedAt: new Date()
        });
      }
    });

    console.log("âœ… Transaction solde effectuÃ©e pour le propriÃ©taire du post !");
    if (typeof refreshBalanceDisplay === "function") refreshBalanceDisplay();

  } catch (e) {
    console.error("âŒ Erreur incrÃ©ment vue:", e);
  }
}
// ===========================================================
// ğŸ”¹ Observer les posts pour compter les vues visibles â‰¥ 6s
// ===========================================================
const timers = new Map();

const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    const postId = entry.target.dataset.post;
    if (!postId) return;

    if (entry.isIntersecting) {
      if (timers.has(postId)) return;

      const timer = setTimeout(() => {
        console.log("ğŸ‘ï¸ Vue validÃ©e aprÃ¨s 6s pour:", postId);
        incrementView(postId);
        observer.unobserve(entry.target);
        timers.delete(postId);
      }, 6000);

      timers.set(postId, timer);
    } else {
      if (timers.has(postId)) {
        clearTimeout(timers.get(postId));
        timers.delete(postId);
      }
    }
  });
}, { threshold: 0.5 });

function observeRenderedPosts() {
  document.querySelectorAll('[data-post]').forEach(el => observer.observe(el));
}
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  3. DOM READY â€” DÃ©pÃ´t
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
document.addEventListener('DOMContentLoaded',()=>{
  qs('deposer')?.addEventListener('click',()=>{
    const m=parseFloat(qs('montant').value);
    if(isNaN(m))return alert('Entrez un montant');deposit(m);qs('montant').value='';
  });
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  4. NAVIGATION & SHUFFLE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
 window.openTab = (evt, id) => {
  const tab = document.getElementById(id);
  const isAlreadyActive = tab.classList.contains('active');

  // ğŸ” Cas : on clique sur l'onglet dÃ©jÃ  actif
  if (isAlreadyActive) {
    const isAtTop = window.scrollY <= 10;
    if (isAtTop) {
      // ğŸŸ¢ DÃ©jÃ  en haut â†’ recharger toute la page
      location.reload();
    } else {
      // ğŸ”¼ Scroll vers le haut + shuffle si on est sur "home"
      window.scrollTo({ top: 0, behavior: 'smooth' });
      if (id === 'home') {
        shuffleFeed();
        renderFeed();
      }
            if (id === 'music') {
        shuffleFeed();
        renderMusicFeed();
      }
      if (id === 'videoFeed') {
        shuffleFeed();
        renderVideoFeed();
      }

    }
    return; // â›”ï¸ Ne pas continuer : pas de changement dâ€™onglet
  }

  // ğŸ†• Cas : on change dâ€™onglet â†’ juste activer le nouvel onglet
  document.querySelectorAll('.tabcontent').forEach(t => t.classList.toggle('active', t.id === id));
  document.querySelectorAll('.tablinks').forEach(l => l.classList.toggle('selected', l === evt.currentTarget));
  history.pushState({ tab: id }, '', `#${id}`);


// Ajouter l'Ã©vÃ©nement popstate pour gÃ©rer le bouton retour
window.addEventListener('popstate', (event) => {
  if (event.state && event.state.tab) {
    const tabId = event.state.tab;
    document.querySelectorAll('.tabcontent').forEach(t => t.classList.toggle('active', t.id === tabId));
    document.querySelectorAll('.tablinks').forEach(l => l.classList.toggle('selected', l.getAttribute('onclick').includes(tabId)));
  }
});

window.addEventListener('load', () => {
  const hash = window.location.hash.substring(1);
  if (hash) {
    const tab = document.getElementById(hash);
    if (tab) {
      document.querySelectorAll('.tabcontent').forEach(t => t.classList.toggle('active', t.id === hash));
      document.querySelectorAll('.tablinks').forEach(l => l.classList.toggle('selected', l.getAttribute('onclick').includes(hash)));
    }
  }
});

  // âœ… On NE FAIT RIEN Dâ€™AUTRE ! Ni shuffle, ni render ici.
  // Pas de renderFeed(), pas de shuffleFeed()
  // â†’ Lâ€™Accueil ne doit jamais Ãªtre modifiÃ© juste en y revenant
};
function shuffleFeed() {
  ['feed', 'videoFeed', 'content', 'musicFeed'].forEach(feedId => {
    const c = document.getElementById(feedId);
    if (!c) return; // si le feed n'existe pas
    const n = [...c.children];
    for (let i = n.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [n[i], n[j]] = [n[j], n[i]];
    }
    n.forEach(el => c.appendChild(el));
  });
}


// Lancer le mÃ©lange au chargement
window.addEventListener('load', shuffleFeed);
  // On rÃ©cupÃ¨re toutes les icÃ´nes
const icons = document.querySelectorAll("header .icons i");

icons.forEach(icon => {
  icon.addEventListener("click", () => {
    // Supprime la classe active de toutes les icÃ´nes
    icons.forEach(i => i.classList.remove("active"));
    // Ajoute la classe active Ã  lâ€™icÃ´ne cliquÃ©e
    icon.classList.add("active");
  });
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  5. AUTH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
window.signInWithGoogle=()=>signInWithPopup(auth,provider).catch(e=>alert(e.message));
window.signOutUser=()=>signOut(auth);

onAuthStateChanged(auth,async user=>{
  currentUser=user;
  const p=user?.photoURL||'https://ucarecdn.com/d98b5778-d5ca-4460-bff0-3b1b423117cd/-/preview/1000x999/';
  qs('homeProfilePhoto').src=p;qs('feedmeProfilePhoto').src=p;
  qs('authStatus').textContent=user?` ${user.displayName||user.email}`:'';
  qs('accountStatus').textContent=user?`â€¢ ${user.displayName||user.email}`:'';
  qs('accountStatusFeed').textContent=qs('accountStatus').textContent;
  const btn = document.getElementById("certify-btn");
const iconPara = document.getElementById("icon"); // Ajouter une rÃ©fÃ©rence Ã  l'Ã©lÃ©ment <p id="icon">
if (!btn) return; // SÃ©curitÃ© : bouton pas encore dans le DOM
if (!user) {
  btn.style.display = "none";
  iconPara.style.display = "none"; // Masquer le paragraphe si l'utilisateur n'est pas connectÃ©
  return;
}

const verifiedRef = doc(db, 'verified', user.uid);
try {
  const snap = await getDoc(verifiedRef);
  const isVerified = snap.exists() && snap.data().status === true;
  if (isVerified) {
    btn.style.display = "none"; // âœ… Masquer si certifiÃ©
    iconPara.style.display = "block"; // Afficher le paragraphe si certifiÃ©
  } else {
    btn.style.display = "block"; // âœ… Montrer si NON certifiÃ©
    iconPara.style.display = "none"; // Masquer le paragraphe si non certifiÃ©
  }
} catch (error) {
  console.error("Erreur lors de la vÃ©rification du statut :", error);
  // Par sÃ©curitÃ©, on masque si erreur
  btn.style.display = "none";
  iconPara.style.display = "none"; // Masquer le paragraphe en cas d'erreur
}
    if (user) {
      currentUser = user;
      await loadUserCountry();
    } else {
      currentUser = null;
    }
  

  if (user) {
    await loadFollowing();  // fonction qui initialise followingIds
    loadSuggestions();      // charge les suggestions
  }

if (user) {
    showProfileLink(user.uid);
  }
  if(user){
    await loadWallet(); await loadFollowing(); await loadLikedPosts();
    renderFeed();renderMyFeed();renderVideoFeed();renderBoostFeed();
    await loadTotalViewsAndBalance();
  }else{
    likedPosts.clear();followingIds.clear();
    ['feed','myFeed','videoFeedContent','videoFeedContentBoost','userFeedContent'].forEach(id=>qs(id).innerHTML='');
    qs('totalViewsCount').textContent='';qs('currentBalance').textContent='Solde actuel: 0 FCFA';
  }
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/*  6. FOLLOW / FOLLOWERS (collection : faces)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/

/*  6. FOLLOW / FOLLOWERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadFollowing() {
  if (!currentUser) return;
  const s = await getDocs(collection(db, 'follows', currentUser.uid, 'list'));
  followingIds = new Set(s.docs.map(d => d.id));
}
window.renderFollowBtn = function (uid) {
  if (!currentUser || currentUser.uid === uid) return null;

  const btn = document.createElement('button');
  btn.className = 'follow-btn';

  const myListRef = doc(db, 'follows', currentUser.uid, 'list', uid); // relation individuelle
  const counterRef = doc(db, 'follows', uid); // compteur global

  // ğŸ”¹ Synchronisation temps rÃ©el pour savoir si je suis dÃ©jÃ  ce user
  onSnapshot(myListRef, snap => {
    const isFollowing = snap.exists();

    if (isFollowing) {
      btn.textContent = 'Ne plus suivre';
      btn.style.background = '#ccc';
      btn.style.color = '#000';
      btn.onclick = async () => {
        await deleteDoc(myListRef);
        try {
          await updateDoc(counterRef, { filo: increment(-1) });
        } catch (err) {
          console.error('Erreur dÃ©crÃ©mentation :', err);
        }
        followingIds.delete(uid);
      };
    } else {
      btn.textContent = 'Suivre';
      btn.style.background = '#1877f2';
      btn.style.color = '#fff';
      btn.onclick = async () => {
        await setDoc(myListRef, { date: serverTimestamp() });
        try {
          await updateDoc(counterRef, { filo: increment(1) });
        } catch {
          await setDoc(counterRef, { filo: 1 }, { merge: true });
        }
        followingIds.add(uid);
      };
    }
  });

  return btn;
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  7. WALLET dÃ©pÃ´t
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadWallet() {
  if (!currentUser) return;

  const walletRef = doc(db, "wallets", currentUser.uid);
  const walletSnap = await getDoc(walletRef);

  const balance = walletSnap.exists() ? walletSnap.data().balance : 0;
  qs("argent").textContent = balance.toFixed(0);
}

// ğŸŸ¢ Fonction de dÃ©pÃ´t
async function deposit(amount) {
  if (!currentUser) return alert("Connectez-vous d'abord.");
  if (!Number.isFinite(amount) || amount < 500)
    return alert("Montant minimum de dÃ©pÃ´t : 500 XAF");

  const walletRef = doc(db, "wallets", currentUser.uid);

  try {
    await runTransaction(db, async (transaction) => {
      const snap = await transaction.get(walletRef);
      const current = snap.exists() ? snap.data().balance || 0 : 0;
      const updated = current + amount;

      transaction.set(walletRef, { balance: updated }, { merge: true });
    });

    alert("DÃ©pÃ´t effectuÃ© avec succÃ¨s !");
    await loadWallet();
  } catch (e) {
    console.error("Erreur dÃ©pÃ´t :", e);
    alert("Erreur lors du dÃ©pÃ´t.");
  }
}
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  8. PUBLISH POST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
window.publishPost = async () => {
  if (!currentUser) return alert("Connectez-vous");

  const text = document.getElementById("postText").value.trim();
  const file = document.getElementById("imageFile").files[0];
  const tit = document.getElementById("imageTitle").value.trim();

  if (!text && !file) return alert("Ajoutez un texte ou une image");

  document.getElementById("status").textContent = "â³ Publicationâ€¦";

  let imageUrl = null;

  // upload image si prÃ©sente
  if (file) {
    const filePath = `posts/${Date.now()}_${file.name}`;
    const { data, error } = await supabaseClient.storage
      .from("media") // <-- ton bucket Supabase
      .upload(filePath, file);

    if (error) {
      console.error("Erreur upload Supabase:", error);
      return alert("Ã‰chec upload image.");
    }

    // rÃ©cupÃ©rer lâ€™URL publique
    const { data: urlData } = supabaseClient.storage.from("media").getPublicUrl(filePath);
    imageUrl = urlData.publicUrl;
  }

  // enregistrement Firestore
  await addDoc(collection(db, "posts"), {
    userId: currentUser.uid,
    userEmail: currentUser.email,
    userName: currentUser.displayName || currentUser.email,
    userPhoto: currentUser.photoURL || "https://via.placeholder.com/40",
    text,
    imageUrl,
    imageTitle: tit,
    views: 0,
    likes: 0,
    boosted: 0,
    createdAt: serverTimestamp()
  });
// ğŸ”¹ IncrÃ©mente le score de suggestion (+15% par post non boostÃ©)
const userRef = doc(db, "users", currentUser.uid);
await runTransaction(db, async (t) => {
  const snap = await t.get(userRef);
  let score = snap.exists() ? snap.data().suggestScore || 0 : 0;
  score = Math.min(score + 15, 100); // max 100 %
  t.set(userRef, { suggestScore: score }, { merge: true });
});
  // reset du formulaire
  document.getElementById("postText").value = "";
  document.getElementById("imageFile").value = "";
  document.getElementById("imageTitle").value = "";
  document.getElementById("status").textContent = "âœ… PubliÃ© !";
};
// Ã©coute du changement de fichier sur l'input
document.getElementById("profilePhotoInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  if (!currentUser) {
    alert("Connectez-vous avant de changer votre photo.");
    return;
  }

  try {
    const statusEl = document.getElementById("statusPhoto");
    if (statusEl) statusEl.textContent = "â³ Upload en cours...";

    // chemin du fichier (unique par user + timestamp)
    const filePath = `profiles/${currentUser.uid}_${Date.now()}_${file.name}`;

    // upload dans le bucket Supabase "media"
    const { data, error } = await supabaseClient.storage
      .from("media")
      .upload(filePath, file, { upsert: true });

    if (error) {
      console.error("Erreur upload Supabase:", error);
      alert("âŒ Ã‰chec upload image.");
      return;
    }

    // rÃ©cupÃ©rer l'URL publique
    const { data: urlData } = supabaseClient.storage.from("media").getPublicUrl(filePath);
    const imageUrl = urlData.publicUrl;

    // mettre Ã  jour l'utilisateur dans Firestore
    await updateDoc(doc(db, "users", currentUser.uid), {
      photoURL: imageUrl
    });

    // mettre Ã  jour dans Firebase Auth aussi (optionnel mais mieux)
    await updateProfile(currentUser, { photoURL: imageUrl });

    if (statusEl) statusEl.textContent = "âœ… Photo mise Ã  jour !";

    // afficher directement la nouvelle photo (si tu as une balise <img id="profilePhoto">)
    const imgEl = document.getElementById("profilePhoto");
    if (imgEl) imgEl.src = imageUrl;

  } catch (err) {
    console.error("Erreur upload photo :", err);
    alert("âŒ Erreur lors du changement de photo.");
  }
});
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  9. FEED ACCUEIL (boostÃ©s + suivis)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let firstRenderDone = false;
let cachedPosts = [];

// ===========================================================
// ğŸ”¹ Rendu du fil principal (Feed) + Suggestions alÃ©atoires (filtrÃ©es par pays, excluant les suivis et mÃ©langÃ©es)
// ===========================================================
async function renderFeed() {
  const c = qs('feed');
  c.textContent = 'Chargementâ€¦';

  if (!currentUser) return;

  // ğŸ”¹ On rÃ©cupÃ¨re le pays de l'utilisateur connectÃ©
  const userSnap = await getDoc(doc(db, "users", currentUser.uid));
  const userCountry = userSnap.exists() ? userSnap.data().countryIndex || 1 : 1;

  const now = Date.now();
  const sevenDays = 7 * 24 * 60 * 60 * 1000;
  const posts = [];

  // --- Utiliser le cache si dispo ---
  if (firstRenderDone && cachedPosts.length > 0) {
    const shuffled = [...cachedPosts];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    c.innerHTML = '';
    shuffled.forEach(p => {
      const el = card(p.id, p.data, false);
      c.appendChild(el);
      observer.observe(el);
    });
    return;
  }

  // --- BOOSTED POSTS filtrÃ©s par pays ---
  const qBoost = query(
    collection(db, 'posts'),
    where('boosted', '>', 0),
    orderBy('boosted', 'desc'),
    orderBy('createdAt', 'desc'),
    limit(30)
  );

  const snapBoost = await getDocs(qBoost);
  for (const docSnap of snapBoost.docs) {
    const data = docSnap.data();
    const boostAt = data.boostAt?.toMillis?.() || 0;
    const diffBoostDays = (now - boostAt) / (1000 * 60 * 60 * 24);

    const boostIndices = Array.isArray(data.boostIndex) ? data.boostIndex : [data.boostIndex];
    const isBoostedInUserCountry = boostIndices.includes(userCountry);

    if (diffBoostDays <= 2 && isBoostedInUserCountry) {
      posts.push({ id: docSnap.id, data });
    } else if (diffBoostDays > 2) {
      await updateDoc(doc(db, 'posts', docSnap.id), { boosted: 0 });
    }
  }

  // --- POSTS DES UTILISATEURS SUIVIS (3 rÃ©cents max par utilisateur) ---
  if (followingIds.size > 0) {
    for (const userId of followingIds) {
      const q = query(
        collection(db, 'posts'),
        where('userId', '==', userId),
        orderBy('createdAt', 'desc'),
        limit(10)
      );

      const snap = await getDocs(q);
      const recentPosts = snap.docs
        .map(d => ({ id: d.id, data: d.data() }))
        .filter(p => (now - (p.data.createdAt?.toMillis?.() || 0)) <= sevenDays);

      // MÃ©lange local
      for (let i = recentPosts.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [recentPosts[i], recentPosts[j]] = [recentPosts[j], recentPosts[i]];
      }

      posts.push(...recentPosts.slice(0, 3));
    }
  }

  // --- MÃ©lange global complet ---
  for (let i = posts.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [posts[i], posts[j]] = [posts[j], posts[i]];
  }

  cachedPosts = posts;
  firstRenderDone = true;

  // --- Affichage avec insertion alÃ©atoire de suggestions ---
  c.innerHTML = '';
  const insertIndex = Math.floor(Math.random() * (posts.length + 1));

  for (let i = 0; i < posts.length; i++) {
    // ğŸ‘‰ On insÃ¨re les suggestions Ã  un endroit alÃ©atoire
    if (i === insertIndex) {
      const suggestionsContainer = document.createElement('div');
      suggestionsContainer.style.margin = '15px 0';
      suggestionsContainer.style.background = '#fff';
      suggestionsContainer.style.borderRadius = '10px';
      suggestionsContainer.style.padding = '10px';
      suggestionsContainer.innerHTML = `<h3 style="color:#111;">Vous connaissez peut-Ãªtre :</h3>`;
      c.appendChild(suggestionsContainer);

      try {
        // ğŸ”¹ On filtre par pays et score
        const qUsers = query(
          collection(db, "users"),
          where("suggestScore", ">=", 45),
          where("countryIndex", "==", userCountry),
          limit(20)
        );

        const snapUsers = await getDocs(qUsers);

        if (snapUsers.empty) {
          const p = document.createElement('p');
          p.textContent = "Aucune suggestion pour le moment.";
          p.style.color = "#777";
          p.style.fontSize = "14px";
          suggestionsContainer.appendChild(p);
        } else {
          // ğŸ”¸ Conversion en tableau et mÃ©lange alÃ©atoire
          let suggestedUsers = snapUsers.docs.map(d => ({
            id: d.id,
            data: d.data()
          }));

          // Exclure currentUser + suivis
          suggestedUsers = suggestedUsers.filter(u => 
            u.id !== currentUser.uid && !followingIds.has(u.id)
          );

          // ğŸ”€ MÃ©lange alÃ©atoire (Fisher-Yates)
          for (let i = suggestedUsers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [suggestedUsers[i], suggestedUsers[j]] = [suggestedUsers[j], suggestedUsers[i]];
          }

          const grid = document.createElement('div');
          grid.style.display = 'flex';
          grid.style.overflowX = 'auto';
          grid.style.gap = '10px';
          grid.style.padding = '4px 0';
          suggestionsContainer.appendChild(grid);

          // ğŸ”¹ Afficher les suggestions mÃ©langÃ©es
          suggestedUsers.forEach(({ id, data: u }) => {
            const cardDiv = document.createElement('div');
            cardDiv.style.minWidth = '150px';
            cardDiv.style.flex = '0 0 auto';
            cardDiv.style.background = '#f9f9f9';
            cardDiv.style.border = '1px solid #ddd';
            cardDiv.style.borderRadius = '8px';
            cardDiv.style.padding = '8px';
            cardDiv.style.textAlign = 'center';
            cardDiv.style.cursor = 'pointer';
            cardDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

            const img = document.createElement('img');
            img.src = u.photoURL || 'https://via.placeholder.com/150';
            img.style.width = '100%';
            img.style.height = '120px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '6px';
            img.onclick = () => openUserFeed(id);

            const name = document.createElement('p');
            name.textContent = u.name || u.userName || 'Utilisateur';
            name.style.fontWeight = 'bold';
            name.style.margin = '6px 0 2px';
            name.style.color = '#111';

            const btn = renderFollowBtn(id);
            if (btn) {
              btn.style.marginTop = '4px';
              btn.style.width = '90%';
            }

            cardDiv.appendChild(img);
            cardDiv.appendChild(name);
            if (btn) cardDiv.appendChild(btn);
            grid.appendChild(cardDiv);
          });

          const seeAll = document.createElement('p');
          seeAll.textContent = "Voir tout â†’";
          seeAll.style.textAlign = 'right';
          seeAll.style.color = '#1877f2';
          seeAll.style.cursor = 'pointer';
          seeAll.style.marginTop = '6px';
          seeAll.onclick = () => openTab({ currentTarget: null }, 'home');
          suggestionsContainer.appendChild(seeAll);
        }
      } catch (err) {
        console.error("Erreur chargement suggestions :", err);
      }
    }

    // ğŸ”¸ Puis on affiche le post normal
    const el = card(posts[i].id, posts[i].data, false);
    c.appendChild(el);
    observer.observe(el);
  }

  console.log(`âœ… Feed affichÃ© : ${posts.length} posts (mÃ©langÃ©s + suggestions alÃ©atoires par ordre et position)`);  
}

// ===========================================================
// ===========================================================
// ğŸ”¹ VÃ©rifie et remet suggestScore Ã  0 Ã  minuit local
// ===========================================================
async function checkSuggestReset() {
  if (!currentUser) return;

  try {
    const today = new Date().toISOString().split('T')[0];
    const lastReset = localStorage.getItem('lastSuggestReset');

    // ğŸ•› Si câ€™est un nouveau jour â†’ on reset
    if (lastReset !== today) {
      const userRef = doc(db, "users", currentUser.uid);
      await setDoc(userRef, { suggestScore: 0 }, { merge: true });

      localStorage.setItem('lastSuggestReset', today);
      console.log("âœ… suggestScore remis Ã  zÃ©ro pour la journÃ©e :", today);
      alert("ğŸ¯ Votre score de suggestion a Ã©tÃ© remis Ã  zÃ©ro pour aujourd'hui !");
    }
  } catch (err) {
    console.error("âŒ Erreur pendant le reset du suggestScore :", err);
  }
}

// ===========================================================
// ğŸ”¸ Lance le reset aprÃ¨s authentification
// ===========================================================
onAuthStateChanged(auth, async (user) => {
  currentUser = user;

  if (user) {
    await checkSuggestReset();   // ğŸŸ¢ vÃ©rifie une fois au login
    scheduleMidnightReset();     // ğŸ•› planifie le prochain reset
  }
});

function scheduleMidnightReset() {
  const now = new Date();
  const nextMidnight = new Date();
  nextMidnight.setHours(24, 0, 0, 0);

  const timeUntilMidnight = nextMidnight - now;

  setTimeout(async () => {
    await checkSuggestReset();
    scheduleMidnightReset(); // relance pour le lendemain
  }, timeUntilMidnight);
    }
  
function loadFollowedPosts(c){
  if(!followingIds.size)return;
  const groups=[...followingIds].reduce((a,u,i)=>{if(i%10===0)a.push([]);a[a.length-1].push(u);return a;},[]);
  groups.forEach(g=>{
    const q=query(collection(db,'posts'),where('userId','in',g),orderBy('createdAt','desc'),limit(30));
    onSnapshot(q,snap=>snap.forEach(d=>{if(!c.querySelector(`[data-post="${d.id}"]`))c.appendChild(card(d.id,d.data(),false));}));
  });
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 10. MES POSTS  (+ compteur followers)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function renderMyFeed() {
  if (!currentUser) return;

  const c = qs('myFeed');
  c.textContent = 'Chargementâ€¦';

  const fol = document.createElement('p');
fol.dataset.followersOf = currentUser.uid;
fol.style.backgroundColor = '#050505';
fol.style.color = '#fff';
// texte blanc pour que Ã§a reste lisible
c.appendChild(fol);
  // ğŸ”¹ Lecture en temps rÃ©el du compteur de followers
  onSnapshot(doc(db, 'follows', currentUser.uid), snap => {
    const nbFollowers = snap.exists() ? snap.data()?.filo || 0 : 0;
    fol.textContent = `${fmt(nbFollowers)} followers`;
  });

  // ğŸ”¹ Publications
  onSnapshot(
    query(
      collection(db, 'posts'),
      where('userId', '==', currentUser.uid),
      orderBy('createdAt', 'desc')
    ),
    snap => {
      c.innerHTML = '';
      c.appendChild(fol);

      if (snap.empty) {
        const p = document.createElement('p');
        p.textContent = 'Aucune publication.';
        c.appendChild(p);
      } else {
        snap.forEach(d => c.appendChild(card(d.id, d.data(), true)));
      }
    }
  );
}
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 11. VIDEO FEED & BOOST FEED
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function renderVideoFeed() {
  const c = qs('videoFeedContent');
  c.textContent = 'Chargementâ€¦';

  if (!currentUser) return;

  const userSnap = await getDoc(doc(db, "users", currentUser.uid));
  const userCountry = userSnap.exists() ? userSnap.data().countryIndex || 1 : 1;

  onSnapshot(
    query(
      collection(db, 'posts'),
      where('imageUrl', '!=', null),
      where('boosted', '>', 0),
      where('boostIndex', '==', userCountry)
    ),
    snap => {
      c.innerHTML = '';
      const docs = Array.from(snap.docs);

      // Shuffle
      for (let i = docs.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [docs[i], docs[j]] = [docs[j], docs[i]];
      }

      for (const d of docs) {
        const el = card(d.id, d.data(), false);
        c.appendChild(el);
        observer.observe(el);
      }
    }
  );
}
function renderBoostFeed() {
  if (!currentUser) return;

  const c = qs('videoFeedContentBoost');
  c.textContent = 'Chargementâ€¦';

  onSnapshot(
    query(
      collection(db, 'posts'),
      where('userId', '==', currentUser.uid),
      where('imageUrl', '!=', null),
      where('boosted', '>', 0), // ğŸ‘ˆ seulement mes posts boostÃ©s
      orderBy('createdAt', 'desc')
    ),
    snap => {
      c.innerHTML = '';
      snap.forEach(d => c.appendChild(card(d.id, d.data(), true)));
    }
  );
}
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 12. CARD (like / comments / boost)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
// ---------- USERS CACHE ----------
let usersCache = null;

async function ensureUsersCache() {
  if (usersCache) return usersCache;

  try {
    const usersRef = collection(db, "users");
    const snapshot = await getDocs(usersRef);
    usersCache = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        name: data.name || "",
        photoURL: data.photoURL || "",
        verified: data.verified || false
      };
    });
    return usersCache;
  } catch (err) {
    console.error("Erreur lors du chargement des utilisateurs :", err);
    return [];
  }
}

// ---------------- TEXTAREAS & MENTIONS ----------------
const textareas = [document.getElementById("postText"), document.getElementById("imageTitle")].filter(Boolean);

textareas.forEach(textarea => {
  textarea.addEventListener("input", async (e) => {
    const value = e.target.value;
    const cursorPos = e.target.selectionStart;
    const textUntilCursor = value.slice(0, cursorPos);
    const match = textUntilCursor.match(/@([\wÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿ ]*)$/);

    if (match) await showMentionSuggestions(match[1], textarea);
    else hideMentionSuggestions();

    await renderPreview(value, textarea.id);
  });
});
async function showMentionSuggestions(queryText, textarea) {
  const container = document.getElementById("mentionSuggestions");
  container.innerHTML = "";
  container.style.display = "block";

  if (!queryText || !queryText.trim()) {
    container.style.display = "none";
    return;
  }

  const users = await ensureUsersCache();
  if (!users || users.length === 0) {
    container.innerHTML = "<div style='padding:4px;color:#888'>Aucun rÃ©sultat</div>";
    return;
  }

  const q = queryText.trim().toLowerCase();
  const filtered = users.filter(u => u.name && u.name.toLowerCase().startsWith(q));

  if (filtered.length === 0) {
    container.innerHTML = "<div style='padding:4px;color:#888'>Aucun rÃ©sultat</div>";
    return;
  }

  // Fonction format followers
  const fmtFollowers = (n) => {
    if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + "M";
    if (n >= 1_000) return (n / 1_000).toFixed(0) + "K";
    return n;
  };

  for (const u of filtered) {
    let verified = false;
    let followersCount = 0;

    try {
      // VÃ©rifie certification
      const verifiedSnap = await getDoc(doc(db, "verified", u.id));
      if (verifiedSnap.exists() && verifiedSnap.data().status === true) {
        verified = true;
      }

      // RÃ©cupÃ¨re nombre de followers depuis follows/{uid}.filo
      const followsSnap = await getDoc(doc(db, "follows", u.id));
      if (followsSnap.exists()) {
        followersCount = followsSnap.data().filo || 0;
      }
    } catch (err) {
      console.error("Erreur rÃ©cupÃ©ration infos mention:", err);
    }

    const div = document.createElement("div");
    div.className = "suggestion-item";
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.padding = "8px";
    div.style.cursor = "pointer";

    div.innerHTML = `
      <img src="${u.photoURL || 'https://via.placeholder.com/40'}" 
           style="width:40px;height:40px;border-radius:50%;margin-right:10px">
      <div style="flex:1">
        <div style="font-weight:bold;color:#111">
          ${u.name}
          ${verified ? '<i class="fas fa-check-circle" style="color:#1877f2;margin-left:6px"></i>' : ''}
        </div>
        <div style="font-size:13px;color:#555">
          Page Â· ${fmtFollowers(followersCount)} followers
        </div>
      </div>
    `;

    div.onclick = () => selectMention(u, textarea);
    container.appendChild(div);
  }
}
function hideMentionSuggestions() {
  const container = document.getElementById("mentionSuggestions");
  if (container) container.style.display = "none";
}

// ---------- INSERT SELECTED MENTION (avec espace+!) ----------
function selectMention(user, textarea) {
  const cursorPos = textarea.selectionStart;
  const value = textarea.value;

  // Remplace le @... par @NomComplet + ","
  const before = value.slice(0, cursorPos).replace(/@[\wÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿ ]*$/, `@${user.name},`);
  const after = value.slice(cursorPos);
  textarea.value = before + after;

  hideMentionSuggestions();
  renderPreview(textarea.value, textarea.id);
}

// ---------- RENDER PREVIEW ----------
async function renderPreview(text, sourceId) {
  const previewId = sourceId === "postText" ? "previewText" : "previewImage";
  const preview = document.getElementById(previewId) || document.getElementById("preview");
  if (!preview) return;

  preview.innerHTML = "";
  const frag = await parseMentions(text);
  preview.appendChild(frag);
}

// ---------- PARSE MENTIONS ----------
async function parseMentions(text) {
  const users = await ensureUsersCache();
  const frag = document.createDocumentFragment();
  let i = 0;

  while (i < text.length) {
    const atIdx = text.indexOf("@", i);
    if (atIdx === -1) {
      frag.appendChild(document.createTextNode(text.slice(i)));
      break;
    }

    if (atIdx > i) frag.appendChild(document.createTextNode(text.slice(i, atIdx)));

    const rest = text.slice(atIdx + 1);
    const candidates = users
      .filter(u => u.name && rest.toLowerCase().startsWith(u.name.toLowerCase()))
      .sort((a, b) => b.name.length - a.name.length);

    if (candidates.length > 0) {
      const user = candidates[0];
      const a = document.createElement("a");
      a.href = "#";
      a.className = "mention";
      a.textContent = "@" + user.name;
      a.dataset.username = user.name;
      a.style.color = "gold";
      a.style.textDecoration = "none";
      a.addEventListener("click", e => {
        e.preventDefault();
        openUserFeedByName(user.name);
      });
      frag.appendChild(a);
      i = atIdx + 1 + user.name.length;
    } else {
      const nextSpace = rest.search(/\s|[.,!?;:()'"Â«Â»]/);
      const endIdx = nextSpace === -1 ? rest.length : nextSpace;
      frag.appendChild(document.createTextNode(text.slice(atIdx, atIdx + 1 + endIdx)));
      i = atIdx + 1 + endIdx;
    }
  }

  return frag;
}

// ---------- OPEN USER PROFILE ----------
async function openUserFeedByName(name) {
  const users = await ensureUsersCache();
  const found = users.find(u => u.name && u.name.toLowerCase() === name.toLowerCase());
  if (found) { openUserFeed(found.id); return; }

  try {
    const usersRef = collection(db, "users");
    const snapshot = await getDocs(usersRef);
    const doc = snapshot.docs.find(d => (d.data().name || "").toLowerCase() === name.toLowerCase());
    if (doc) openUserFeed(doc.id);
    else alert("Utilisateur introuvable");
  } catch (err) {
    console.error(err);
    alert("Erreur lors de la recherche d'utilisateur");
  }
}

function card(id, d, isMine) {

  // ====== Helpers ======
  function renderSafeLinkedText(text, container) {
    const urlRe = /https?:\/\/[^\s'"]+/g;
    const mentionRe = /@([A-Za-z0-9_Ã€-Ã–Ã˜-Ã¶Ã¸-Ã¿][A-Za-z0-9_ Ã€-Ã–Ã˜-Ã¶Ã¸-Ã¿\-\.]*)/g;
    let idx = 0;
    while (idx < text.length) {
      urlRe.lastIndex = idx;
      mentionRe.lastIndex = idx;
      const u = urlRe.exec(text);
      const m = mentionRe.exec(text);
      let next;
      if (u && m) next = u.index <= m.index ? { type: 'url', match: u } : { type: 'mention', match: m };
      else if (u) next = { type: 'url', match: u };
      else if (m) next = { type: 'mention', match: m };
      else next = null;

      if (!next) {
        container.appendChild(document.createTextNode(text.slice(idx)));
        break;
      }

      if (next.match.index > idx)
        container.appendChild(document.createTextNode(text.slice(idx, next.match.index)));

      if (next.type === 'url') {
        const url = next.match[0];
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = url;
        container.appendChild(a);
        idx = next.match.index + url.length;
      } else {
        const name = next.match[1].trim();
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'mention';
        a.dataset.username = name;
        a.textContent = '@' + name;
        a.addEventListener('click', (e) => {
          e.preventDefault();
          if (typeof openUserFeedByName === 'function') openUserFeedByName(name);
        });
        container.appendChild(a);
        idx = next.match.index + next.match[0].length;
      }
    }
  }

  function createTextBlockWithToggle(text, maxLen = 200) {
    const wrapper = document.createElement('div');
    const textDiv = document.createElement('div');
    textDiv.className = 'text-bg';
    textDiv.style.whiteSpace = 'pre-wrap';
    textDiv.style.wordBreak = 'break-word';
    textDiv.style.padding = '8px';
    textDiv.style.borderRadius = '6px';

    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'toggle-btn';
    toggleBtn.style.display = 'none';
    toggleBtn.style.marginTop = '6px';
    toggleBtn.style.background = 'none';
    toggleBtn.style.border = 'none';
    toggleBtn.style.color = '#0af';
    toggleBtn.style.cursor = 'pointer';

    wrapper.appendChild(textDiv);
    wrapper.appendChild(toggleBtn);

    const fullText = text || '';
    const shortText = fullText.length > maxLen ? fullText.slice(0, maxLen) + '...' : fullText;
    let isShort = true;

    function render() {
      textDiv.innerHTML = '';
      renderSafeLinkedText(isShort ? shortText : fullText, textDiv);
      toggleBtn.textContent = isShort ? 'Voir plus' : 'Voir moins';
      toggleBtn.style.display = fullText.length > maxLen ? 'block' : 'none';
    }

    toggleBtn.onclick = () => {
      isShort = !isShort;
      render();
    };

    render();
    return wrapper;
  }

  const w = document.createElement('div');
  w.className = 'post';
  w.dataset.post = id;

  // ---------- HEADER ----------
  const head = document.createElement('div');
  head.className = 'post-header';

  const img = document.createElement('img');
  img.onclick = () => openUserFeed(d.userId);

  const name = document.createElement('a');
  name.className = 'username';
  name.href = `https://mboaskill.cm/${d.userId}`;
  name.onclick = (e) => { e.preventDefault(); openUserFeed(d.userId); };

  // ====== ğŸ”¥ Correction : charger NOM + PHOTO ACTUELS en une seule requÃªte ======
  getDoc(doc(db, 'users', d.userId)).then((snapUser) => {
    const data = snapUser.exists() ? snapUser.data() : {};
    const currentName = data.name || d.userName || d.userEmail;
    const currentPhoto = data.photoURL || 'https://via.placeholder.com/40';

    img.src = currentPhoto;
    img.alt = currentName;

    getDoc(doc(db, 'verified', d.userId)).then((snapV) => {
      if (snapV.exists() && snapV.data().status === true) {
        name.innerHTML = `
          ${currentName}
          <span class="verified-badge">
            <i class="fas fa-certificate"></i>
            <i class="fas fa-check checkmark"></i>
          </span>`;
      } else {
        name.textContent = currentName;
      }
    });
  });

  const time = document.createElement('small');
  time.style.marginLeft = '8px';
  time.style.color = '#888';
  if (d.createdAt?.toDate) {
    time.textContent = `â€¢ il y a ${timeSince(d.createdAt.toDate())}`;
  }

  head.append(img, name, time);

  const fbtn = renderFollowBtn(d.userId);
  if (fbtn) head.appendChild(fbtn);

  if ((d.boosted || 0) > 0) {
    const tag = document.createElement('span');
    tag.innerHTML = '<i class="fa-solid fa-trophy" style="color:gold"></i>';
    tag.style.cssText = 'margin-left:auto;color:#ffa500;font-size:12px;font-weight:bold';
    head.appendChild(tag);
  }

  w.appendChild(head);

  // ---------- CONTENU ----------
  const cont = document.createElement('div');
  cont.className = 'post-content';

  if (d.imageUrl) {
    if (d.imageTitle) {
      const titleWrapper = createTextBlockWithToggle(d.imageTitle, 200);
      titleWrapper.querySelector('.text-bg').style.fontWeight = 'bold';
      titleWrapper.querySelector('.text-bg').style.color = '#000000';
      cont.appendChild(titleWrapper);
    }

    const imgEl = document.createElement('img');
    imgEl.src = d.imageUrl;
    imgEl.style.cssText = 'max-width:100%;border-radius:2px;';
    cont.appendChild(imgEl);

  } else if (d.text) {
    const textWrapper = createTextBlockWithToggle(d.text, 200);
    textWrapper.querySelector('.text-bg').style.background = d.bgColor || '#000';
    textWrapper.querySelector('.text-bg').style.color = d.textColor || '#fff';
    cont.appendChild(textWrapper);
  }

  w.appendChild(cont);

  // ---------- ACTIONS ----------
  const act = document.createElement('div');
  act.className = 'post-actions';

  const left = document.createElement('div');
  left.className = 'left';

  const like = document.createElement('i');
  like.className = 'fa-regular fa-heart like';

  const lCnt = document.createElement('span');
  lCnt.textContent = fmt(d.likes || 0);

  if (currentUser) {
    const likeRef = doc(db, 'posts', id, 'likes', currentUser.uid);
    getDoc(likeRef).then(snap => {
      if (snap.exists()) like.classList.add('fa-solid', 'liked');
    });
  }

  like.onclick = () => toggleLike(id, like, lCnt);
  left.append(like, lCnt);

  const center = document.createElement('div');
  center.className = 'center';
  const vCnt = document.createElement('span');
  vCnt.innerHTML = `<i class="fas fa-eye"></i> ${fmt(d.views || 1)}`;
  center.appendChild(vCnt);

  const right = document.createElement('div');
  right.className = 'right';
  const comI = document.createElement('i');
  comI.className = 'fa-regular fa-comment';
  const comCnt = document.createElement('span');
  comCnt.textContent = '0';
  right.append(comI, comCnt);

  if (isMine) {
    const edit = document.createElement('i');
    edit.className = 'fa-solid fa-pen-to-square';
    edit.title = 'Modifier';
    edit.onclick = () => editPost(id, d);
    left.appendChild(edit);

    const boostBtn = document.createElement('button');
    boostBtn.className = 'boost-btn';
    boostBtn.textContent = 'Booster';
    boostBtn.onclick = () => selectBoostPost(id, d.text || 'Sans titre');
    right.appendChild(boostBtn);
  }

  act.append(left, center, right);
  w.appendChild(act);

  // ---------- COMMENTAIRES ----------
  const comSec = document.createElement('div');
  comSec.className = 'comments-section';
  comSec.style.display = 'none';

  const comList = document.createElement('div');
  comSec.appendChild(comList);

  if (currentUser) {
    const inputBox = document.createElement('div');
    inputBox.className = 'comment-input';

    const inp = document.createElement('input');
    inp.placeholder = 'Ajouter un commentaire...';

    const btn = document.createElement('button');
    btn.textContent = 'Envoyer';
    btn.onclick = async () => {
      const t = inp.value.trim();
      if (!t) return;
      await addComment(id, t);
      inp.value = '';
      await loadComments(id, comList, comCnt);
    };

    inputBox.append(inp, btn);
    comSec.appendChild(inputBox);
  }

  w.appendChild(comSec);

  comI.onclick = async () => {
    const show = comSec.style.display === 'none';
    comSec.style.display = show ? 'block' : 'none';
    if (show) await loadComments(id, comList, comCnt);
  };

  loadComments(id, comList, comCnt).catch(console.error);

  const hr = document.createElement('hr');
  hr.style.border = 'none';
  hr.style.borderTop = '1px solid #ddd';
  hr.style.margin = '16px 0';
  w.appendChild(hr);

  return w;
}

async function editPost(postId, data) {
  // RÃ©cup valeur actuelle
  const currentText = data.text || '';
  const newText = prompt('Modifiez le texte de la publication :', currentText);
  if (newText === null) return; // AnnulÃ©

  // Si rien changÃ©, on ne fait rien
  if (newText.trim() === currentText.trim()) return;

  try {
    await updateDoc(doc(db, 'posts', postId), { text: newText.trim() });
    alert('Publication mise Ã  jour.');
  } catch (e) {
    console.error('Erreur mise Ã  jour post', e);
    alert('Erreur lors de la mise Ã  jour.');
  }
}

/* LIKE */
async function loadLikedPosts(){likedPosts.clear();}
async function toggleLike(pid, icon, cnt) {
  if (!currentUser) return alert('Connectez-vous');

  const ref = doc(db, 'posts', pid);
  const likeRef = doc(db, 'posts', pid, 'likes', currentUser.uid);

  const snap = await getDoc(likeRef);

  if (snap.exists()) {
    // DÃ©jÃ  likÃ© â†’ on retire
    await deleteDoc(likeRef);
    icon.classList.remove('liked');
    await updateDoc(ref, { likes: increment(-1) });
  } else {
    // Pas encore likÃ© â†’ on ajoute
    await setDoc(likeRef, {
      userId: currentUser.uid,
      userName: currentUser.displayName || currentUser.email || '',
      likedAt: serverTimestamp()
    });
    icon.classList.add('liked');
    await updateDoc(ref, { likes: increment(1) });
  }

  // Actualiser le compteur
  const postSnap = await getDoc(ref);
  cnt.textContent = fmt(postSnap.data().likes || 0);
}
/* COMMENTS */
async function loadComments(pid, container, cnt) {
  // ğŸ”¹ RÃ©cupÃ©rer tous les commentaires (les plus rÃ©cents d'abord)
  const s = await getDocs(
    query(collection(db, 'posts', pid, 'comments'), orderBy('createdAt', 'desc'))
  );

  container.innerHTML = '';
  cnt.textContent = s.size;

  if (s.empty) return;

  // 1ï¸âƒ£ PrÃ©parer toutes les requÃªtes utilisateurs et badges en parallÃ¨le
  const userPromises = s.docs.map(docSnap => {
    const c = docSnap.data();
    const userRef = doc(db, 'users', c.userId);
    const verifiedRef = doc(db, 'verified', c.userId);
    return Promise.all([getDoc(userRef), getDoc(verifiedRef)]);
  });

  // Attendre que toutes les requÃªtes se terminent
  const usersData = await Promise.all(userPromises);

  // 2ï¸âƒ£ Boucle pour crÃ©er les commentaires (dans le mÃªme ordre que Firestore, donc du plus rÃ©cent au plus ancien)
  s.docs.forEach((docSnap, i) => {
    const c = docSnap.data();
    const [userSnap, verifiedSnap] = usersData[i];
    const userData = userSnap.exists() ? userSnap.data() : {};
    const isVerified = verifiedSnap.exists() && verifiedSnap.data().status === true;

    // Conteneur principal
    const div = document.createElement('div');
    div.className = 'comment';
    div.style.display = 'flex';
    div.style.alignItems = 'flex-start';
    div.style.marginBottom = '12px';

    // Avatar
    const avatar = document.createElement('img');
    avatar.src = userData.photoURL || 'https://via.placeholder.com/40';
    avatar.alt = 'Avatar';
    avatar.style.width = '40px';
    avatar.style.height = '40px';
    avatar.style.borderRadius = '50%';
    avatar.style.marginRight = '10px';

    // Conteneur texte
    const textContainer = document.createElement('div');
    textContainer.style.display = 'flex';
    textContainer.style.flexDirection = 'column';

    // Nom utilisateur
    const name = document.createElement('a');
    name.className = 'username';
    name.href = `https://mboaskill.cm/${c.userId}`;
    name.style.cursor = 'pointer';
    name.style.fontWeight = 'bold';
    name.style.color = 'gold';
    name.style.textDecoration = 'none';
    name.onclick = (e) => {
      e.preventDefault();
      openUserFeed(c.userId);
    };

    if (isVerified) {
      name.innerHTML = `${userData.displayName || c.userName || c.userEmail || 'Utilisateur'}
        <span class="verified-badge" style="margin-left: 6px; color: #1da1f2;">
          <i class="fas fa-certificate"></i>
          <i class="fas fa-check checkmark"></i>
        </span>`;
    } else {
      name.textContent = userData.displayName || c.userName || c.userEmail || 'Utilisateur';
    }

    // Texte du commentaire (avec liens et mentions)
    const span = document.createElement('span');
    span.innerHTML = linkifyText(c.text || '');
    span.style.marginTop = '2px';
    span.style.color = '#333';

    textContainer.appendChild(name);
    textContainer.appendChild(span);

    div.appendChild(avatar);
    div.appendChild(textContainer);
    container.appendChild(div);
  });
}
async function addComment(pid,text){
  if(!currentUser)return;
  await addDoc(collection(db,'posts',pid,'comments'),{userId:currentUser.uid,userName:currentUser.displayName||currentUser.email,text,createdAt:serverTimestamp()});
}

/* BOOST */
function selectBoostPost(pid,title){
  boostId=pid;qs('boostStatus').textContent=`1 sÃ©lection : ${title}`;qs('boostPanel').style.display='block';
  openTab({currentTarget:document.querySelector('.tablinks[onclick*="vibo"]')},'vibo');
}
async function prepareWallet() {
  if (!currentUser) return;

  const walletRef = doc(db, "wallets", currentUser.uid);
  const walletSnap = await getDoc(walletRef);

  if (!walletSnap.exists()) {
    // CrÃ©er un wallet vide avec 0 FCFA
    await setDoc(walletRef, { balance: 0 });
    console.log("Wallet initialisÃ© Ã  0 FCFA");
  }
}
async function debit(cost){
  if(!currentUser)return false;
  const ref=doc(db,'wallets',currentUser.uid);
  const ok=await runTransaction(db,async t=>{const s=await t.get(ref);const bal=s.exists()?s.data().balance:0;if(bal<cost)return false;t.update(ref,{balance:bal-cost});return true;});
  if(!ok)alert('Solde insuffisant(min 500F)');await loadWallet();return ok;
}
window.boostPost = async () => {
  if (!boostId) return alert('Choisissez une publication');
  const v = parseInt(qs('boostViews').value);
  if (isNaN(v) || v < 2) return alert('Min 2 jours (3500 XAF)');

  const cost = Math.ceil(v / 1) * 1750;
  if (!(await debit(cost))) return;

  const countryIndex = parseInt(qs('boostCountry').value);
  if (isNaN(countryIndex)) return alert("Choisissez un pays pour booster");

  try {
    await updateDoc(doc(db, 'posts', boostId), {
      boosted: increment(v),
      boostAt: serverTimestamp(),
      boostIndex: countryIndex
    });
    qs('boostStatus').textContent = `Boost succÃ¨s âœ”ï¸`;
    qs('boostViews').value = '';
    qs('boostCountry').value = '';
    boostId = '';
    renderFeed();
    renderMyFeed();
    await loadTotalViewsAndBalance();
  } catch (e) {
    alert('Erreur boost : ' + e.message);
    await deposit(cost);
  }
};
  // rendre la fonction accessible globalement pour l'inline handler
  window.saveUserCountry = async function(index) {
    if (!currentUser) return alert("Connectez-vous d'abord");
    let countryIndex = parseInt(index, 10);
    if (isNaN(countryIndex)) countryIndex = 1; // fallback
    await updateDoc(doc(db, "users", currentUser.uid), { countryIndex });
    alert("Pays enregistrÃ© âœ”ï¸");
  };

  // loadUserCountry reste normale
  async function loadUserCountry() {
    if (!currentUser) return;
    const userSnap = await getDoc(doc(db, "users", currentUser.uid));
    const countryIndex = userSnap.exists() ? userSnap.data().countryIndex || 1 : 1;
    const select = document.getElementById("userCountry");
    if (select) select.value = countryIndex;
  }
  // Attacher l'Ã©vÃ¨nement "change" via JS au lieu d'onchange inline
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('userCountry');
    if (!select) return;

    select.addEventListener('change', async (e) => {
      if (!currentUser) return alert("Connectez-vous d'abord");

      let countryIndex = parseInt(e.target.value, 10);
      if (isNaN(countryIndex)) countryIndex = 1; // Cameroun par dÃ©faut

      await updateDoc(doc(db, "users", currentUser.uid), { countryIndex });
      alert("Pays enregistrÃ© âœ”ï¸");
    });
  });

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 13. USER FEED & SEARCH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
// Feed d'un utilisateur
// ======================================================
// ğŸ”¹ PROFIL UTILISATEUR (AFFICHAGE + BIO + FOLLOW + SOUTIEN)

window.openUserFeed = async (uid) => {
  if (!uid) return alert("Utilisateur introuvable.");

  // Ouvre l'onglet userFeed
  openTab(
    { currentTarget: document.querySelector('.tablinks[onclick*="home"]') },
    'userFeed'
  );

  const cont = qs('userFeedContent');
  const title = qs('userFeedTitle');
  cont.textContent = 'Chargementâ€¦';

  // Valeurs par dÃ©faut
  let name = 'Utilisateur';
  let photo = 'https://via.placeholder.com/100';
  let verified = false;

  // ğŸ”¹ RÃ©cupÃ¨re les infos utilisateur (VERSION CORRIGÃ‰E)
  try {
    const userRef = doc(db, 'users', uid);
    const snapUser = await getDoc(userRef);

    if (snapUser.exists()) {
      const data = snapUser.data();
      name = data.name || name;
      photo = data.photo || data.photoURL || photo; // ğŸ”¥ PHOTO ACTUELLE
    }
  } catch (e) {
    console.warn("Erreur chargement utilisateur:", e);
  }

  // ğŸ”¹ VÃ©rifie la certification
  try {
    const verifiedRef = doc(db, 'verified', uid);
    const verifiedSnap = await getDoc(verifiedRef);
    verified = verifiedSnap.exists() && verifiedSnap.data().status === true;
  } catch (e) {
    console.warn("Erreur vÃ©rification certif:", e);
  }

  // === HEADER ===
  title.innerHTML = '';
  title.style.cssText = "display:flex;flex-direction:column;gap:10px;align-items:flex-start;";

  // Bloc haut : photo + infos
  const topRow = document.createElement('div');
  topRow.style.cssText = 'display:flex;align-items:flex-start;gap:10px;';

  // Photo
  const img = document.createElement('img');
  img.src = photo; // ğŸ”¥ PHOTO ACTUELLE
  img.alt = name;
  img.style.cssText = 'width:100px;height:100px;border-radius:50%;object-fit:cover;';

  // Bloc infos
  const infoBlock = document.createElement('div');
  infoBlock.style.cssText = 'display:flex;flex-direction:column;gap:5px;align-items:flex-start;';

  const str = document.createElement('strong');

  // ğŸ”¥ NOM ACTUEL + BADGE CORRIGÃ‰
  str.innerHTML = `
    ${name}
    ${verified ? '<i class="fas fa-check-circle" style="color:#1877f2;margin-left:6px"></i>' : ''}
  `;
  str.style.fontSize = '18px';

  const fol = document.createElement('span');
  fol.dataset.followersOf = uid;
  fol.style.cssText = 'color:#555;font-size:14px;';
  fol.textContent = 'Chargement followers...';

  infoBlock.append(str, fol);

  // === Actions ===
  if (currentUser && uid === currentUser.uid) {
    const bioBtn = document.createElement('button');
    bioBtn.innerHTML = 'Modifier ma bio <i class="fas fa-pen"></i>';
    bioBtn.style.cssText = 'margin-top:6px;background:#1877f2;color:white;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;';
    bioBtn.onclick = () => {
      document.querySelectorAll('.tabcontent').forEach(sec => sec.style.display = 'none');
      document.getElementById('mabio').style.display = 'block';
      loadMyBio();
    };
    infoBlock.appendChild(bioBtn);
  } else if (currentUser) {
    const btn = renderFollowBtn(uid);
    if (btn) infoBlock.appendChild(btn);
  }

  topRow.append(img, infoBlock);
  title.append(topRow);

  // === Followers en temps rÃ©el ===
  onSnapshot(doc(db, 'follows', uid), snap => {
    const nbFollowers = snap.exists() ? snap.data()?.filo || 0 : 0;
    fol.textContent = `${fmt(nbFollowers)} followers`;
  });

  // === Compteur total followers + bouton soutien ===
  const followsRef = doc(db, 'follows', uid);
  const followsSnap = await getDoc(followsRef);
  const followerCount = followsSnap.exists() ? (followsSnap.data().filo || 0) : 0;

  const gagneEl = document.getElementById('gagne');
  if (gagneEl) {
    gagneEl.innerHTML = followerCount >= 100
      ? '<i class="fas fa-check-circle" style="color:green;"></i>'
      : '<i class="fa-solid fa-xmark" style="color:red;"></i>';
  }

  if (currentUser && followerCount > 100 && uid !== currentUser.uid) {
    const supportBtn = document.createElement('button');
    supportBtn.innerHTML = '<i class="fa-solid fa-star"></i> Soutenir (600 XAF)';
    supportBtn.style.cssText = 'margin-top:6px;background:#ffd700;color:black;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;';
    supportBtn.onclick = async () => {
      try {
        const walletRef = doc(db, 'wallets', currentUser.uid);
        const walletSnap = await getDoc(walletRef);
        const balance = walletSnap.exists() ? (walletSnap.data().balance || 0) : 0;

        if (balance < 600) return alert('ğŸ’¸ Solde insuffisant pour soutenir.');

        await updateDoc(walletRef, { balance: balance - 600 });
        await setDoc(doc(db, 'users', uid), { soutienvues: increment(1) }, { merge: true });
        await setDoc(doc(db, 'soldes', uid), {
          gainVues: increment(450),
          updatedAt: new Date()
        }, { merge: true });

        alert('âœ… Soutien envoyÃ© avec succÃ¨s !');
      } catch (err) {
        console.error('Erreur soutien :', err);
        alert('âŒ Une erreur est survenue.');
      }
    };
    infoBlock.appendChild(supportBtn);
  }

  // === Flux des publications ===
  onSnapshot(
    query(collection(db, 'posts'), where('userId', '==', uid), orderBy('createdAt', 'desc')),
    async snap => {
      cont.innerHTML = '';

      await displayBioUnderProfile(uid);

      if (snap.empty) {
        const p = document.createElement('p');
        p.textContent = 'Aucune publication.';
        cont.appendChild(p);
      } else {
        snap.forEach(d => cont.appendChild(card(d.id, d.data(), false)));
      }
    }
  );
};

// ======================================================
// ğŸ”¹ AFFICHER LA BIO SOUS LE PROFIL
// ======================================================
async function displayBioUnderProfile(uid) {
  const cont = qs('userFeedContent');
  if (!cont) return;

  const oldBio = cont.querySelector('.user-bio');
  if (oldBio) oldBio.remove();

  const bioEl = document.createElement('div');
  bioEl.className = 'user-bio';
  bioEl.style.cssText = "margin-top:15px;padding:10px;border-top:1px solid #ddd;color:#333;font-size:15px;white-space:pre-line;";
  bioEl.textContent = 'Chargement de la bio...';
  cont.appendChild(bioEl);

  try {
    const bioRef = doc(db, 'users', uid);
    const bioSnap = await getDoc(bioRef);
    if (bioSnap.exists() && bioSnap.data().bio) {
      bioEl.textContent = bioSnap.data().bio;
    } else {
      bioEl.textContent = "";
    }

    if (currentUser && uid === currentUser.uid) {
      const editBtn = document.createElement('button');
      editBtn.innerHTML = '<i class="fas fa-pen"></i> Modifier ma bio';
      editBtn.style.cssText = `
        margin-top:8px;
        background:#1877f2;
        color:white;
        padding:4px 8px;
        border:none;
        border-radius:4px;
        cursor:pointer;
      `;
      editBtn.onclick = () => {
        document.querySelectorAll('.tabcontent').forEach(sec => sec.style.display = 'none');
        document.getElementById('mabio').style.display = 'block';
        loadMyBio();
      };
      bioEl.appendChild(editBtn);
    }

  } catch (e) {
    console.error("Erreur bio:", e);
    bioEl.textContent = "Erreur lors du chargement de la bio.";
  }
}
// ğŸ”¸ Sauvegarde la bio modifiÃ©e
async function saveMyBio() {
  if (!currentUser) {
    alert("Connectez-vous pour enregistrer votre bio !");
    return;
  }

  const bioInput = document.getElementById('bioInput');
  const statusEl = document.getElementById('bioStatus');
  if (!bioInput) {
    console.warn("âš ï¸ Champ bioInput introuvable");
    return;
  }

  const bioText = bioInput.value.trim();
  statusEl.textContent = "Enregistrement...";
  try {
    await updateDoc(doc(db, 'users', currentUser.uid), { bio: bioText });
    statusEl.textContent = "âœ… Bio mise Ã  jour avec succÃ¨s !";
  } catch (err) {
    console.error("Erreur lors de la sauvegarde de la bio:", err);
    statusEl.textContent = "âŒ Erreur dâ€™enregistrement.";
  }
}

// ğŸ”¸ Bouton "Enregistrer ma bio"
const saveBioBtn = document.getElementById('saveBioBtn');
if (saveBioBtn) {
  saveBioBtn.addEventListener('click', saveMyBio);
}

window.searchUser = async () => {
  const q = qs('searchUserInput').value.trim().toLowerCase();
  if (!q) return alert('Entrez un nom ou e-mail');

  // ğŸ”¹ On part toujours des posts pour trouver les userIds correspondants
  const s = await getDocs(collection(db, 'posts'));
  const map = new Map();

  s.forEach(d => {
    const v = d.data();
    if (
      (v.userName || '').toLowerCase().includes(q) ||
      (v.userEmail || '').toLowerCase().includes(q)
    ) {
      map.set(v.userId, { uid: v.userId });
    }
  });

  const res = qs('searchResults');
  res.innerHTML = '';

  if (map.size === 0) return (res.textContent = 'Aucun utilisateur trouvÃ©');

  // ğŸ”¹ Pour chaque userId trouvÃ© â†’ rÃ©cupÃ¨re ses infos actuelles dans "users"
  for (const [uid, u] of map) {
    try {
      const userSnap = await getDoc(doc(db, 'users', uid));
      let name = 'Utilisateur';
      let email = '';
      let photo = 'https://via.placeholder.com/40';

      if (userSnap.exists()) {
        const data = userSnap.data();
        name = data.name || name;
        email = data.email || '';
        photo = data.photoURL || photo;
      }

      const d = document.createElement('div');
      d.style.cssText =
        'cursor:pointer;display:flex;align-items:center;gap:8px;margin-bottom:8px';

      const img = document.createElement('img');
      img.src = photo;
      img.style.cssText = 'width:40px;height:40px;border-radius:50%';

      const span = document.createElement('span');
      span.textContent = name || email;
      span.style.cssText = 'color:#1877f2;font-weight:bold';

      const btn = renderFollowBtn(uid);

      d.append(img, span);
      if (btn) d.append(btn);

      d.onclick = () => openUserFeed(uid);
      res.appendChild(d);
    } catch (err) {
      console.error('Erreur rÃ©cupÃ©ration user :', err);
    }
  }
};
  
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 14. VIEWS & RETRAIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
// ğŸ”¹ DOM Ready + Auth
// ===========================================================
document.addEventListener('DOMContentLoaded', () => {
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    const loadingEl = document.getElementById('loadingMessage');
    const balanceWrapperEl = document.getElementById('balanceWrapper');

    if (user) {
      if (loadingEl) loadingEl.style.display = 'none';
      if (balanceWrapperEl) balanceWrapperEl.style.display = 'block';

      loadTotalViewsAndBalance();
      refreshBalanceDisplay();
    } else {
      if (loadingEl) loadingEl.textContent = "Utilisateur non connectÃ©";
      if (balanceWrapperEl) balanceWrapperEl.style.display = 'none';
      currentBalance = 0;
    }
  });
});

// ===========================================================
// ğŸ”¹ Charger vues + gains (sans recalcul du solde rÃ©el)
// ===========================================================
async function loadTotalViewsAndBalance() {
  if (!currentUser) return console.warn("loadTotalViewsAndBalance: currentUser null");

  try {
    // --- Calcul des vues totales ---
    const postsRef = collection(db, 'posts');
    const q = query(postsRef, where('userId', '==', currentUser.uid));
    const snap = await getDocs(q);

    let totalViews = 0;
    snap.forEach(d => {
      const v = d.data();
      const views = Number(v.views) || 0;
      const boosted = Number(v.boosted) || 0;
      const likes = Number(v.likes) || 0;
      const vuesParLike = likes * 1;
      const totalviewcontent = Number(v.totalviewcontent) || 0;
      totalViews += views + boosted + vuesParLike + totalviewcontent;
    });

    // soutienvues depuis users/{uid}
    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
    if (userDoc.exists()) {
      totalViews += Number(userDoc.data().soutienvues || 0);
    }

    // --- Charger solde ---
    const soldeRef = doc(db, "soldes", currentUser.uid);
    const soldeSnap = await getDoc(soldeRef);
    let montant = 0, gainVues = 0;
    if (soldeSnap.exists()) {
      const d = soldeSnap.data();
      montant = Number(d.montant || 0);
      gainVues = Number(d.gainVues || 0);
    }

    // --- Mettre Ã  jour interface ---
    const totalViewsCountEl = document.getElementById('totalViewsCount');
    if (totalViewsCountEl) totalViewsCountEl.textContent = fmt(totalViews);

    currentBalance = montant + gainVues;
    const currentBalanceEl = document.getElementById('currentBalance');
    if (currentBalanceEl) currentBalanceEl.textContent = currentBalance + " FCFA";

  } catch (err) {
    console.error("Erreur loadTotalViewsAndBalance :", err);
  }
}

// ===========================================================
// ğŸ”¹ RafraÃ®chir solde uniquement
// ===========================================================
async function refreshBalanceDisplay() {
  if (!currentUser) return;
  try {
    const soldeRef = doc(db, "soldes", currentUser.uid);
    const soldeSnap = await getDoc(soldeRef);
    let montant = 0, gainVues = 0;
    if (soldeSnap.exists()) {
      const d = soldeSnap.data();
      montant = Number(d.montant || 0);
      gainVues = Number(d.gainVues || 0);
    }
    currentBalance = montant + gainVues;
    const el = document.getElementById('currentBalance');
    if (el) el.textContent = currentBalance + " FCFA";
  } catch (e) {
    console.error("Erreur refreshBalanceDisplay:", e);
  }
}


// ğŸ”¹ Demande de retrait (utilisateur)
// ===========================================================
window.withdrawBalance = async () => {
  try {
    const amountInput = document.getElementById("withdrawAmount");
    const phoneInput  = document.getElementById("withdrawPhone");

    // --- Authentification ---
    if (!currentUser || !currentUser.uid) {
      alert("Utilisateur non authentifiÃ©.");
      return;
    }

    // --- Montant demandÃ© ---
    const a = amountInput ? Number(amountInput.value) : 0;
    if (!Number.isFinite(a) || a < 5000) {
      alert("Montant minimum : 5 000 XAF");
      return;
    }

    // --- TÃ©lÃ©phone ---
    const phone = phoneInput ? phoneInput.value.trim() : "";
    if (!phone || phone.length < 8) {
      alert("Veuillez entrer un numÃ©ro de tÃ©lÃ©phone valide.");
      return;
    }

    // --- RÃ©cupÃ¨re le solde de lâ€™utilisateur ---
    const soldeRef = doc(db, "soldes", currentUser.uid);
    const soldeSnap = await getDoc(soldeRef);

    if (!soldeSnap.exists()) {
      alert("âŒ Solde introuvable. Essayez plus tard.");
      return;
    }

    const data = soldeSnap.data();
    let montant  = Number(data.montant  || 0);
    let gainVues = Number(data.gainVues || 0);
    let total = montant + gainVues;

    if (a > total) {
      alert(`Solde insuffisant. Votre solde actuel est de ${total} FCFA`);
      return;
    }

    // --- Retire le montant du solde (on puise d'abord dans montant, puis gainVues si besoin) ---
    if (a <= montant) {
      montant -= a;
    } else {
      const reste = a - montant;
      montant = 0;
      gainVues = Math.max(0, gainVues - reste);
    }

    // --- Mise Ã  jour du solde ---
    await updateDoc(soldeRef, { montant, gainVues });

    // --- Ajoute lâ€™historique du retrait ---
    await addDoc(collection(db, "withdrawals"), {
      userId: currentUser.uid,
      amount: a,
      phone,
      date: new Date(),
      statut: "effectuÃ©" // optionnel : juste pour historique clair
    });

    alert("âœ… Retrait effectuÃ© avec succÃ¨s !");
    
    // --- RÃ©initialise le formulaire ---
    if (amountInput) amountInput.value = "";
    if (phoneInput) phoneInput.value = "";

    // --- Recharge affichage du solde si fonction dispo ---
    if (typeof loadTotalViewsAndBalance === "function") {
      loadTotalViewsAndBalance();
    }

  } catch (err) {
    console.error("Erreur withdrawBalance:", err);
    alert("âŒ Une erreur est survenue lors du retrait.");
  }
};

window.loadTotalViewsAndBalance = loadTotalViewsAndBalance;
window.observeRenderedPosts = observeRenderedPosts;
window.incrementView = incrementView;
window.refreshBalanceDisplay = refreshBalanceDisplay;

window.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("notchpayBtn");
  if (!btn) return console.error("Bouton notchpayBtn introuvable !");

  btn.addEventListener("click", async () => {
    const montantInput = document.getElementById("montant");
    const amount = parseFloat(montantInput.value);

    if (isNaN(amount) || amount < 150) return alert("Montant min 150 XAF");
    if (!currentUser) return alert("Connectez-vous");

    const walletRef = doc(db, "wallets", currentUser.uid);

    try {
      // ğŸ”¹ CrÃ©e le wallet si il n'existe pas
      const walletSnap = await getDoc(walletRef);
      if (!walletSnap.exists()) {
        await setDoc(walletRef, { balance: 0 });
      }

      // ğŸ”¹ Ensuite, crÃ©e la transaction NotchPay
      const reference = `tx_${Date.now()}`;
      const res = await fetch("https://api.notchpay.co/payments", {
        method: "POST",
        headers: {
          "Authorization": "pk.azYHHFMqVKLHlDNxzCbiqKlOfDh9oULJ6HQ52MPqgytU7dHwoODNkxKvV1xBECeeHxTBZ0Og31aCrJ11nDGI7iNtBcXD42ctowdIDyFbGG6KEeoiXCOjZJy5yg2PW",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          amount: amount,
          currency: "XAF",
          description: "Recharge Wallet",
          reference: reference,
          customer: {
            email: currentUser.email,
            name: currentUser.displayName || "Utilisateur"
          },
          metadata: {
            uid: currentUser.uid // envoi de l'UID pour le webhook
          },
          callback: "https://mboaskill.cm"
        })
      });

      const data = await res.json();
      if (data && data.authorization_url) {
        window.location.href = data.authorization_url; // Redirection vers NotchPay
      } else {
        alert("Erreur : impossible de dÃ©marrer le paiement.");
      }
    } catch (err) {
      console.error("Erreur :", err);
      alert("Erreur lors de l'initialisation du paiement.");
    }
  });
});

  // SIGNUP  LOGIN EMAIL
window.signupWithEmail = async () => {
  const n = qs('signupName').value.trim();
  const e = qs('signupEmail').value.trim();
  const p = qs('signupPassword').value;
  const age = parseInt(qs('signupAge').value, 10);

  if (!n || !e || !p || isNaN(age)) return alert('Champs manquants');
  if (age < 18) return alert('Ã‚ge min 18');
  if (p.length < 6) return alert('Mot de passe â‰¥6');

  try {
    // 1) CrÃ©e le compte auth
    const c = await createUserWithEmailAndPassword(auth, e, p);
    const user = c.user;
    await updateProfile(user, { displayName: n });

    // 2) Enregistre l'utilisateur dans Firestore
    await setDoc(doc(db, "users", user.uid), {
      uid: user.uid,
      name: n,
      email: e,
      age: age,
      createdAt: serverTimestamp()
    });

    // 3) Suivi automatique de l'admin
    // **REMPLACE** cette valeur par l'UID rÃ©el du compte admin prÃ©sent dans ta collection "follows"
    const ADMIN_UID = "810T1WLrysRxELoiYO7hSHywwRA3";

// doc dans la sous-collection "list" de lâ€™admin
const listRef = doc(db, "follows", ADMIN_UID, "list", user.uid);

// doc principal de lâ€™admin (oÃ¹ se trouve le champ "filo")
const counterRef = doc(db, "follows", ADMIN_UID);  
    // Essaye d'abord une transaction (atomique) : increment + crÃ©ation de la doc list
    try {
      await runTransaction(db, async (tx) => {
        const counterSnap = await tx.get(counterRef);

        if (!counterSnap.exists()) {
          // crÃ©e le doc compteur avec filo:1 (merge-like)
          tx.set(counterRef, { filo: 1 }, { merge: true });
        } else {
          // incrÃ©mente atomiquement
          tx.update(counterRef, { filo: increment(1) });
        }

        // crÃ©e la doc dans la sous-collection list (trace du follow)
        tx.set(listRef, { uid: user.uid, name: n, date: serverTimestamp() });
      });
    } catch (tranErr) {
      // si la transaction Ã©choue, fallback : Ã©crire la liste puis updateDoc/incrÃ©menter
      console.warn('Transaction follow admin failed, using fallback:', tranErr);
      await setDoc(listRef, { uid: user.uid, name: n, date: serverTimestamp() });
      try {
        await updateDoc(counterRef, { filo: increment(1) });
      } catch (upErr) {
        // si le doc n'existe pas encore, crÃ©e-le Ã  1 (merge pour ne pas Ã©craser)
        await setDoc(counterRef, { filo: 1 }, { merge: true });
      }
    }

    // 4) Met Ã  jour le cache local des follows si tu utilises loadFollowing()
    try { await loadFollowing(); } catch (e) { /* ignore */ }

    alert("Compte crÃ©Ã© avec succÃ¨s !");
    location.reload();

  } catch (err) {
    console.error('Signup error:', err);
    alert(err.message || 'Erreur lors de la crÃ©ation du compte');
  }
};
 // Filtrage du nom
const nameInput = document.getElementById("signupName");
nameInput.addEventListener("input", function () {
  // Autorise lettres (avec accents), chiffres, et espaces
  this.value = this.value.replace(/[^a-zA-ZÃ€-Ã¿0-9\s]/g, '');
});
window.loginWithEmail=async()=>{
  const e=qs('loginEmail').value.trim(),p=qs('loginPassword').value;
  if(!e||!p)return alert('Entrez e-mail et mdp');
  try{await signInWithEmailAndPassword(auth,e,p);location.reload();}
  catch(err){alert(err.message);}
};

function openHomeTab(evt) {
  openTab(evt, 'home'); // Ouvre la section 'home'
  window.scrollTo({ top: 0, behavior: 'smooth' }); // Remonte en haut avec animation douce
}
function timeSince(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const intervals = {
    annÃ©e: 31536000,
    mois: 2592000,
    semaine: 604800,
    jour: 86400,
    heure: 3600,
    minute: 60,
    seconde: 1,
  };

  for (const [unit, value] of Object.entries(intervals)) {
    const amount = Math.floor(seconds / value);
    if (amount >= 1) {
      return `${amount} ${unit}${amount > 1 ? 's' : ''}`;
    }
  }
  return 'quelques secondes';
}
  document.getElementById('periodSelect').addEventListener('change', (e) => {
  const selectedPeriod = e.target.value;
  loadTotalViewsAndBalance(selectedPeriod);
});

// Chargement initial avec la pÃ©riode "all"
loadTotalViewsAndBalance('all');
  function handleVideoVisibility() {
  const videos = document.querySelectorAll('video[data-video]');

  videos.forEach(video => {
    const rect = video.getBoundingClientRect();
    const inView = rect.top >= 0 && rect.bottom <= window.innerHeight;

    if (inView) {
      video.play().catch(() => {});
    } else {
      video.pause();
    }
  });
}

window.addEventListener('scroll', handleVideoVisibility);
window.addEventListener('resize', handleVideoVisibility);
window.addEventListener('load', handleVideoVisibility);
function linkifyText(text) {
  const urlPattern = /(\b(https?:\/\/)?([\w.-]+\.[a-z]{2,})(\/\S*)?)/gi;
  return text.replace(urlPattern, (match) => {
    let url = match;
    if (!url.startsWith("http")) url = "https://" + url;
    return `<a href="${url}" target="_blank" style="color:#1877f2;text-decoration:underline;">${match}</a>`;
  });
}
// ---------- cache utilisateurs (chargÃ© une seule fois) ----------
function showProfileLink(uid) {
  const link = `https://mboaskill.cm/u/${uid}`;
  const input = document.getElementById('profile-link');
  if (input) input.value = link;

  const box = document.getElementById('profile-link-box');
  if (box) box.style.display = 'block';
}

// Fonction pour copier le lien
function profil_link() {
  const input = document.getElementById('profile-link');
  if (!input) return;
  input.select();
  navigator.clipboard.writeText(input.value).then(() => {
    alert('Lien copiÃ© !');
  });
}

// Attendre que l'utilisateur soit connectÃ©
onAuthStateChanged(auth, (user) => {
  if (user) {
    showProfileLink(user.uid);
  } else {
    console.warn("Utilisateur non connectÃ©");
  }
});

// Attacher l'Ã©vÃ©nement au bouton
document.getElementById('copy-link-btn')?.addEventListener('click', profil_link);
// VÃ©rifie si lâ€™URL est de la forme https://mboaskill.cm/u/<uid>

async function loadSuggestions() {
  const currentUser = auth.currentUser;
  if (!currentUser) return;

  const suggestionsList = document.getElementById('suggestionsList');
  if (!suggestionsList) return;
  suggestionsList.textContent = 'Chargementâ€¦';

  try {
    const followsDoc = await getDoc(doc(db, "follows", currentUser.uid));
    if (!followsDoc.exists()) {
      suggestionsList.textContent = 'Aucun follower pour le moment.';
      return;
    }

    // Ici on rÃ©cupÃ¨re la liste des followers
    const followers = followsDoc.data().list || {}; // ou subcollection si c'est une subcollection
    const followerIds = Object.keys(followers);

    if (followerIds.length === 0) {
      suggestionsList.textContent = 'Aucun follower pour le moment.';
      return;
    }

    const suggestions = [];
    for (const uid of followerIds) {
      const userDoc = await getDoc(doc(db, "users", uid));
      if (userDoc.exists()) {
        suggestions.push({ uid, ...userDoc.data() });
      }
    }

    function updateSuggestions() {
      for (let i = suggestions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [suggestions[i], suggestions[j]] = [suggestions[j], suggestions[i]];
      }

      suggestionsList.innerHTML = '<hr>';
      suggestions.forEach(user => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.style = 'display:flex;align-items:center;gap:10px;margin:5px 0';

        const img = document.createElement('img');
        img.src = user.photo || 'https://via.placeholder.com/40';
        img.style = 'width:40px;height:40px;border-radius:50%';

        const name = document.createElement('span');
        name.textContent = user.name || user.email || 'Utilisateur';

        const btn = renderFollowBtn(user.uid);

        div.append(img, name);
        if (btn) div.appendChild(btn);
        suggestionsList.appendChild(div);
      });
    }

    updateSuggestions();
    clearInterval(suggestionInterval);
    suggestionInterval = setInterval(updateSuggestions, 60000);

  } catch (err) {
    console.error(err);
    suggestionsList.textContent = 'Erreur lors du chargement des followers.';
  }
}

window.certifyUser = async function () {
  const userId = currentUser?.uid;
  if (!userId) return alert("Utilisateur non connectÃ©");

  const walletRef = doc(db, 'wallets', userId);  // <-- collection wallets
  const verifiedRef = doc(db, 'verified', userId);

  try {
    const snap = await getDoc(walletRef);
    const balance = snap.exists() ? snap.data().balance || 0 : 0;

    if (balance >= 18000) {
      // DÃ©duction de 18 000 Fcfa
      await updateDoc(walletRef, {
        balance: balance - 18000
      });

      // Mise Ã  jour du statut certifiÃ©
      await setDoc(verifiedRef, {
        status: true
      });

      // Cacher le bouton aprÃ¨s certification
      const btn = document.getElementById("certify-btn");
      if (btn) btn.style.display = "none";

      alert("âœ… Vous Ãªtes maintenant certifiÃ© !");
    } else {
      // Ne pas dÃ©duire, mettre status Ã  false
      await setDoc(verifiedRef, {
        status: false
      });

      alert("ğŸ’¸ Solde insuffisant. Le montant requis est de 18 000 Fcfa.");
    }
  } catch (error) {
    console.error("Erreur de certification :", error);
    alert("âŒ Une erreur est survenue. Veuillez rÃ©essayer.");
  }
};


window.publishMusic = async function () {
    const nom = document.getElementById('nom').value.trim();
    const titre = document.getElementById('titre').value.trim();
    const audioFile = document.getElementById('audioFile').files[0];
    const statusMsg = document.getElementById('statusMsg');
    statusMsg.textContent = '';

    if (!currentUser) {
      return alert("Vous devez Ãªtre connectÃ©.");
    }

    if (!nom || !titre || !audioFile) {
      return alert("Tous les champs sont requis.");
    }

    try {
      // VÃ©rification du wallet utilisateur
      const walletRef = doc(db, 'wallets', currentUser.uid);
      const walletSnap = await getDoc(walletRef);

      if (!walletSnap.exists()) {
        return alert("Aucun portefeuille trouvÃ©.");
      }

      const walletData = walletSnap.data();
      const currentBalance = typeof walletData.balance === 'number' ? walletData.balance : 0;

      if (currentBalance < 1500) {
        return alert("Solde insuffisant (minimum requis : 1500 FCFA).");
      }

      // âœ… DÃ©duire 1500
      await updateDoc(walletRef, {
        balance: currentBalance - 1500
      });

      statusMsg.textContent = "â³ TÃ©lÃ©chargement du fichier audio...";

      // Upload sur Supabase Storage
      const filePath = `musics/${Date.now()}_${audioFile.name}`;
      const { data, error } = await supabaseClient.storage
        .from("media") // bucket "media" oÃ¹ tu mets aussi les musiques
        .upload(filePath, audioFile);

      if (error) {
        console.error("Erreur upload Supabase:", error);
        return alert("Ã‰chec upload audio.");
      }

      // RÃ©cupÃ©rer URL publique
      const { data: urlData } = supabaseClient.storage.from("media").getPublicUrl(filePath);
      const audioUrl = urlData.publicUrl;

      statusMsg.textContent = "â³ Publication en cours...";

      // Sauvegarde dans Firestore
      await addDoc(collection(db, 'musfeed'), {
        userId: currentUser.uid,
        nom,
        titre,
        audioUrl,
        createdAt: serverTimestamp()
      });

      statusMsg.textContent = "âœ… Musique publiÃ©e avec succÃ¨s.";
      document.getElementById('nom').value = '';
      document.getElementById('titre').value = '';
      document.getElementById('audioFile').value = '';
    } catch (err) {
      console.error("Erreur lors de la publication :", err);
      statusMsg.textContent = "âŒ Erreur lors de la publication.";
    }
  }


// ğŸ”¹ Rend le feed musique (triÃ© par nombre dâ€™Ã©coutes)
async function renderMusicFeed() {
  const container = document.getElementById('musicFeed');
  if (!container) {
    console.error("Container musicFeed introuvable");
    return;
  }

  container.textContent = 'Chargementâ€¦';

  try {
    console.log("ğŸµ renderMusicFeed appelÃ©e");
    console.log("ğŸµ currentUser:", currentUser);

    // ğŸ”¹ On trie d'abord par views (desc) puis createdAt (desc) pour Ã©galitÃ©s
    const q = query(
      collection(db, 'musfeed'),
      orderBy('views', 'desc'),
      orderBy('createdAt', 'desc')
    );

    const snapshot = await getDocs(q);
    console.log("ğŸµ Nombre de documents musfeed:", snapshot.size);

    if (snapshot.empty) {
      container.textContent = 'Aucune musique disponible.';
      return;
    }

    container.innerHTML = '';

    snapshot.docs.forEach(docSnap => {
      const d = docSnap.data();
      const musicId = docSnap.id;

      const createdAt = d.createdAt?.toDate?.() || new Date();
      const now = new Date();
      const ageInDays = (now - createdAt) / (1000 * 60 * 60 * 24);

      if (ageInDays > 30) return; // ğŸ”¹ Ignore les musiques expirÃ©es

      // === Carte musique ===
      const div = document.createElement('div');
      div.className = "post";
      div.style.cssText = `
        border-radius:10px;
        padding:1rem;
        margin-bottom:1rem;
        background:#fff;
        box-shadow:0 2px 6px rgba(0,0,0,0.1);
      `;

      div.innerHTML = `
        <div style="display:flex;align-items:center;margin-bottom:10px;cursor:pointer;" class="music-header">
          <i class="fas fa-music" style="color: gold;margin-right:10px;font-size:1.2rem;"></i>
          <strong class="music-title">${d.nom || "Artiste inconnu"} - ${d.titre || "Titre inconnu"}</strong>
        </div>

        ${d.audioUrl ? 
          `<audio controls src="${d.audioUrl}" style="width:100%;margin-top:8px;"></audio>` 
          : '<p style="color:red;">Audio non disponible</p>'}

        <div style="margin-top:10px;font-size:14px;color:#555;display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;align-items:center;">
            <i class="fa-solid fa-headphone" style="margin-right:6px;"></i>
            <span id="views_${musicId}">${d.views || 0}</span> Ã©coutes
          </div>
          <button class="share-btn" style="background:gold;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">
            <i class="fas fa-share"></i> Partager
          </button>
        </div>
      `;

      // ğŸ”¹ Clic sur le header â†’ ouvre le dÃ©tail musique
      div.querySelector('.music-header').addEventListener('click', () => openMusicById(musicId));

      // ğŸ”¹ Bouton Partage
      div.querySelector('.share-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const link = `${window.location.origin}/music/${musicId}`;
        navigator.clipboard.writeText(link).then(() => alert("âœ… Lien copiÃ© : " + link));
      });

      // ğŸ”¹ Gestion Ã©coute payante
      const audio = div.querySelector('audio');
      if (audio) {
        const viewsEl = div.querySelector(`#views_${musicId}`);
        audio.addEventListener('play', async () => {
          if (!currentUser) {
            audio.pause();
            alert("ğŸ”’ Connectez-vous pour Ã©couter cette musique");
            return;
          }

          const viewDocRef = doc(db, 'musfeed', musicId, 'viewsByUser', currentUser.uid);
          const viewDocSnap = await getDoc(viewDocRef);

          // Si dÃ©jÃ  Ã©coutÃ©e ou si c'est ton propre morceau, ne facture pas
          if (viewDocSnap.exists() || currentUser.uid === d.userId) return;

          const walletRef = doc(db, 'wallets', currentUser.uid);
          const walletSnap = await getDoc(walletRef);
          const balance = walletSnap.exists() ? walletSnap.data().balance || 0 : 0;

          if (balance < 55) {
            audio.pause();
            alert("ğŸ’¸ Solde insuffisant (55 FCFA requis).");
            return;
          }

          try {
            // DÃ©bit Ã©coute + crÃ©dit artiste
            await updateDoc(walletRef, { balance: increment(-55) });
            await setDoc(viewDocRef, { userId: currentUser.uid, musicId, playedAt: new Date() });
            await updateDoc(doc(db, 'musfeed', musicId), { views: increment(1) });
            const artistSoldeRef = doc(db, 'soldes', d.userId);
            await setDoc(artistSoldeRef, { gainVues: increment(35), updatedAt: new Date() }, { merge: true });

            // Met Ã  jour compteur local
            viewsEl.textContent = (parseInt(viewsEl.textContent) || 0) + 1;
          } catch (err) {
            console.error("Erreur lors de l'Ã©coute:", err);
            audio.pause();
            alert("âŒ Erreur lors de la lecture");
          }
        });
      }

      container.appendChild(div);
    });

    // Si aucune musique rÃ©cente
    if (container.children.length === 0)
      container.textContent = 'Aucune musique rÃ©cente (30 jours max).';

  } catch (err) {
    console.error("Erreur renderMusicFeed:", err);
    container.textContent = 'Erreur de chargement des musiques.';
  }
}

// ğŸ”¹ Gestion de l'authentification
onAuthStateChanged(auth, async (user) => {
  currentUser = user;

  if (user) {
    try {
      await loadWallet();
      await loadFollowing();
      await loadLikedPosts();
      await renderFeed();
      await renderMyFeed();
      await renderVideoFeed();
      await renderBoostFeed();
      await renderMusicFeed(); // ğŸ¯ rend le feed musique
      await loadTotalViewsAndBalance();
    } catch (err) {
      console.error("Erreur chargement donnÃ©es utilisateur:", err);
    }
  } else {
    likedPosts.clear();
    followingIds.clear();
    ['feed','myFeed','videoFeedContent','videoFeedContentBoost','userFeedContent','musicFeed'].forEach(id => {
      const el = qs(id);
      if (el) el.innerHTML = '';
    });
    qs('totalViewsCount').textContent = '';
    qs('currentBalance').textContent = 'Solde actuel: 0 FCFA';
  }
});

// ğŸµ Fonction pour ouvrir une musique par son ID (version amÃ©liorÃ©e)
window.openMusicById = async function (musicId) {
  try {
    console.log("Tentative d'ouverture musique ID:", musicId);

    // 1. OUVERTURE DE L'ONGLET MUSIC PLAYER
    document.querySelectorAll('.tabcontent').forEach(t => t.classList.remove('active'));
    const musicPlayerTab = document.getElementById('musicPlayer');
    if (musicPlayerTab) {
      musicPlayerTab.classList.add('active');
    } else {
      console.error("âŒ Onglet musicPlayer introuvable");
      return;
    }

    // 2. METTRE Ã€ JOUR L'ICÃ”NE ACTIVE DANS LE HEADER
    document.querySelectorAll('header .icons i').forEach(icon => {
      icon.classList.remove('active');
    });
    const musicIcon = document.querySelector('.tablinks[onclick*="music"]');
    if (musicIcon) {
      musicIcon.classList.add('active');
    }

    // 3. CHARGEMENT DES DONNÃ‰ES DE LA MUSIQUE
    const docRef = doc(db, "musfeed", musicId);
    const snap = await getDoc(docRef);

    if (!snap.exists()) {
      alert("âŒ Musique introuvable ou supprimÃ©e");
      return;
    }

    const d = snap.data();
    const c = document.getElementById("openMusicById");

    if (!c) {
      console.error("Element openMusicById introuvable");
      return;
    }

    c.innerHTML = "";

    // 4. CRÃ‰ATION DE L'INTERFACE MUSIQUE
    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <i class="fas fa-music" style="color: gold; margin-right: 10px; font-size: 1.2rem;"></i>
        <strong>${d.nom || "Artiste inconnu"} - ${d.titre || "Titre inconnu"}</strong>
      </div>
      ${d.audioUrl ? 
        `<audio controls src="${d.audioUrl}" style="width: 100%; margin-top: 8px;"></audio>` : 
        '<p style="color:red;">Audio non disponible</p>'
      }
      <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #555;">
        <div style="display:flex;align-items:center;">
          <i class="fa-solid fa-headphone" style="margin-right:6px;"></i>
          <span id="views_${musicId}">${d.views || 0}</span> ets
        </div>
        <button class="share-btn" style="background:gold;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">
          <i class="fas fa-share"></i> Partager
        </button>
      </div>
    `;

    // Gestion du partage
    div.querySelector(".share-btn").addEventListener("click", () => {
      const link = `${window.location.origin}/music/${musicId}`;
      navigator.clipboard.writeText(link).then(() => alert("âœ… Lien copiÃ© : " + link));
    });

    // Gestion de la lecture audio avec paiement
    const audio = div.querySelector("audio");
    const viewsEl = div.querySelector(`#views_${musicId}`);

    if (audio) {
      audio.addEventListener("play", async () => {
        if (!currentUser) {
          audio.pause();
          alert("ğŸ”’ Connectez-vous pour Ã©couter cette musique");
          // Rediriger vers la connexion
          const connectIcon = document.querySelector('.tablinks[onclick*="conect"]');
          if (connectIcon) {
            openTab({ currentTarget: connectIcon }, "conect");
          }
          return;
        }

        const viewDocRef = doc(db, "musfeed", musicId, "viewsByUser", currentUser.uid);
        const viewDocSnap = await getDoc(viewDocRef);
        
        // VÃ©rifier si l'utilisateur a dÃ©jÃ  Ã©coutÃ© ou est le propriÃ©taire
        if (viewDocSnap.exists() || currentUser.uid === d.userId) return;

        const walletRef = doc(db, "wallets", currentUser.uid);
        const walletSnap = await getDoc(walletRef);
        const balance = walletSnap.exists() ? walletSnap.data().balance || 0 : 0;

        if (balance < 55) {
          audio.pause();
          alert("ğŸ’¸ Solde insuffisant (55 FCFA requis)");
          return;
        }

        try {
          // DÃ©biter l'auditeur
          await updateDoc(walletRef, { balance: increment(-55) });
          
          // Marquer comme Ã©coutÃ©
          await setDoc(viewDocRef, { 
            userId: currentUser.uid, 
            musicId, 
            playedAt: new Date() 
          });
          
          // IncrÃ©menter les vues
          await updateDoc(doc(db, "musfeed", musicId), { 
            views: increment(1), 
            totalviewcontent: increment(250) 
          });
          
          // Payer l'artiste
          await setDoc(
            doc(db, "soldes", d.userId), 
            { 
              gainVues: increment(20), 
              updatedAt: new Date() 
            }, 
            { merge: true }
          );
          
          // Mettre Ã  jour l'affichage
          viewsEl.textContent = (parseInt(viewsEl.textContent) || 0) + 1;
          
        } catch (err) {
          console.error("Erreur lors de l'Ã©coute:", err);
          audio.pause();
          alert("âŒ Erreur lors de la lecture");
        }
      });
    }

    c.appendChild(div);
    console.log("âœ… Musique chargÃ©e avec succÃ¨s");

  } catch (err) {
    console.error("âŒ Erreur openMusicById:", err);
    alert("âŒ Erreur lors du chargement de la musique");
  }
};

window.addEventListener('DOMContentLoaded', () => {
  const path = window.location.pathname;

  // CrÃ©ation d'une fonction globale pour ouvrir une section
  window.openSection = function(tabName) {
    const tryOpen = () => {
      const el = document.querySelector(`.tablinks[onclick*="${tabName}"]`);
      if (el && typeof window.openTab === 'function') {
        openTab({ currentTarget: el }, tabName);
        return true;
      }
      return false;
    };

    if (!tryOpen()) {
      const check = setInterval(() => {
        if (tryOpen()) clearInterval(check);
      }, 200);
    }
  };

  // Gestion de la route /u/:uid
  const matchUser = path.match(/^\/u\/([^\/]+)/);
  if (matchUser && matchUser[1]) {
    const uid = matchUser[1];
    const tryUser = () => {
      if (typeof window.openUserFeed === 'function') {
        window.openUserFeed(uid);
        return true;
      }
      return false;
    };
    if (!tryUser()) {
      const check = setInterval(() => {
        if (tryUser()) clearInterval(check);
      }, 200);
    }
  } 

  // Gestion de la route /music/:mid
  const matchMusic = path.match(/^\/music\/([^\/]+)/);
  if (matchMusic && matchMusic[1]) {
    const mid = matchMusic[1];
    const tryMusic = () => {
      if (typeof window.openMusicById === 'function') {
        // Active lâ€™onglet musicPlayer
        const el = document.querySelector('.tablinks[onclick*="music"]');
        if (el) {
          openTab({ currentTarget: el }, "musicPlayer");
          openMusicById(mid);
          return true;
        }
      }
      return false;
    };
    if (!tryMusic()) {
      const check = setInterval(() => {
        if (tryMusic()) clearInterval(check);
      }, 200);
    }
  }

  // Gestion des routes avec hash (#)
  if (location.hash) {
    const hash = location.hash.substring(1);
    switch (hash) {
      case 'music':
        window.openSection('music');
        break;
      case 'image':
        window.openSection('videoFeed');
        break;
      case 'feedme':
        window.openSection('feedme');
        break;
    }
  }

  // Nettoyer lâ€™URL visuellement (âš ï¸ garde le hash si prÃ©sent)
  if (!location.hash && !path.startsWith("/music/") && !path.startsWith("/u/")) {
    history.replaceState({}, '', '/');
  }
});

let suggestionInterval;

document.addEventListener("DOMContentLoaded", () => {
  loadSuggestions();
});

// Fonction pour afficher uniquement les musiques de l'utilisateur connectÃ©
async function renderMyMusic() {
  const c = document.getElementById("myMusicList");
  if (!c) {
    console.error("âŒ Ã‰lÃ©ment #myMusicList introuvable dans le DOM.");
    return;
  }

  c.textContent = "Chargementâ€¦";

  if (!currentUser) {
    c.textContent = "Connectez-vous pour voir vos musiques.";
    return;
  }

  const q = query(
    collection(db, "musfeed"),
    where("userId", "==", currentUser.uid),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, snap => {
    c.innerHTML = "";

    if (snap.empty) {
      c.textContent = "Tu nâ€™as publiÃ© aucune musique.";
    } else {
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;
        c.appendChild(myMusicCard(id, d));
      });
    }
  });
}

// Template dâ€™une musique avec lien partageable
function myMusicCard(id, d) {
  const div = document.createElement("div");
  div.className = "post";

  const musicLink = `https://mboaskill.cm/music/${id}`;

  div.innerHTML = `
    <p><strong>${d.nom}</strong> - ${d.titre}</p>
    <audio controls src="${d.audioUrl}" style="width:100%;"></audio>
    <div style="margin-top:8px;">
      <input type="text" value="${musicLink}" readonly style="width:80%">
      <button onclick="navigator.clipboard.writeText('${musicLink}')">Copier</button>
    </div>
    <small style="color:#888">ets : ${d.views || 0}</small>
  `;

  return div;
}

// âš¡ ExÃ©cution seulement aprÃ¨s que le DOM et Firebase soient prÃªts
document.addEventListener("DOMContentLoaded", () => {
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      console.log("âœ… Utilisateur connectÃ© :", user.uid);
      renderMyMusic();
    } else {
      console.log("âŒ Aucun utilisateur connectÃ©");
      const c = document.getElementById("myMusicList");
      if (c) c.textContent = "Connectez-vous pour voir vos musiques.";
    }
  });
});
  const boutonLundi = document.getElementById('bouton-lundi');
    const maintenant = new Date();
    const jour = maintenant.getDay(); // 0 = dimanche, 1 = lundi, ..., 6 = samedi

    if (jour === 4) { // Si c'est lundi
        boutonLundi.style.display = 'block'; // Afficher le bouton
    }
else {
  const sms = document.getElementById('s');
  sms.innerText = 'Revenez lundi pour partager votre musique';
  }
window.sendResetLink = async () => {
  const email = document.getElementById('resetEmail').value.trim();
  if (!email) return alert("Veuillez entrer votre email");

  try {
    await sendPasswordResetEmail(auth, email);
    alert("ğŸ“© Un lien de rÃ©initialisation a Ã©tÃ© envoyÃ© Ã  votre email");
  } catch (err) {
    console.error("Erreur:", err);
    alert("âŒ " + err.message);
  }
};
// === Modifier le nom de l'utilisateur connectÃ© (robuste) ===
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById("saveNameBtn");
  if (!btn) {
    console.warn("saveNameBtn introuvable â€” vÃ©rifie que la section #modifie-pro est dans le DOM");
    return;
  }

  // charger la valeur quand on ouvre la section (tu peux appeler loadModifyName() depuis openTab)
  window.loadModifyName = async () => {
    if (!currentUser) {
      alert("Vous devez Ãªtre connectÃ©.");
      return;
    }
    const input = document.getElementById("newName");
    const status = document.getElementById("nameStatus");
    if (!input || !status) return console.warn("Elements newName/nameStatus introuvables");

    status.textContent = "Chargement...";
    try {
      const snap = await getDoc(doc(db, "users", currentUser.uid));
      if (snap.exists()) {
        input.value = snap.data().name || "";
        status.textContent = "Nom actuel chargÃ©.";
      } else {
        input.value = "";
        status.textContent = "Aucun nom enregistrÃ©.";
      }
    } catch (e) {
      console.error(e);
      status.textContent = "Erreur lors du chargement.";
    }
  };

  // handler d'enregistrement
  btn.addEventListener('click', async () => {
    if (!currentUser) {
      alert("Vous devez Ãªtre connectÃ©.");
      return;
    }

    const input = document.getElementById("newName");
    const status = document.getElementById("nameStatus");
    if (!input || !status) return console.warn("Elements newName/nameStatus introuvables");

    const newName = input.value.trim();
    if (newName.length < 3) {
      status.textContent = "Le nom est trop court.";
      return;
    }

    status.textContent = "Sauvegarde en cours...";

    try {
      // 1) Mettre Ã  jour users/{uid} (crÃ©era le doc si nÃ©cessaire grÃ¢ce Ã  merge:true)
      await setDoc(doc(db, "users", currentUser.uid), { name: newName }, { merge: true });

      // 2) Mettre Ã  jour Firebase Auth displayName
      //    Utilise auth.currentUser (sÃ©curisÃ©) si disponible.
      const authUser = auth.currentUser || currentUser;
      if (authUser) {
        await updateProfile(authUser, { displayName: newName });
      }

      // 3) Mettre Ã  jour les posts existants oÃ¹ userId == currentUser.uid
      //    (sinon tes anciennes publications continueront d'afficher l'ancien userName)
      try {
        const q = query(collection(db, "posts"), where("userId", "==", currentUser.uid));
        const snap = await getDocs(q);
        if (!snap.empty) {
          // Mise Ã  jour en parallÃ¨le (attention aux quotas si beaucoup de posts)
          await Promise.all(snap.docs.map(d => updateDoc(doc(db, "posts", d.id), { userName: newName }).catch(err => {
            console.warn("Erreur update post", d.id, err);
          })));
        }
      } catch (errPosts) {
        console.warn("Erreur lors de la mise Ã  jour des posts :", errPosts);
      }

      // 4) Mettre Ã  jour l'UI locale immÃ©diatement
      status.textContent = "âœ”ï¸ Nom mis Ã  jour avec succÃ¨s !";

      // Ã©lÃ©ments d'UI que tu utilises ailleurs (met Ã  jour si prÃ©sents)
      const authStatusEl = document.getElementById('authStatus');
      const accountStatusEl = document.getElementById('accountStatus');
      const accountStatusFeedEl = document.getElementById('accountStatusFeed');
      if (authStatusEl) authStatusEl.textContent = ` ${newName || currentUser.email}`;
      if (accountStatusEl) accountStatusEl.textContent = `â€¢ ${newName || currentUser.email}`;
      if (accountStatusFeedEl) accountStatusFeedEl.textContent = accountStatusEl ? accountStatusEl.textContent : `â€¢ ${newName || currentUser.email}`;

      // Recharge la vue profil (si tu veux recharger les posts)
      if (typeof openUserFeed === "function") openUserFeed(currentUser.uid);
      // Recharge le feed de l'utilisateur connectÃ©
      if (typeof renderMyFeed === "function") renderMyFeed();

    } catch (e) {
      console.error("Erreur lors de la sauvegarde du nom :", e);
      status.textContent = "âŒ Erreur lors de la sauvegarde.";
    }
  }); // btn click
});
</script>
</body>
</html>
