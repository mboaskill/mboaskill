<!DOCTYPE html><html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mboa Skills</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
    }
    header {
      background-color: #fff;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      z-index: 9999;
    }
    header i {
      font-size: 1.4rem;
      color: #888;
      cursor: pointer;
    }
    header i.selected {
      color: #1877f2;
    }
    .tabcontent {
      display: none;
      padding: 6rem 1rem 1rem;
    }
    .tabcontent.active {
      display: block;
    }
    input, textarea, button, select {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      background-color: #1877f2;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background-color: #145ec1;
    }
    .post {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
      width: 100%;
    }
    .post-header {
      display: flex;
      align-items: center;
      width: 100%;
    }
    .post-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }
    .post-content {
      margin-top: 10px;
    }
    .post video, .post .text-bg {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }
    .text-bg {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #333;
      color: white;
      font-weight: bold;
      text-align: center;
      word-wrap: break-word;
      white-space: pre-wrap;
      border-radius: 10px;
      max-width: 90%;
    }
    .post-actions {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .post-actions i {
      cursor: pointer;
    }
    .like.liked {
      color: #1877f2;
    }
    .post-actions button {
      background: none;
      border: none;
      color: #1877f2;
      cursor: pointer;
      font-weight: bold;
      padding: 0;
      margin-left: 10px;
    }
    textarea {
      border-radius: 15px;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <header>
    <i class="fas fa-home tablinks selected" onclick="openTab(event, 'home')"></i>
    <i class="fas fa-video tablinks" onclick="openTab(event, 'video')"></i>
    <i class="fas fa-user-friends tablinks" onclick="openTab(event, 'feedme')"></i>
    <i class="fas fa-plus tablinks" onclick="openTab(event, 'post')"></i>
    <i class="fas fa-user tablinks" onclick="openTab(event, 'account')"></i>
  </header>  <section id="home" class="tabcontent active">
    <div id="feed"></div>
  </section>  <section id="video" class="tabcontent">
    <h3>Booster une publication</h3>
    <select id="selectPost"></select>
    <select id="boostViews">
      <option value="1000">1000 vues</option>
      <option value="2000">2000 vues</option>
      <option value="5000">5000 vues</option>
    </select>
    <button onclick="boostPost()">Booster</button>
  </section>  <section id="post" class="tabcontent">
    <h3>Créer une publication</h3>
    <textarea id="postText" placeholder="Exprimez-vous..."></textarea>
    <input type="color" id="bgColor" value="#1877f2" />
    <hr>
    <input type="text" id="videoTitle" placeholder="Titre de la vidéo" />
    <input type="file" id="videoFile" accept="video/*" />
    <button onclick="publishPost()">Publier</button>
    <p id="status"></p>
  </section>  <section id="account" class="tabcontent">
    <h3>Connexion</h3>
    <button onclick="signInWithGoogle()"><i class="fab fa-google"></i> Connexion/inscription Google</button>
    <hr>
    <button onclick="signOutUser()">Se déconnecter</button>
    <p id="authStatus"></p>
  </section>   <section id="feedme" class="tabcontent">
    <h3>Mon fil</h3>
    <div id="myFeed"></div>
  </section>  
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, 
  GoogleAuthProvider, signInWithPopup 
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import { 
  getFirestore, collection, addDoc, onSnapshot, query, orderBy, 
  updateDoc, doc, increment, getDocs, where, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyClSjd2LrIQpaJoVWO32vFRx7I9cvmDgBo",
  authDomain: "mboa-ec602.firebaseapp.com",
  projectId: "mboa-ec602",
  storageBucket: "mboa-ec602.appspot.com",
  messagingSenderId: "498505132403",
  appId: "1:498505132403:web:eb46547745f8d1a77b3d06"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let likedPosts = new Set();
const provider = new GoogleAuthProvider();

onAuthStateChanged(auth, (user) => {
  currentUser = user;

  if(user) {
    document.getElementById("authStatus").innerText = `Connecté en tant que ${user.displayName || user.email}`;
    loadLikedPosts();
    loadBoostablePosts();
  } else {
    likedPosts.clear();
    document.getElementById("authStatus").innerText = "";
    document.getElementById("selectPost").innerHTML = "";
  }

  renderFeed();
  renderMyFeed();
});

window.signInWithGoogle = async function () {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    document.getElementById("authStatus").innerText = `Connecté en tant que ${user.displayName || user.email}`;
  } catch (error) {
    console.error("Erreur Google Auth:", error);
    document.getElementById("authStatus").innerText = error.message;
  }
};

window.signOutUser = async function () {
  await signOut(auth);
  document.getElementById("authStatus").innerText = "Déconnecté.";
  likedPosts.clear();
  document.getElementById("selectPost").innerHTML = "";
  renderFeed();
  renderMyFeed();
};

window.publishPost = async function () {
  if (!currentUser) return alert("Connectez-vous pour publier.");

  const text = document.getElementById("postText").value.trim();
  const bgColor = document.getElementById("bgColor").value;
  const video = document.getElementById("videoFile").files[0];
  const videoTitle = document.getElementById("videoTitle").value.trim();

  if (!text && !video) return alert("Ajoutez un texte ou une vidéo.");

  document.getElementById("status").innerText = "Publication en cours...";

  let videoUrl = null;

  const publier = async () => {
    await addDoc(collection(db, "posts"), {
      userId: currentUser.uid,
      userName: currentUser.displayName || currentUser.email,
      text,
      bgColor,
      videoUrl,
      videoTitle,
      views: 0,
      likes: 0,
      createdAt: serverTimestamp(),
      boosted: 0
    });

    document.getElementById("postText").value = "";
    document.getElementById("videoFile").value = "";
    document.getElementById("videoTitle").value = "";
    document.getElementById("status").innerText = "Publication créée avec succès.";
  };

  if (video) {
    const refV = ref(storage, `videos/${Date.now()}_${video.name}`);
    const uploadTask = uploadBytesResumable(refV, video);

    uploadTask.on(
      "state_changed",
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        document.getElementById("status").innerText = `Téléchargement : ${Math.floor(progress)}%`;
      },
      (error) => {
        console.error("Erreur upload :", error);
        alert("Erreur pendant l'envoi de la vidéo.");
        document.getElementById("status").innerText = "";
      },
      async () => {
        videoUrl = await getDownloadURL(uploadTask.snapshot.ref);
        await publier();
      }
    );
  } else {
    await publier();
  }
};

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function renderFeed() {
  const feed = document.getElementById("feed");
  if (window.unsubscribePosts) window.unsubscribePosts();

  const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
  window.unsubscribePosts = onSnapshot(q, (snapshot) => {
    feed.innerHTML = "";
    snapshot.forEach(docSnap => {
      const post = docSnap.data();
      const postId = docSnap.id;
      const isLiked = likedPosts.has(postId);

      const postDiv = document.createElement("div");
      postDiv.className = "post";

      let html = `
        <div class="post-header">
          <img src="https://via.placeholder.com/40" alt="Avatar" />
          <strong>${escapeHtml(post.userName || "Anonyme")}</strong>
        </div>
        <div class="post-content">
      `;
      if(post.text) {
        html += `<div class="text-bg" style="background:${post.bgColor || '#1877f2'}">${escapeHtml(post.text)}</div>`;
      }
      if(post.videoTitle) {
        html += `<h4>${escapeHtml(post.videoTitle)}</h4>`;
      }
      if(post.videoUrl) {
        html += `<video src="${post.videoUrl}" controls muted onplay="recordView('${postId}')"></video>`;
      }
      html += `</div>
        <div class="post-actions">
          <i class="fa fa-thumbs-up like${isLiked ? ' liked' : ''}" onclick="toggleLike('${postId}')"></i>
          <span id="likes-${postId}">${post.likes || 0} j'aime</span>
          <span>${post.views || 0} vues</span>
      `;
      html += `</div>`;

      postDiv.innerHTML = html;
      feed.appendChild(postDiv);
    });
  });
}

function renderMyFeed() {
  const container = document.getElementById("myFeed");
  if (!currentUser) {
    container.innerHTML = "<p>Veuillez vous connecter pour voir vos publications.</p>";
    return;
  }

  const q = query(
    collection(db, "posts"),
    where("userId", "==", currentUser.uid),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snapshot) => {
    container.innerHTML = "";
    snapshot.forEach(docSnap => {
      const post = docSnap.data();
      const postId = docSnap.id;
      const isLiked = likedPosts.has(postId);

      const div = document.createElement("div");
      div.className = "post";

      let html = `
        <div class="post-header">
          <img src="https://via.placeholder.com/40" alt="Avatar" />
          <strong>${escapeHtml(post.userName || "Moi")}</strong>
        </div>
        <div class="post-content">
      `;
      if (post.text) {
        html += `<div class="text-bg" style="background:${post.bgColor || '#1877f2'}">${escapeHtml(post.text)}</div>`;
      }
      if (post.videoTitle) {
        html += `<h4>${escapeHtml(post.videoTitle)}</h4>`;
      }
      if (post.videoUrl) {
        html += `<video src="${post.videoUrl}" controls muted onplay="recordView('${postId}')"></video>`;
      }
      html += `</div>
        <div class="post-actions">
          <i class="fa fa-thumbs-up like${isLiked ? ' liked' : ''}" onclick="toggleLike('${postId}')"></i>
          <span id="likes-${postId}">${post.likes || 0} j'aime</span>
          <span>${post.views || 0} vues</span>
        </div>
      `;

      div.innerHTML = html;
      container.appendChild(div);
    });
  });
}

window.recordView = async function (postId) {
  try {
    const refPost = doc(db, "posts", postId);
    await updateDoc(refPost, { views: increment(1) });
  } catch(e) {
    console.error("Erreur recordView:", e);
  }
};

async function loadLikedPosts() {
  if (!currentUser) return;
  likedPosts.clear();
  try {
    const postsSnapshot = await getDocs(collection(db, "posts"));
    for(const postDoc of postsSnapshot.docs) {
      const likesSubcol = collection(db, `posts/${postDoc.id}/likes`);
      const userLikeQuery = query(likesSubcol, where("user", "==", currentUser.uid));
      const userLikesSnapshot = await getDocs(userLikeQuery);
      if(!userLikesSnapshot.empty) {
        likedPosts.add(postDoc.id);
      }
    }
    renderFeed();
    renderMyFeed();
  } catch (e) {
    console.error("Erreur loadLikedPosts:", e);
  }
}

window.toggleLike = async function (postId) {
  if (!currentUser) return alert("Connectez-vous pour liker.");

  try {
    const likeRef = doc(db, "posts", postId);
    const likesSubcol = collection(db, `posts/${postId}/likes`);
    const userLikeQuery = query(likesSubcol, where("user", "==", currentUser.uid));
    const userLikesSnapshot = await getDocs(userLikeQuery);

    if (userLikesSnapshot.empty) {
      await addDoc(likesSubcol, { user: currentUser.uid });
      await updateDoc(likeRef, { likes: increment(1) });
      likedPosts.add(postId);
    } else {
      for (const d of userLikesSnapshot.docs) {
        await d.ref.delete();
      }
      await updateDoc(likeRef, { likes: increment(-1) });
      likedPosts.delete(postId);
    }
    renderFeed();
    renderMyFeed();
  } catch (error) {
    console.error("Erreur toggleLike:", error);
  }
};

window.boostPost = async function () {
  if (!currentUser) return alert("Connectez-vous pour booster une publication.");

  const postId = document.getElementById("selectPost").value;
  const viewsToAdd = parseInt(document.getElementById("boostViews").value);
  if (!postId) return alert("Veuillez sélectionner une publication.");

  try {
    const refPost = doc(db, "posts", postId);
    await updateDoc(refPost, { views: increment(viewsToAdd), boosted: increment(viewsToAdd) });
    alert("Publication boostée avec succès.");
  } catch(e) {
    alert("Erreur lors du boost : " + e.message);
  }
};

async function loadBoostablePosts() {
  if (!currentUser) return;
  const now = new Date();
  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const select = document.getElementById("selectPost");
  select.innerHTML = "";

  try {
    const postsSnapshot = await getDocs(query(
      collection(db, "posts"),
      where("userId", "==", currentUser.uid),
      orderBy("createdAt", "desc")
    ));

    postsSnapshot.forEach(docSnap => {
      const post = docSnap.data();
      const created = post.createdAt?.toDate?.();

      if (created && created >= sevenDaysAgo) {
        const option = document.createElement("option");
        option.value = docSnap.id;
        if(post.text) option.textContent = post.text.length > 50 ? post.text.slice(0, 47) + "..." : post.text;
        else option.textContent = post.videoTitle || "(vidéo)";
        select.appendChild(option);
      }
    });
  } catch (e) {
    console.error("Erreur loadBoostablePosts:", e);
  }
}    
 window.openTab = function(evt, tabName) {
  // Cacher tous les contenus
  document.querySelectorAll(".tabcontent").forEach(tab => {
    tab.classList.remove("active");
  });

  // Désélectionner toutes les icônes
  document.querySelectorAll(".tablinks").forEach(icon => {
    icon.classList.remove("selected");
  });

  // Afficher le contenu sélectionné
  document.getElementById(tabName).classList.add("active");

  // Mettre l'icône active en surbrillance
  if (evt && evt.currentTarget) {
    evt.currentTarget.classList.add("selected");
  }
};
  </script>
  </body>
</html>